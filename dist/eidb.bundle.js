var t={d:(e,a)=>{for(var r in a)t.o(a,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:a[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{Z:()=>vt}),console.log,console.warn,console.error;const a=class{#t(){}static new_lock(){var t;return[new Promise(((e,a)=>{t=e})),t]}static async stay_idle(t){var e=new Promise(((e,a)=>{setTimeout((()=>{e()}),t)}));await e}};console.log,console.warn,console.error;const r=class{static async databases(t){return await vt.Factory.databases(t)}static async open(t,e){return vt._Db_Name=t,await vt.Factory.open(t,e)}static async delete_database(t){return await vt.Factory.delete_database(t)}static init(){}},_=(console.log,console.warn,console.error);class s{static intersect_arrs(t){return t.reduce(((t,e)=>t.filter((t=>e.includes(t)))))}static#e(t){if("string"==typeof t)return t;if(t.constructor!=Object)return"";var e="";for(let a in t){let r=t[a];if(null!=r)if(r instanceof Array)for(let t of r)e+=s.obj_to_valuestr(t)+" ";else r.constructor==Object?e+=s.obj_to_valuestr(r):"string"==typeof r&&(e+=r+" ")}return e}static obj_to_valuestr(t){return s.#e(t).trim()}static obj_to_json(t){return JSON.stringify(t)}static json_to_obj_sd(t){return JSON.parse(t)}static json_to_obj_bd(t){return JSON.parse(t,((t,e)=>null==e?null:e.constructor!=String||null==e.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/)?e:new Date(e)))}static prop_set(t,e,a){var r=e.split("."),s=t;if(0!=r.length){if(1==r.length)return t[e]=a,t;for(let e=0;e<r.length;e++){let _=r[e];if(!(e<r.length-1))return s[_]=a,t;null==s[_]&&(s[_]={}),s=s[_]}}else _("[EI] utils.prop_set: Invalid path")}static prop_get(t,e){var a=e.split("."),r=t;if(0!=a.length){if(1==a.length)return t[e];for(let t=0;t<a.length;t++){let e=a[t];if(null==r[e])return null;r=r[e]}return r}_("[EI] utils.prop_get: Invalid path")}static deepcopy(t){return s.json_to_obj_bd(s.obj_to_json(t))}static escape_for_regex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}static init(){}}const n=s;console.log,console.warn;var o=console.error;const i="op_hist",l={create:"Recent_Creates",read:"Recent_Reads",update:"Recent_Updates",delete:"Recent_Deletes"};class c{static max_history=1e3;static enabled=!1;#a(){}static set_max_history(t){history.max_history=t}static get_op_hist_status(){return c.enabled?"enabled":"disabled"}static async enable_op_hist(){c.enabled=!0}static disable_op_hist(){c.enabled=!1}static sort_docmetas_des(t){return t.sort(((t,e)=>t.Timestamp<e.Timestamp?1:t.Timestamp>e.Timestamp?-1:0)),t}#r(){}static async#_(t,e,a){if(c.enabled&&null!=a&&0!=a.length)if(-1!=["create","read","update","delete"].indexOf(e)){var r=await z.reopen();if(-1!=r.Object_Store_Names.indexOf(i)){var _=r.transaction(i,vt.RW).store1(),s=await _.index("Store_Name").get(vt.value_is(t));if(null==s){let s={Store_Name:t},n=[],o=new Date;for(let t of a)n.length<c.max_history&&n.push({id:t,Timestamp:o});for(let t in l)s[l[t]]=[];return s[l[e]]=n,await _.add(s),void r.close()}var n=s[l[e]],u=n.map((t=>t.id)),d=new Date,f={};for(let t=0;t<n.length;t++)f[n[t].id]=t;for(let t of a)-1==u.indexOf(t)?n.push({id:t,Timestamp:d}):n[f[t]].Timestamp=d;n=(n=c.sort_docmetas_des(n)).slice(0,c.max_history),s[l[e]]=n,await _.put(s),r.close()}else r.close()}else o("[EI] op_hist.update_op_hist: No such operation type:",e)}static update_op_hist_c(t,e){c.#_(t,"create",e)}static update_op_hist_r(t,e){c.#_(t,"read",e)}static update_op_hist_u(t,e){c.#_(t,"update",e)}static update_op_hist_d(t,e){c.#_(t,"delete",e)}static async get_op_hist(t,e){var a=await z.reopen(),r=a.transaction(i,vt.RO).store1(),_=await r.index("Store_Name").get(vt.value_is(t));return a.close(),_}#s(){}static async clear_op_hist(){var t=await z.reopen();if(t instanceof Error)o("[EI] op_hist.clear_op_hist: Failed to open db, error:",t);else{var e=t.transaction(i,vt.RW).store1();await e.delete(vt.range_gte(0)),t.close()}}#n(){}static init(){}}const u=c;console.log,console.warn;var d=console.error,f=a.new_lock;const y=256,p=new Uint8Array([0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45]);class b{static BIT_LEN=y;static FIXED_IV_BYTES=p;static FIXED_IV="000306090c0f1215181b1e2124272a2d";#o(){}static async get_pubkey_point(t){var[e,a]=f();return setTimeout((()=>{null==window.elliptic&&d("[EI] wcrypto.get_pubkey_point: No Elliptic lib found.")}),3e4),setTimeout((function e(){if(null!=window.elliptic){for(var r=elliptic.ec("p256").keyFromPrivate(t).getPublic(),_=r.getX().toString(16),s=r.getY().toString(16);_.length<64;)_="0"+_;for(;s.length<64;)s="0"+s;a([_,s])}else setTimeout(e,0)}),0),await e}#i(){}static get_random_values_unsigned(t,e){if(8==t||16==t||32==t||64==t){if(8==t)var a=new Uint8Array(e);return 16==t&&(a=new Uint16Array(e)),32==t&&(a=new Uint32Array(e)),64==t&&(a=new BigUint64Array(e)),window.crypto.getRandomValues(a),a}d("[EI] wcrypto.get_random_values_unsigned: Bits must be 8, 16, 32, or 64")}static get_random_values_signed(t,e){if(8==t||16==t||32==t||64==t){if(8==t)var a=new Int8Array(e);return 16==t&&(a=new Int16Array(e)),32==t&&(a=new Int32Array(e)),64==t&&(a=new BigInt64Array(e)),window.crypto.getRandomValues(a),a}d("[EI] wcrypto.get_random_values_signed: Bits must be 8, 16, 32, or 64")}static random_iv(){return b.get_random_values_unsigned(8,16)}static random_uuid(){return window.crypto.randomUUID()}static random_uuidx(){return(window.crypto.randomUUID()+window.crypto.randomUUID()).replaceAll("-","")}#a(){}static base64url_to_base64(t){return t.replaceAll("-","+").replaceAll("_","/")}static base64_to_base64url(t){return t.replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}static utf8_to_bytes(t){return(new TextEncoder).encode(t)}static bytes_to_utf8(t){return new TextDecoder("utf-8").decode(t)}static buff_to_bytes(t){return new Uint8Array(t)}static bytes_to_buff(t){return t.buffer}static buff_to_hex(t){return[...new Uint8Array(t)].map((t=>t.toString(16).padStart(2,"0"))).join("")}static hex_to_buff(t){return b.hex_to_bytes(t).buffer}static bytes_to_hex(t){return[...t].map((t=>t.toString(16).padStart(2,"0"))).join("")}static hex_to_bytes(t){var e=new Uint8Array(t.length/2);for(let a=0;a<e.byteLength;a++)e[a]=parseInt(t.substring(2*a,2*a+2),16);return e}static buff_to_base64(t){for(var e=new Uint8Array(t),a=e.byteLength,r="",_=0;_<a;_++)r+=String.fromCharCode(e[_]);return window.btoa(r)}static base64_to_buff(t){var e=window.atob(t),a=new Uint8Array(e.length);for(let t=0;t<a.byteLength;t++)a[t]=e.charCodeAt(t);return a.buffer}static bytes_to_base64(t){var e=t.byteLength,a="";for(let r=0;r<e;r++)a+=String.fromCharCode(t[r]);return window.btoa(a)}static base64_to_bytes(t){var e=window.atob(t),a=new Uint8Array(e.length);for(let t=0;t<a.byteLength;t++)a[t]=e.charCodeAt(t);return a}static base64_to_hex(t){return b.bytes_to_hex(b.base64_to_bytes(t))}static hex_to_base64(t){return b.bytes_to_base64(b.hex_to_bytes(t))}static base64url_to_hex(t){return t=b.base64url_to_base64(t),b.bytes_to_hex(b.base64_to_bytes(t))}static hex_to_base64url(t){var e=b.bytes_to_base64(b.hex_to_bytes(t));return b.base64_to_base64url(e)}#l(){}static async digest_sha1(t){var e=b.utf8_to_bytes(t),a=await window.crypto.subtle.digest("SHA-1",e);return this.buff_to_hex(a)}static async digest_sha256(t){var e=b.utf8_to_bytes(t),a=await window.crypto.subtle.digest("SHA-256",e);return this.buff_to_hex(a)}static async generate_key_aes(){var t={name:"AES-GCM",length:y};return await window.crypto.subtle.generateKey(t,!0,["encrypt","decrypt"])}static async generate_key_aes_kw(){var t={name:"AES-KW",length:y};return await window.crypto.subtle.generateKey(t,!0,["wrapKey","unwrapKey"])}static async generate_keys_rsa_ed(){var t={name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"};return await window.crypto.subtle.generateKey(t,!0,["encrypt","decrypt"])}static async generate_keys_rsa_sv(){var t={name:"RSA-PSS",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"};return await window.crypto.subtle.generateKey(t,!0,["sign","verify"])}static async generate_keys_ec_ed(){}static async generate_keys_ec_sv(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"])}static async import_key_pb_raw(t){var e=b.utf8_to_bytes(t);try{var a=await window.crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits","deriveKey"])}catch(t){return d("[EI] wcrypto.import_key_pb_raw: Failed to import, error:",t),null}return a}static async import_key_aes_raw(t){if(64!=t.length)return d("[EI] wcrypto.import_key_raw: Hex of key must be of length 64 chars"),null;var e=b.hex_to_bytes(t);try{var a=await window.crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!0,["encrypt","decrypt"])}catch(t){return d("[EI] wcrypto.import_key_aes_raw: Failed to import, error:",t),null}return a}static async import_key_rsa_jwk(t,e="RSA-PSS"){var a={name:e,hash:"SHA-256"};if("RSA-OAEP"==e)var r=["encrypt","decrypt"];else r=["sign","verify"];try{return await window.crypto.subtle.importKey("jwk",t,a,!0,r)}catch(t){return d("[EI] wcrypto.import_key_rsa_jwk: Failed to import, error:",t),null}}static async import_key_ec_jwk(t,e="ECDSA"){var a={name:e,namedCurve:"P-256"};if(null!=t.d)var r=["sign"];else r=["verify"];try{return await window.crypto.subtle.importKey("jwk",t,a,!0,r)}catch(t){return d("[EI] wcrypto.import_key_ec_jwk: Failed to import, error:",t),null}}static async export_key_hex(t){return b.buff_to_hex(await window.crypto.subtle.exportKey("raw",t))}static async export_key_jwk(t){try{return await window.crypto.subtle.exportKey("jwk",t)}catch(t){return d("[EI] wcrypto.export_key_jwk: Failed to export, error:",t),null}}static async derive_bits_pb(t,e,a,r=256){var _=await b.import_key_pb_raw(t),s={name:"PBKDF2",hash:"SHA-256",salt:b.utf8_to_bytes(e),iterations:a};try{var n=await window.crypto.subtle.deriveBits(s,_,r);return b.buff_to_hex(n)}catch(t){return d("[EI] wcrypto.derive_bits_pb: Failed to derive, error:",t),null}}static async derive_key_pb2aes(t,e,a){var r=await b.import_key_pb_raw(t),_={name:"PBKDF2",hash:"SHA-256",salt:b.utf8_to_bytes(e),iterations:a};try{return await window.crypto.subtle.deriveKey(_,r,{name:"AES-GCM",length:y},!0,["encrypt","decrypt"])}catch(t){return d("[EI] wcrypto.derive_key_pb2aes: Failed to derive, error:",t),null}}static async derive_keys_pb2rsa(t,e,a){}static async derive_keys_pb2ec(t,e,a){BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff"),BigInt("0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc"),BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"),BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),BigInt("0x01");var r=await b.generate_keys_ec_sv(),_=await b.export_key_jwk(r.privateKey),s=await b.export_key_jwk(r.publicKey),n=t+e;for(let t=0;t<a;t++)n=await b.digest_sha256(n);var[o,i]=await b.get_pubkey_point(n);return n=b.hex_to_base64url(n),o=b.hex_to_base64url(o),i=b.hex_to_base64url(i),_.d=n,_.x=o,_.y=i,s.x=o,s.y=i,{privateKey:await b.import_key_ec_jwk(_,"ECDSA"),publicKey:await b.import_key_ec_jwk(s,"ECDSA")}}static async encrypt_aes(t,e,a=null){if(null==a)var r=b.random_iv();else r=b.hex_to_bytes(a);var _=b.utf8_to_bytes(t),s={name:"AES-GCM",iv:r};try{var n=await window.crypto.subtle.encrypt(s,e,_)}catch(t){return d("[EI] wcrypto.encrypt_aes: Failed to encrypt, error:",t),null}return[b.buff_to_base64(n),b.bytes_to_hex(r)]}static async encrypt_aes_fiv(t,e){return await b.encrypt_aes(t,e,w.FIXED_IV)}static async encrypt_rsa(t,e){var a=b.utf8_to_bytes(t);try{var r=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},e,a)}catch(t){return d("[EI] wcrypto.encrypt_rsa: Failed to encrypt, error:",t),null}return b.buff_to_base64(r)}static async encrypt_ec(t,e){}static async decrypt_aes(t,e,a){var r=b.base64_to_bytes(t),_={name:"AES-GCM",iv:b.hex_to_bytes(e)};try{var s=await window.crypto.subtle.decrypt(_,a,r)}catch(t){return d("[EI] wcrypto.decrypt_aes: Failed to decrypt, error:",t),null}return b.bytes_to_utf8(new Uint8Array(s))}static async decrypt_aes_fiv(t,e){return await b.decrypt_aes(t,w.FIXED_IV,e)}static async decrypt_rsa(t,e){var a=b.base64_to_bytes(t);try{var r=await window.crypto.subtle.decrypt({name:"RSA-OAEP"},e,a)}catch(t){return d("[EI] wcrypto.decrypt_rsa: Failed to decrypt, error:",t),null}return b.bytes_to_utf8(new Uint8Array(r))}static async decrypt_ec(t,e){}static async sign(t,e){if("RSA-PSS"==e.algorithm.name)var a={name:"RSA-PSS",saltLength:y};else a={name:"ECDSA",hash:"SHA-256"};var r=b.utf8_to_bytes(t);try{var _=await window.crypto.subtle.sign(a,e,r)}catch(t){return d("[EI] wcrypto.sign: Failed to sign, error:",t),null}return b.buff_to_hex(_)}static async verify(t,e,a){if("RSA-PSS"==a.algorithm.name)var r={name:"RSA-PSS",saltLength:y};else r={name:"ECDSA",hash:"SHA-256"};var _=b.utf8_to_bytes(t),s=b.hex_to_bytes(e);try{return await window.crypto.subtle.verify(r,a,s,_)}catch(t){return d("[EI] wcrypto.verify: Failed to verify, error:",t),null}}static async wrap_key(){}static async unwrap_key(){}#c(){}static split_into_2(t){var e=Math.floor(t.length/2);return[t.substring(0,e),t.substring(e)]}static async password2keys(t,e,a){var r=await b.derive_bits_pb(t,e,a,512),[_,s]=b.split_into_2(r);return[await b.derive_key_pb2aes(_,e,a),await b.derive_keys_pb2ec(s,e,a)]}static async make_static_key(t,e){var a=b.random_uuidx();return await b.derive_key_pb2aes(a,t,e)}#n(){}static init(){}}const w=b,h=w,g=(console.log,console.warn,console.error),v=a.new_lock,m=!0,E=class{#a(){}static async get_1stcond_obj(t,e){}static async get_1stcond_objs(t,e){}static async intersect_cond(t,e){}static async intersect_cond_getobjs(t,e){}static get_proppath_value(t,e){}static obj_matches_cond(t,e){}#u(){}static async insert_one(t,e){if(null!=D.Skey){t="#"+t;var a=await D.obj_to_sobj(t,e);return await M.insert_one(t,a,m,e)}g("[EI] cruds.insert_one: Static key not set")}static async insert_many(t,e){if(null!=D.Skey){t="#"+t;var a=[];for(let r of e)a.push(await D.obj_to_sobj(t,r));return await M.insert_many(t,a,m,e)}g("[EI] cruds.insert_many: Static key not set")}#d(){}static async exists(t,e){if(null!=D.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await D.array_to_sarray(e[t]):a[t]=await D.value_to_svalue(e[t]);return await M.exists(t,a,m)}g("[EI] cruds.exists: Static key not set")}static async count(t,e){if(null!=D.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await D.array_to_sarray(e[t]):a[t]=await D.value_to_svalue(e[t]);return await M.count(t,a,m)}g("[EI] cruds.count: Static key not set")}static async count_all(t){if(null!=D.Skey)return t="#"+t,await M.count_all(t,m);g("[EI] cruds.count_all: Static key not set")}static async find_one(t,e){if(null!=D.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await D.array_to_sarray(e[t]):a[t]=await D.value_to_svalue(e[t]);var r=await M.find_one(t,a,m);if(null==r)return null;var _=await h.decrypt_aes_fiv(r.Etds_Obj,D.Skey),s=n.json_to_obj_bd(_);return s.id=r.id,s}g("[EI] cruds.find_one: Static key not set")}static async find_many(t,e,a=Number.MAX_SAFE_INTEGER){if(null!=D.Skey){t="#"+t;var r={};for(let t in e)"id"==t?r[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?r[t]=await D.array_to_sarray(e[t]):r[t]=await D.value_to_svalue(e[t]);var _=await M.find_many(t,r,a,m),s=[];for(let t of _){var o=await h.decrypt_aes_fiv(t.Etds_Obj,D.Skey),i=n.json_to_obj_bd(o);i.id=t.id,s.push(i)}return s}g("[EI] cruds.find_many: Static key not set")}static async find_all(t){if(null!=D.Skey){t="#"+t;var e=await M.find_all(t,m),a=[];for(let t of e){var r=await h.decrypt_aes_fiv(t.Etds_Obj,D.Skey);if(null!=r){var _=n.json_to_obj_bd(r);_.id=t.id,a.push(_)}}return a}g("[EI] cruds.find_all: Static key not set")}static async filter(t,e,a=Number.MAX_SAFE_INTEGER){if(null!=D.Skey){t="#"+t;var r={};for(let t in e)r[t]="id"==t?e[t]:await D.value_to_svalue(e[t]);var _=await M.filter(t,r,a,m),s=[];for(let t of _){var o=await h.decrypt_aes_fiv(t.Etds_Obj,D.Skey),i=n.json_to_obj_bd(o);i.id=t.id,s.push(i)}return s}g("[EI] cruds.filter: Static key not set")}#f(){}static async update_one(t,e,a){if(null!=D.Skey){t="#"+t;var r=await D.obj_to_sobj_arb(a),_={};for(let t in e)"id"==t?_[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?_[t]=await D.array_to_sarray(e[t]):_[t]=await D.value_to_svalue(e[t]);var s=await M.find_one(t,_,m),o=await h.decrypt_aes_fiv(s.Etds_Obj,D.Skey),i=n.json_to_obj_bd(o);i={...i,...a},o=n.obj_to_json(i),r.Etds_Obj=(await h.encrypt_aes_fiv(o,D.Skey))[0];var l=await M.update_one(t,_,r,m,i);return o=await h.decrypt_aes_fiv(l.Etds_Obj,D.Skey),(i=n.json_to_obj_bd(o)).id=l.id,i}g("[EI] cruds.update_one: Static key not set")}static async update_many(t,e,a,r=Number.MAX_SAFE_INTEGER){if(null!=D.Skey){t="#"+t;var _=n.deepcopy(a);delete _.id,a=_;var s=await D.obj_to_sobj_arb(a),o=[],i={};for(let t in e)"id"==t?i[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?i[t]=await D.array_to_sarray(e[t]):i[t]=await D.value_to_svalue(e[t]);var l=await M.find_many(t,i,m),c=[];for(let t of l){let e=await h.decrypt_aes_fiv(t.Etds_Obj,D.Skey),r=n.json_to_obj_bd(e);r={...r,...a,id:t.id},e=n.obj_to_json(r),c.push(r);let _=n.deepcopy(s);_.Etds_Obj=(await h.encrypt_aes_fiv(e,D.Skey))[0],o.push(_)}var u=await vt.reopen(),d=u.transaction(t,vt.RW).store1(),f=0,y=[],[p,b]=v();for(let e=0;e<l.length;e++){let a,r={...l[e],...o[e]};d.put(r,null,a=!1,(a=>{a instanceof Error?(g("[EI] cruds.update_many: Error:",a),y.push(null)):y.push(r),F.update_fts_u(t,c[e].id,c[e]),++f==l.length&&b()}))}await p;var w=[];for(let t of y){let e=await h.decrypt_aes_fiv(t.Etds_Obj,D.Skey),a=n.json_to_obj_bd(e);a.id=t.id,w.push(a)}return u.close(),w}g("[EI] cruds.update_many: Static key not set")}static async upsert_one(t,e,a){if(null!=D.Skey){t="#"+t;var r=await D.obj_to_sobj_arb(a),_={};for(let t in e)"id"==t?_[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?_[t]=await D.array_to_sarray(e[t]):_[t]=await D.value_to_svalue(e[t]);var s=await M.find_one(t,_,m),o=await h.decrypt_aes_fiv(s.Etds_Obj,D.Skey),i=n.json_to_obj_bd(o);return i={...i,...a},o=n.obj_to_json(i),r.Etds_Obj=(await h.encrypt_aes_fiv(o,D.Skey))[0],await M.upsert_one(t,_,r,m,i)}g("[EI] cruds.upsert_one: Static key not set")}#y(){}static async remove_one(t,e){if(null!=D.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await D.array_to_sarray(e[t]):a[t]=await D.value_to_svalue(e[t]);var r=await M.find_one(t,a,m);if(null==r)return null;var _=await h.decrypt_aes_fiv(r.Etds_Obj,D.Skey),s=n.json_to_obj_bd(_);s.id=r.id,await M.remove_one(t,a,m,s)}else g("[EI] cruds.remove_one: Static key not set")}static async remove_many(t,e){if(null!=D.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await D.array_to_sarray(e[t]):a[t]=await D.value_to_svalue(e[t]);var r=[],_=await M.find_many(t,a,m);if(null==_||0==_.length)return null;for(let t of _){var s=await h.decrypt_aes_fiv(t.Etds_Obj,D.Skey),o=n.json_to_obj_bd(s);o.id=t.id,r.push(o)}await M.remove_many(t,a,m,r)}else g("[EI] cruds.remove_many: Static key not set")}#n(){}static init(){}};console.log,console.warn,console.error;const S=class{#p(){}static set_max_history(t){u.set_max_history(t)}static get_op_hist_status(){return u.get_op_hist_status()}static async enable_op_hist(){u.enable_op_hist()}static disable_op_hist(){u.disable_op_hist()}#a(){}static sort_docmetas_des(t){}#f(){}static async#_(t,e,a){}static update_op_hist_c(t,e){t="#"+t,u.update_op_hist_c(t,e)}static update_op_hist_r(t,e){t="#"+t,u.update_op_hist_r(t,e)}static update_op_hist_u(t,e){t="#"+t,u.update_op_hist_u(t,e)}static update_op_hist_d(t,e){t="#"+t,u.update_op_hist_d(t,e)}#s(){}static async get_op_hist(t,e){return t="#"+t,await u.get_op_hist(t,e)}static async clear_op_hist(){await u.clear_op_hist()}#n(){}static init(){}},k=(console.log,console.warn,console.error),j=!0,x=class{#p(){}static enable_fts(){F.enable_fts()}static disable_fts(){F.disable_fts()}#a(){}static str_to_unique_words(t){}static obj_to_unique_words(t){}static async obj_exists(t,e,a){}static async increase_num_objs(t,e,a){}static async decrease_num_objs(t,e,a){}#f(){}static async update_fts(t,e,a,r){}static update_fts_c(t,e,a){F.update_fts_c(t,e,a,j)}static update_fts_r(t,e,a){}static update_fts_u(t,e,a){F.update_fts_u(t,e,a,j)}static update_fts_d(t,e,a){F.update_fts_d(t,e,a,j)}#b(){}static async#w(t,e,a,r){}static#h(t,e){}static async find_many_by_terms(t,e,a=1e3){if(null!=D.Skey){t="#"+t;var r=await F.find_many_by_terms(t,e,a,j);for(let t=0;t<r.Items.length;t++){let e=r.Items[t].Object,a=await h.decrypt_aes_fiv(e.Etds_Obj,D.Skey),_=n.json_to_obj_bd(a);_.id=e.id,r.Items[t]=_}for(let t=0;t<r.Search_Terms.length;t++)r.Search_Terms[t]=await h.decrypt_aes_fiv(r.Search_Terms[t],D.Skey);for(let t=0;t<r.Excluded_Terms.length;t++)r.Excluded_Terms[t]=await h.decrypt_aes_fiv(r.Excluded_Terms[t],D.Skey);return r}k("[EI] ftss.find_many_by_terms: Static key not set")}#n(){}static init(){}},I=console.log,O=console.warn,A=console.error;var N={Store:"_global",Etde_Skey:null,Etde_Skey_Iv:null,Etdr_Recovery:null,Etdr_Recovery_Iv:null};class T{#g(){}static cruds;static op_hists;static ftss;#v(){}static ITERATIONS=1e5;#m(){}static Ekey=null;static Akeypair=null;static Skey=null;static Rkey=null;#E(){}#S(){}static async value_to_svalue(t){var e;return e=t instanceof Object&&!(t instanceof Date)?n.obj_to_json(t):t instanceof Date?t.toISOString():t.toString(),(await h.encrypt_aes_fiv(e,T.Skey))[0]}static async array_to_sarray(t){var e=[];for(let a of t)e.push(await R.value_to_svalue(a));return e}static async obj_to_sobj(t,e){if(null==T.Skey)return void A("[EI] idbxs.obj_to_sobj: Static key not set");var a=Object.keys(z.Indices[t]);a=a.filter((t=>"id"!=t));let r=[];if(null!=e.id)var _={id:e.id};else _={};for(let t of a){if(t.indexOf(",")>=0){let a=t.split(",");for(let t of a)r.push({Path:t,Value:n.prop_get(e,t)})}else r.push({Path:t,Value:n.prop_get(e,t)});for(let t=0;t<r.length;t++){let e;e=r[t].Value instanceof Object&&!(r[t].Value instanceof Date)?n.obj_to_json(r[t].Value):null==r[t].Value?"null":r[t].Value instanceof Date?r[t].Value.toISOString():r[t].Value.toString();let a=await h.encrypt_aes_fiv(e,T.Skey);r[t].Svalue=a[0]}}for(let t of r){let e=t.Path,a=t.Svalue;_=n.prop_set(_,e,a)}var s=n.obj_to_json(e),o=await h.encrypt_aes_fiv(s,T.Skey);return _.Etds_Obj=o[0],_}static async obj_to_sobj_arb(t){var e={};for(let a in t){let r;r=t[a]instanceof Object&&!(t[a]instanceof Date)?n.obj_to_json(t[a]):t[a]instanceof Date?t[a].toISOString():t[a].toString(),e[a]=(await h.encrypt_aes_fiv(r,T.Skey))[0]}return e}static async#k(t){if(null==t)return null;if(!(t instanceof Object))return(await h.encrypt_aes_fiv(t,T.Skey))[0];if(t instanceof Date)return(await h.encrypt_aes_fiv(t.toISOString(),T.Skey))[0];for(let e in t)t[e]=await T.#k(t[e]);return t}static async obj_to_sobj_arb_rec(t){var e=JSON.parse(JSON.stringify(t));return await T.#k(e)}#j(){}static async open_av(t,e){var a=Object.keys(e);for(let t of a)null!=e[t]._secure&&(delete e[t]._secure,e["#"+t]={...e[t]},delete e[t]);return await z.open_av(t,e)}#x(){}static async ensure_global_meta(t){null==await T.load_global_meta(t)&&await t.add(N)}static async load_global_meta(t){var e=t;if(null==t){var a=await vt.reopen();t=a.transaction("_meta",vt.RO).store1()}var r=await t.index("Store").get(vt.value_is("_global"));return null==e&&a.close(),r}static async update_global_meta(t,e){var a=t;if(null==t){var r=await vt.reopen();t=r.transaction("_meta",vt.RW).store1()}var _=await T.load_global_meta(t);_={..._,...e},await t.put(_),null==a&&r.close()}static async set_user_and_pw(t,e){var a=await T.load_static_key();if(null==a)return new Error("failed-to-load-static-key");T.set_static_key(a);var[r,_]=await T.get_key_chain(t,e);let s;T.set_ea_keys(r,_),await T.save_static_key(a,s=!0)}#I(){}static set_ea_keys(t,e){T.Ekey=t,T.Akeypair=e}static set_static_key(t){T.Skey=t}static async save_static_key(t,e=!1){if(null!=T.Ekey&&null!=T.Akeypair){var a=await h.export_key_hex(t),r=await h.encrypt_aes(a,T.Ekey),[_,s]=r,n=await vt.reopen(),o=n.transaction("_meta",vt.RW).store1(),i=await o.index("Store").get(vt.value_is("_global"));if(null==i&&(T.ensure_global_meta(o),i=await o.index("Store").get(vt.value_is("_global"))),null!=i.Etde_Skey&&0==e)return O("[EI] idbxs.save_static_key: Static key exists, no enforcing"),void n.close();i.Etde_Skey=_,i.Etde_Skey_Iv=s,o.put(i),n.close()}else A("[EI] idbxs.save_static_key: Encryption key and auth key pair must exist first, call set_ea_keys")}static async load_static_key(){if(null!=T.Ekey&&null!=T.Akeypair){var t=await vt.reopen(),e=t.transaction("_meta",vt.RW).store1(),a=await e.index("Store").get(vt.value_is("_global"));if(null==a)return O("[EI] idbxs.load_static_key: Global metadata not set"),await T.ensure_global_meta(e),void t.close();if(null==a.Etde_Skey)return O("[EI] idbxs.load_static_key: No static key in global metadata"),void t.close();var r=a.Etde_Skey,_=a.Etde_Skey_Iv,s=await h.decrypt_aes(r,_,T.Ekey),n=await h.import_key_aes_raw(s);return t.close(),n}A("[EI] idbxs.load_static_key: Encryption key and auth key pair must exist first, call set_ea_keys")}static async save_data_iv(t){await vt.update_one("_meta",{Store:"_global"},{Etds_Data_Iv:t})}static async load_data_iv(){var t=await vt.find_one("_meta",{Store:"_global"});return null==t?null:t.Etds_Data_Iv}static async prepare_keys(t,e){var a=vt.slocal.get("Ekey_Hex"),r=vt.slocal.get("Akeypriv_Jwk"),_=vt.slocal.get("Akeypub_Jwk"),s=!1;if(null!=a&&null!=r&&null!=_){var n=await h.import_key_aes_raw(a),o={privateKey:i=await h.import_key_ec_jwk(r),publicKey:l=await h.import_key_ec_jwk(_)};T.set_ea_keys(n,o);try{I("[EI] Trying stored keys..."),s=null!=(c=await T.load_static_key())}catch(t){}}if(!s){var[n,o]=await T.get_key_chain(t,e);T.set_ea_keys(n,o);var i=o.privateKey,l=o.publicKey;I("[EI] Trying keys from username and password...");var c=await T.load_static_key()}var u=null;if(null==c){let e;O("[EI] idbxs.prepare_keys: No static key, creating one..."),c=await T.get_new_static_key(t),u=await h.bytes_to_hex(await h.random_iv()),await T.save_static_key(c,e=!0),await T.save_data_iv(u)}T.set_static_key(c),R.FIXED_IV=null!=u?u:await R.load_data_iv(),vt.slocal.set("Ekey_Hex",await h.export_key_hex(n)),vt.slocal.set("Akeypriv_Jwk",await h.export_key_jwk(i)),vt.slocal.set("Akeypub_Jwk",await h.export_key_jwk(l))}static clear_keys(){vt.slocal.clear("Ekey_Hex"),vt.slocal.clear("Akeypriv_Jwk"),vt.slocal.clear("Akeypub_Jwk"),vt.sec.Skey=null,vt.sec.Ekey=null,vt.sec.Rkey=null,vt.sec.Akeypair=null}static async get_key_chain(t,e){t=t.trim(),e=e.trim(),I(`[EI] Creating key chain, ${T.ITERATIONS} iterations`);var a=performance.now(),r=await h.digest_sha256(t),[_,s]=await h.password2keys(e,r,T.ITERATIONS),n=performance.now();return I(`[EI] Key chain made in ${(n-a)/1e3} seconds`),[_,s]}static async get_new_static_key(t){t=t.trim();var e=await h.digest_sha256(t);return await h.make_static_key(e,1e3)}#O(){}static async gen_recovery_info(t,e){var a=await h.generate_key_aes(),r=await h.export_key_hex(t),_=await h.export_key_jwk(e.privateKey),s=`${r}::${h.base64url_to_hex(_.d)}::${h.base64url_to_hex(_.x)}::${h.base64url_to_hex(_.y)}`,[n,o]=await h.encrypt_aes(s,a);return{Ciphertext:n,Iv:o,Recovery_Key:a}}static async save_recovery_info(t,e){var a=await vt.reopen(),r=a.transaction("_meta",vt.RW).store1(),_={Etdr_Recovery:t,Etdr_Recovery_Iv:e};await T.update_global_meta(r,_),a.close()}static async recover_key_chain(t,e,a){var r=await h.decrypt_aes(t,e,a);if(null==r)return null;var[_,s,n,o]=r.split("::"),i=await h.import_key_aes_raw(_),l=await h.generate_keys_ec_sv(),c=await h.export_key_jwk(l.privateKey),u=await h.export_key_jwk(l.publicKey);c.d=h.hex_to_base64url(s),c.x=h.hex_to_base64url(n),c.y=h.hex_to_base64url(o),u.x=h.hex_to_base64url(n),u.y=h.hex_to_base64url(o);var d={};return d.privateKey=await h.import_key_ec_jwk(c),d.publicKey=await h.import_key_ec_jwk(u),[i,d]}static async recover_and_set_keys(t){if(t instanceof CryptoKey){var e=await vt.reopen(),a=e.transaction("_meta",vt.RO).store1(),r=await T.load_global_meta(a);if(null==r)return A("[EI] idbxs.recover_and_set_keys: Bad global metadata:",r),void e.close();var _=r.Etdr_Recovery,s=r.Etdr_Recovery_Iv;if(null==_||null==s)return A("[EI] idbxs.recovery_and_set_keys: No or bad recovery data in global metadata"),void e.close();var[n,o]=await T.recover_key_chain(_,s,t);if(!(null!=n&&null!=o&&n instanceof CryptoKey&&o.privateKey instanceof CryptoKey&&o.publicKey instanceof CryptoKey))return A("[EI] idbxs.recovery_and_set_keys: Failed to recover keys, found:",n,o),void e.close();var i=r.Etde_Skey,l=r.Etde_Skey_Iv,c=await h.decrypt_aes(i,l,n);if(null==c)return A("[EI] idbxs.recovery_and_set_keys: Failed to decrypt for static key"),void e.close();var u=await h.import_key_aes_raw(c);return T.set_ea_keys(n,o),T.set_static_key(u),e.close(),[n,o]}A("[EI] idbxs.recover_and_set_keys: First param is not CryptoKey")}static get_micro_dict(){var t=["a","e","i","o","u","y"],e=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","z"],a=[],r=[];for(let r of e)for(let e of t)a.push(r+e);for(let a of t)for(let t of e)r.push(a+t);var _=[],s=a.length-1;for(let t=0;t<120;t++)t%8==0?_.push(a[t]):t%8==1?_.push(r[t]):t%8==2?_.push(a[t]+a[s-t]):t%8==3?_.push(a[t]+r[t]):t%8==4?_.push(r[t]+a[t]):t%8==5?_.push(r[t]+r[s-t]):t%8==6?_.push(a[t]+r[t]+r[s-t]):t%8==7&&_.push(r[t]+a[t]+a[s-t]);_=Array.from(new Set(_)).sort();var n=[];for(let t of _)n.push(t),n.push(t.split("").reverse().join(""));n=Array.from(new Set(n)).sort();var o=[...n],i=256-n.length;for(let t=0;t<i;t++){let e=Math.floor(n.length/i*t);o.push(n[e]+n[e+1])}return Array.from(new Set(o)).sort()}static#A(t,e){for(let a=0;a<e;a++){let e=[...t.matchAll(/[\s]+/g)].map((t=>t.index)),a=e[Math.floor(Math.random()*e.length)],r=t.split("");r[a]=".",t=r.join("")}return t}static#N(t,e){for(let a=0;a<e;a++){let e=[...t.matchAll(/[\s]+/g)].map((t=>t.index)),a=e[Math.floor(Math.random()*e.length)],r=t.split("");r[a]=",",t=r.join("")}return t}static#T(t){var e=(t=t.replaceAll(",",", ")).split(".");for(let t=0;t<e.length;t++)e[t]=e[t].charAt(0).toUpperCase()+e[t].substring(1);return(t=e.join(". "))+"."}static async key_to_text(t){var e=await h.export_key_hex(t),a=T.get_micro_dict(),r=h.hex_to_bytes(e),_=[];for(let t=0;t<r.byteLength;t++)_.push(a[r[t]]);var s=_.join(" ");return s=T.#A(s,4),s=T.#N(s,8),T.#T(s)}static async text_to_key(t){var e=(t=(t=(t=t.toLowerCase().replaceAll(/[^a-z]+/g," ")).trim()).replaceAll(/[\s]{2,}/g," ")).split(" "),a=T.get_micro_dict(),r=new Uint8Array(32);for(let t of e)if(-1==a.indexOf(t))return void A("[EI] idbxs.text_to_key: Invalid word:",t);for(let t=0;t<e.length;t++){let _=e[t],s=a.indexOf(_);r[t]=s}var _=h.bytes_to_hex(r);return await h.import_key_aes_raw(_)}#R(){}static async decrypt_obj(t){var e=await h.decrypt_aes_fiv(t.Etds_Obj,T.Skey),a=n.json_to_obj_bd(e);return a.id=t.id,a}#n(){}static init(){T.cruds=E,T.op_hists=S,T.ftss=x,T.cruds.init(),T.op_hists.init(),T.ftss.init()}}const R=T,D=R,C=(console.log,console.warn),U=console.error;class K{static enabled=!1;static score_rate=2;#p(){}static enable_fts(){K.enabled=!0}static disable_fts(){K.enabled=!1}#a(){}static str_to_unique_words(t){var e=(t=(t=(t=t.toLowerCase()).replace(/[^0-9A-Za-z_\-]/g," ")).replace(/[\s]{2,}/g," ").trim()).split(" ").filter((t=>t.length>=2&&t.length<=40));return Array.from(new Set(e))}static obj_to_unique_words(t){var e=n.obj_to_valuestr(t);return K.str_to_unique_words(e)}static async obj_exists(t,e,a){var r=t.index(e);return null!=await r.get_key(vt.value_is(a))}static async increase_num_objs(t,e,a){var r=await t.index("Store,Word").get(vt.value_is([e,a]));r.num_obj_ids++,await t.put(r)}static async decrease_num_objs(t,e,a){var r=await t.index("Store,Word").get(vt.value_is([e,a]));r.num_obj_ids>0&&r.num_obj_ids--,r.num_obj_ids>0?await t.put(r):await t.delete(vt.value_is(r.id))}#f(){}static async update_fts(t,e,a,r,_=!1){if(-1!=["create","update","delete"].indexOf(t)){if(_)var s="#fts_words",n="#fts_ids";else s="fts_words",n="fts_ids";var o=K.obj_to_unique_words(r);if(_)for(let t=0;t<o.length;t++){let e=(await h.encrypt_aes_fiv(o[t],D.Skey))[0];o[t]=e}var i=await z.reopen(),l=i.transaction([s,n],vt.RW),c=l.object_store(s),u=l.object_store(n);for(let r of o)await K.obj_exists(c,"Store,Word",[e,r])||await c.add({Store:e,Word:r,num_obj_ids:0}),"create"==t?(await u.add({Store:e,Word:r,obj_id:a}),await K.increase_num_objs(c,e,r)):"update"==t?await K.obj_exists(u,"Store,Word,obj_id",[e,r,a])||(await u.add({Store:e,Word:r,obj_id:a}),await K.increase_num_objs(c,e,r)):(await u.index("Store,Word,obj_id").delete(vt.value_is([e,r,a])),await K.decrease_num_objs(c,e,r));var d=await u.index("Store,obj_id").get_all(vt.value_is([e,a])),f=(d=d.map((t=>t.Word))).filter((t=>-1==o.indexOf(t)));for(let t of f)await u.index("Store,Word,obj_id").delete(vt.value_is([e,t,a])),await K.decrease_num_objs(c,e,t);i.close()}else U("[EI] fts.update_fts: Bad operation:",t)}static update_fts_c(t,e,a,r=!1){K.enabled&&K.update_fts("create",t,e,a,r)}static update_fts_r(t,e,a,r=!1){}static update_fts_u(t,e,a,r=!1){K.enabled&&K.update_fts("update",t,e,a,r)}static update_fts_d(t,e,a,r=!1){K.enabled&&K.update_fts("delete",t,e,a,r)}#b(){}static async#w(t,e,a,r){var _=e.Name,s=[];await t.index("Store,Word").open_cursor(vt.value_is([_,a]),"next",(t=>{if(s.push(t.value.obj_id),s.length>=r)return vt._stop}));var n=[];for(let t of s){let a=await e.get(vt.value_is(t));null!=a?n.push(a):C("[EI] fts.#term_to_objs: Found bad id:",t)}return n}static#h(t,e){var a=[],r={},_=1;for(let t=e.length-1;t>=0;t--)r[e[t]]=_,_<Number.MAX_SAFE_INTEGER/K.score_rate&&(_*=K.score_rate);for(let _ of t){let t={Object:_,score:0},s=n.obj_to_valuestr(_).toLowerCase(),o=0;for(let t of e){let e=n.escape_for_regex(t);o+=r[t]*(s.match(new RegExp(e,"g"))||[]).length}t.score=o,a.push(t)}return a.sort(((t,e)=>e.score-t.score))}static async find_many_by_terms(t,e,a=1e3,r=!1){if(0==K.enabled&&C("[EI] fts.find_many_by_terms: FTS is disabled, there might be results but no changes."),r)var _="#fts_words",s="#fts_ids";else _="fts_words",s="fts_ids";var n=K.str_to_unique_words(e);if(r)for(let t=0;t<n.length;t++)n[t]=(await h.encrypt_aes_fiv(n[t],D.Skey))[0];var o=await vt.reopen(),i=o.transaction([_,s,t],vt.RO),l=i.object_store(_),c=i.object_store(s),u=i.object_store(t),d=[],f=[];for(let e of n){let a=await l.index("Store,Word").get(vt.value_is([t,e]));if(null==a){d.push(e);continue}let r={Term:e,exists:!0,size:a.num_obj_ids};f.push(r)}var y="More specific terms are listed first in Search_Terms; higher score items are listed first.";if(0==f.length)return{Items:[],Search_Terms:[],Excluded_Terms:d,Note:y};if(1==f.length){let t=f[0].Term,e=await K.#w(c,u,t,a);return{Items:K.#h(e,[t]),Search_Terms:[t],Excluded_Terms:d,Note:y}}var p=(f=f.sort(((t,e)=>t.size-e.size))).map((t=>t.Term)),b=f[0].Term,w=f.slice(1).map((t=>t.Term)),g=[];await c.index("Store,Word").open_cursor(vt.value_is([t,b]),"next",(async e=>{var a=e.value.obj_id,r=!0;for(let e of w)if(0==await c.index("Store,Word,obj_id").count(vt.value_is([t,e,a]))){r=!1;break}r&&g.push(a)}));var v=[];for(let t of g){let e=await u.get(vt.value_is(t));null!=e?v.push(e):C("[EI] fts.find_many_by_terms: Found bad id:",t)}var m=K.#h(v,p);return o.close(),{Items:m,Search_Terms:p,Excluded_Terms:d,Note:y}}#n(){}static init(){}}const F=K;console.log,console.warn;var W=console.error,P=a.new_lock,B=(JSON.parse,JSON.stringify);class L{#a(){}static async get_1stcond_obj(t,e){var a=Object.keys(e),r=t.index(a[0]);if(r instanceof Error)return W("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",a[0]),null;var _=e[a[0]];return await r.get(_)}static async get_1stcond_objs(t,e,a=Number.MAX_SAFE_INTEGER){var r=Object.keys(e),_=t.index(r[0]);if(_ instanceof Error)return W("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",r[0]),null;var s=e[r[0]],n=[];return await _.open_cursor(s,"next",(t=>{if(n.push(t.value),n.length>=a)return"stop"})),n}static async intersect_cond(t,e){var a=Object.keys(e);if(0==a.length)return[];var r=[];for(let _ of a){let a=t.index(_);if(a instanceof Error)return W("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",_),null;let s=e[_],n=(await a.get_all(s)).map((t=>t.id));r.push(n)}return n.intersect_arrs(r)}static async intersect_cond_getobjs(t,e){var a=Object.keys(e);if(0==a.length)return[];var r=[],_={};for(let s of a){let a=t.index(s);if(a instanceof Error)return W("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",s),null;let n=e[s],o=(await a.get_all(n)).map((t=>(_[t.id]=t,t.id)));r.push(o)}return n.intersect_arrs(r).map((t=>_[t]))}static get_proppath_value(t,e){var a=e.split("."),r=t;for(let t of a){if(null==r[t])return null;r=r[t]}return r}static obj_matches_cond(t,e){for(let a in e){let r=e[a],_=L.get_proppath_value(t,a);if(null==_)return!1;if(-1==B(_).indexOf(r))return!1}return!0}#u(){}static async insert_one(t,e,a=!1,r=null){var _=await vt.reopen(),s=_.transaction(t,vt.RW).store1(),n={...e};delete n.id;var o=await s.add(n);return o instanceof Error?(W("[EI] crud.insert_one: Failed, error:",o),null==s&&_.close(),null):(u.update_op_hist_c(s.Name,[o]),a?x.update_fts_c(s.Name,o,r):F.update_fts_c(s.Name,o,e),null==s&&_.close(),o)}static async insert_many(t,e,a=!1,r=null){var _=await vt.reopen(),s=_.transaction(t,vt.RW).store1(),n=[],[o,i]=P();if(null==e||0==e.length)return _.close(),[];for(let t of e){let a={...t};delete a.id;let r=s.self.add(a);r.onerror=t=>{W("[EI] crud.insert_many: Failed to add object, error:",t.target.error),n.push(null),n.length==e.length&&i()},r.onsuccess=t=>{n.push(t.target.result),n.length==e.length&&i()}}await o;for(let t=0;t<n.length;t++)a?x.update_fts_c(s.Name,n[t],r[t]):F.update_fts_c(s.Name,n[t],e[t]);return _.close(),n}#d(){}static async exists(t,e,a=!1){var r=await vt.reopen(),_=r.transaction(t,vt.RO).store1(),s=Object.keys(e);if(0==s.length)return r.close(),[];if(1==s.length){let t=await L.get_1stcond_obj(_,e);return r.close(),null!=t}var n=await L.intersect_cond(_,e);return r.close(),n.length>0}static async count(t,e,a=!1){var r=await vt.reopen(),_=r.transaction(t,vt.RO).store1(),s=Object.keys(e);if(0==s.length)return r.close(),null;if(1==s.length){let t=await L.get_1stcond_objs(_,e);return r.close(),t.length}var n=await L.intersect_cond(_,e);return r.close(),n.length}static async count_all(t,e=!1){var a=await vt.reopen(),r=a.transaction(t,vt.RO).store1(),_=await r.count();return a.close(),_}static async find_one(t,e,a=!1){var r=await vt.reopen(),_=r.transaction(t,vt.RO).store1(),s=Object.keys(e);if(0==s.length)return r.close(),null;if(1==s.length){let t=await L.get_1stcond_obj(_,e);return null==t?(r.close(),null):(u.update_op_hist_r(_.Name,[t.id]),r.close(),t)}var n=await L.intersect_cond(_,e);if(0==n.length)return r.close(),null;var o=await _.get(vt.value_is(n[0]));return u.update_op_hist_r(_.Name,n),r.close(),o}static async find_many(t,e,a=Number.MAX_SAFE_INTEGER,r=!1){var _=await vt.reopen(),s=_.transaction(t,vt.RO).store1(),n=Object.keys(e);if(0==n.length)return _.close(),null;if(1==n.length){let t=await L.get_1stcond_objs(s,e,a);return _.close(),t}var o=await L.intersect_cond(s,e);if(null==o||0==o.length)return _.close(),[];var i=[],[l,c]=P();for(let t of o){let e=s.self.get(vt.value_is(t).self);e.onerror=t=>{i.push(null),i.length==o.length&&c(),i.length>=a&&c()},e.onsuccess=t=>{i.push(t.target.result),i.length==o.length&&c(),i.length>=a&&c()}}return await l,_.close(),i}static async find_all(t,e=!1){var a=await vt.reopen(),r=a.transaction(t,vt.RO).store1(),_=await r.get_all();return a.close(),_}static async filter(t,e,a=Number.MAX_SAFE_INTEGER,r=!1){var _=await vt.reopen(),s=_.transaction(t,vt.RO).store1(),n=[];return await s.open_cursor(vt.range_gte(0),"next",(t=>{var r=t.value;if(L.obj_matches_cond(r,e)&&n.push(r),n.length>=a)return vt._stop})),_.close(),n}#f(){}static async update_one(t,e,a,r=!1,_=null){var s=await vt.reopen(),n=s.transaction(t,vt.RW).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;let i={...a};if(delete i.id,1==o.length){let t=await L.get_1stcond_obj(n,e);return null==t?(s.close(),null):(t={...t,...i},n.put(t),u.update_op_hist_u(n.Name,[t.id]),r?x.update_fts_u(n.Name,t.id,_):F.update_fts_u(n.Name,t.id,t),s.close(),t)}var l=await L.intersect_cond(n,e);if(null==l||0==l.length)return s.close(),null;var c=await n.get(vt.value_is(l[0]));return null==c?(s.close(),null):(c={...c,...i},await n.put(c),u.update_op_hist_u(n.Name,[c.id]),r?x.update_fts_u(n.Name,c.id,c):F.update_fts_u(n.Name,c.id,c),s.close(),c)}static async update_many(t,e,a,r=Number.MAX_SAFE_INTEGER,_=!1){var s=await vt.reopen(),n=s.transaction(t,vt.RW).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;let i={...a};if(delete i.id,1==o.length){if(null==(l=await L.get_1stcond_objs(n,e,r)))return s.close(),null;if(0==l.length)return s.close(),[]}else{var l;if(null==(l=await L.intersect_cond_getobjs(n,e)))return s.close(),null;if(0==l.length)return s.close(),[]}let c=[],[u,d]=P();for(let t of l){let e={...t,...i},a=n.self.put(e);a.onerror=e=>{W("[EI] crud.update_many: Failed to update object:",t),c.push(null),c.length==l.length&&d(),c.length>=r&&d()},a.onsuccess=t=>{c.push({...e,id:t.target.result}),c.length==l.length&&d(),c.length>=r&&d()}}await u;for(let t=0;t<c.length;t++)_||F.update_fts_u(n.Name,c[t].id,c[t]);return s.close(),c}static async upsert_one(t,e,a,r=!1,_=null){var s=await vt.reopen(),n=s.transaction(t,vt.RW).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;let i={...a};if(delete i.id,1==o.length){let t=await L.get_1stcond_obj(n,e);if(null==t){let t=await n.add(i);return u.update_op_hist_c(n.Name,[t]),r?x.update_fts_c(n.Name,t,_):F.update_fts_c(n.Name,t,a),s.close(),t}return t={...t,...i},n.put(t),u.update_op_hist_u(n.Name,[t.id]),r?x.update_fts_u(n.Name,t.id,_):F.update_fts_u(n.Name,t.id,t),s.close(),t.id}var l=await L.intersect_cond(n,e);if(null==l||0==l.length)return s.close(),null;var c=await n.get(vt.value_is(l[0]));if(null==c){let t=await n.add(i);return u.update_op_hist_c(n.Name,[t]),r?x.update_fts_c(n.Name,t,_):F.update_fts_c(n.Name,t,a),s.close(),t}return c={...c,...i},n.put(c),u.update_op_hist_u(n.Name,[c.id]),r?x.update_fts_u(n.Name,c.id,_):F.update_fts_u(n.Name,c.id,c),s.close(),c.id}#y(){}static async remove_one(t,e,a=!1,r=null){var _=await vt.reopen(),s=_.transaction(t,vt.RW).store1(),n=Object.keys(e);if(0==n.length)return _.close(),null;if(1==n.length){let t=await L.get_1stcond_obj(s,e);if(null==t)return _.close(),null;let n=await s.delete(vt.value_is(t.id));return u.update_op_hist_d(s.Name,[t.id]),a?x.update_fts_d(s.Name,t.id,r):F.update_fts_d(s.Name,t.id,t),_.close(),n}var o=await L.intersect_cond_getobjs(s,e),i=o.map((t=>t.id));if(null==i||0==i.length)return _.close(),null;var l=await s.delete(vt.value_is(i[0]));return u.update_op_hist_d(s.Name,[i[0]]),a?x.update_fts_d(s.Name,i[0],r):F.update_fts_d(s.Name,i[0],o[0]),_.close(),l}static async remove_many(t,e,a=!1,r=null){var _=await vt.reopen(),s=_.transaction(t,vt.RW).store1(),n=Object.keys(e);if(0==n.length)return _.close(),null;var o=[],i=[];if(1==n.length){if(o=await L.get_1stcond_objs(s,e),i=o.map((t=>t.id)),null==o||0==o.length)return _.close(),null}else if(o=await L.intersect_cond_getobjs(s,e),null==(i=o.map((t=>t.id)))||0==i.length)return _.close(),null;var[l,c]=P(),u=0;for(let t of i){let e=s.self.delete(vt.value_is(t).self);e.onerror=t=>{++u==i.length&&c()},e.onsuccess=t=>{++u==i.length&&c()}}await l;for(let t=0;t<i.length;t++)a?x.update_fts_d(s.Name,i[t],r[t]):F.update_fts_d(s.Name,i[t],o[t]);return _.close(),null}static async remove_all(t){var e=await vt.reopen(),a=e.transaction(t,vt.RW).store1(),[r,_]=P(),s=a.self.delete(vt.range_gte(0).self);return s.onerror=t=>{W("[EI] crud.remove_all: Failed to delete, event:",t),_()},s.onsuccess=t=>{_()},await r,e.close(),null}#n(){}static init(){}}const M=L;var H=console.log,G=(console.warn,console.error),$=JSON.stringify,V=JSON.parse,X={_meta:{Store:3},op_hist:{Store_Name:1},"#op_hist":{},fts_words:{Store:1,Word:1,"Store,Word":3,num_obj_ids:1},fts_ids:{Store:1,Word:1,"Store,Word":1,obj_id:1,"Store,obj_id":1,"Store,Word,obj_id":3},"#fts_words":{Store:1,Word:1,"Store,Word":3,num_obj_ids:1},"#fts_ids":{Store:1,Word:1,"Store,Word":1,obj_id:1,"Store,obj_id":1,"Store,Word,obj_id":3}};class q{#g(){}static crud;static op_hist;static fts;#m(){}static Indices={};#E(){}#D(){}static#C(t,e){return null!=localStorage.Unused_Stores&&0!=localStorage.Unused_Stores.trim().length&&(-1!=t.Object_Store_Names.indexOf(e)&&V(localStorage.Unused_Stores).indexOf(e)>=0)}static#U(t){if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)return!1;var e=t.Object_Store_Names,a=V(localStorage.Unused_Stores),r=[];for(let t of a)e.indexOf(t)>=0&&r.push(t);localStorage.Unused_Stores=$(r)}static#K(t,e){if("add"==t)if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)localStorage.Unused_Stores=$([e]);else{let t=V(localStorage.Unused_Stores);t=Array.from(new Set([...t,e])),localStorage.Unused_Stores=$(t)}else if("remove"==t)if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)localStorage.Unused_Stores=$([]);else{let t=V(localStorage.Unused_Stores),a=t.indexOf(e);a>=0&&t.splice(a,1),localStorage.Unused_Stores=$(t)}}static indexname_to_keypath(t){return t.indexOf(",")>=0?t.split(","):t}static keypath_to_indexname(t){return t.constructor===Array?t.join(","):t}#F(){}static async db_exists(t){return-1!=(await r.databases(t)).map((t=>t.name)).indexOf(t)}static async get_cur_indices(t){if(!await J.db_exists(t))return{};var e=await r.open(t),a={};if(0==e.Object_Store_Names.length)return e.close(),a;var _=e.transaction(e.Object_Store_Names,vt.RO);for(let t of e.Object_Store_Names){if(q.#C(e,t))continue;let r=_.object_store(t);a[t]={};for(let e of r.Index_Names){let _=r.index(e),n=_.Key_Path;var s=q.keypath_to_indexname(n);let o,i=_.unique,l=_.multientry;0==i&&0==l?o=1:0==i&&1==l?o=2:1==i&&0==l?o=3:1==i&&1==l&&(o=4),a[t][s]=o}}return e.close(),a}static add_more_indices(t){return{...t,...X}}static indices2str(t){var e=[];for(let a in t)for(let r in t[a]){let _=t[a][r];e.push(`${a}/${r}:${_};`)}return e.sort(),e.join("")}static async get_cur_db_ver(t){var e=await r.open(t),a=e.version;return e.close(),a}static async upgrade_db(t,e,a){if(await J.db_exists(t))var _=await q.get_cur_db_ver(t)+1;else _=1;H("[EI] idbx.upgrade_db: Upgrading to version",_);var s=await r.open(t,_);if(s instanceof Error)G("[EI] idbx.upgrade_db: Failed to open db,",s);else{var n=Object.keys(e),o=Object.keys(a),i=[];for(let t of n)-1==o.indexOf(t)&&i.push(t);for(let t of i)H("[EI] idbx.upgrade_db: Found unused store:",t),q.#K("add",t);var l=[];for(let t of o)-1==n.indexOf(t)&&(q.#C(s,t)?(e[t]={},q.#K("remove",t)):l.push(t));for(let t of l){H("[EI] idbx.upgrade_db: Creating new store:",t);let e=s.create_object_store(t);for(let r in a[t]){let _=a[t][r],s=q.indexname_to_keypath(r);H("[EI] idbx.upgrade_db: Creating new index:",t,"/",r),e.create_index(r,s,_)}}var c=[],u=Array.from(new Set([...n,...o]));for(let t of u)-1==i.indexOf(t)&&-1==l.indexOf(t)&&c.push(t);var d=s.Transaction;for(let t of c){let r=d.object_store(t),_=Object.keys(e[t]),s=Object.keys(a[t]),n=[],o=[];for(let e of _)-1==s.indexOf(e)&&(H("[EI] idbx.upgrade_db: Deleting unused index:",t,"/",e),r.delete_index(e),n.push(e));for(let e of s)if(-1==_.indexOf(e)){let _=a[t][e],s=q.indexname_to_keypath(e);H("[EI] idbx.upgrade_db: Creating new index:",t,"/",e),r.create_index(e,s,_),o.push(e)}let i=[],l=Array.from(new Set([..._,...s]));for(let t of l)-1==n.indexOf(t)&&-1==o.indexOf(t)&&i.push(t);for(let _ of i)if(a[t][_]!=e[t][_]){let e=a[t][_],s=q.indexname_to_keypath(_);H("[EI] idbx.upgrade_db: Updating index to new type:",t,"/",_+":"+e),r.delete_index(_),r.create_index(_,s,e)}}s.close()}}static async open_av(t,e){if(null!=t){if(null!=e){e=q.add_more_indices(e);for(let t in e)e[t].id=3;q.Indices=e;var a=(await r.databases(t)).map((t=>t.name));vt._Db_Name=t;var _=e;if(a.indexOf(t)>=0)var s=await q.get_cur_indices(t);else s={};var n=q.indices2str(s);if(q.indices2str(_)==n)return await r.open(t);await q.upgrade_db(t,s,_);var o=await r.open(t);return q.#U(o),o}G("[EI] idbx.open_av: Indices name cannot be null")}else G("[EI] idbx.open_av: Db name cannot be null")}static async reopen(t=null){return null==t?await r.open(vt._Db_Name):await r.open(t)}static num_db_cons(){return vt._num_db_cons}static set_db(t){vt._Db_Name=t}#W(){}static async get_prop(t,e){if(null!=vt._Db_Name&&0!=vt._Db_Name.trim().length)return(await r.open(vt._Db_Name)).transaction(t,vt.RW).store1()[e];G("[EI] idbx.get_prop: Call 'idb.open', 'idbx.open_av', or 'idbx.set_db' first")}static async do_op(t,e,...a){if(null!=vt._Db_Name&&0!=vt._Db_Name.trim().length){var _=(await r.open(vt._Db_Name)).transaction(t,vt.RW).store1();return await _[e](...a)}G("[EI] idbx.do_op: Call 'idb.open', 'idbx.open_av', or 'idbx.set_db' first")}static async del_obj_store(t,e){var a=await q.get_cur_db_ver(t)+1,_=await r.open(t,a);_ instanceof Error?G(`[EI] idbx.del_obj_store: Failed to delete object store '${e}' in db '${t}', error:`,_):(await _.delete_object_store(e),q.#K("remove",e),_.close())}#n(){}static init(){q.crud=M,q.op_hist=u,q.fts=F,q.crud.init(),q.op_hist.init(),q.fts.init()}}const J=q,z=J;console.log,console.warn;var Z=console.error;const Y=class{self=null;constructor(t){this.self=t}#P(){}get Lower(){return this.self.lower}get Lower_Open(){return this.self.lowerOpen}get Upper(){return this.self.upper}get Upper_Open(){return this.self.upperOpen}#E(){}includes(t){try{return this.self.includes(t.self)}catch(t){return Z("[EI] key_range.includes: Error:",t),t}}};console.log,console.warn,console.error,console.log,console.warn;var Q=console.error;const tt=a.new_lock,et=class{self=null;constructor(t){this.self=t}#P(){}get Key_Path(){return this.self.keyPath}get multientry(){return this.self.multiEntry}get Name(){return this.self.name}get Object_Store(){return new st(this.self.objectStore)}get unique(){return this.self.unique}#E(){}async count(t){try{if(null==t)var e=this.self.count();else e=t.constructor==Y?this.self.count(t.self):this.self.count(t);var[a,r]=tt();return e.onerror=t=>{r(t.target.error)},e.onsuccess=t=>{r(t.target.result)},await a}catch(t){return Q("[EI] index.count: Error:",t),t}}async get(t){try{if(null==t)var e=this.self.get();else e=t.constructor==Y?this.self.get(t.self):this.self.get(t);var[a,r]=tt();return e.onerror=t=>{r(t.target.error)},e.onsuccess=t=>{r(t.target.result)},await a}catch(t){return Q("[EI] index.get: Error:",t),t}}async get_all(t,e){try{if(null==t)var a=this.self.getAll();else a=t.constructor==Y?this.self.getAll(t.self,e):this.self.getAll(t,e);var[r,_]=tt();return a.onerror=t=>{_(t.target.error)},a.onsuccess=t=>{_(t.target.result)},await r}catch(t){return Q("[EI] index.get_all: Error:",t),t}}async get_all_keys(t,e){try{if(null==t)var a=this.self.getAllKeys();else a=t.constructor==Y?this.self.getAllKeys(t.self,e):this.self.getAllKeys(t,e);var[r,_]=tt();return a.onerror=t=>{_(t.target.error)},a.onsuccess=t=>{_(t.target.result)},await r}catch(t){return Q("[EI] index.get_all_keys: Error:",t),t}}async get_key(t){try{if(null==t)var e=this.self.getKey();else e=t.constructor==Y?this.self.getKey(t.self):this.self.getKey(t);var[a,r]=tt();return e.onerror=t=>{r(t.target.error)},e.onsuccess=t=>{r(t.target.result)},await a}catch(t){return Q("[EI] index.get_key: Error:",t),t}}async open_cursor(t,e="next",a){try{if(null==t)var r=this.self.openCursor();else r=t.constructor==Y?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[_,s]=tt();return r.onerror=function(t){s(t.target.error)},r.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await a(e)?s():e.continue():s(null)},await _}catch(t){return Q("[EI] index.open_cursor: Error:",t),t}}async open_key_cursor(t,e="next",a){try{if(null==t)var r=this.self.openCursor();else r=t.constructor==Y?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[_,s]=tt();return r.onerror=function(t){s(t.target.error)},r.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await a(e)?s():e.continue():s(null)},await _}catch(t){return Q("[EI] index.open_key_cursor: Error:",t),t}}#B(){}async delete(t){var e=0;return await this.open_cursor(t,"next",(t=>{t.delete(),e++})),e}};var at=console.log,rt=(console.warn,console.error),_t=a.new_lock;const st=class{self=null;constructor(t){this.self=t}#P(){}get auto_increment(){return this.self.autoIncrement}get Index_Names(){return[...this.self.indexNames]}get Key_Path(){return this.self.keyPath}get Name(){return this.self.name}get Transaction(){return new ot(this.self.transaction)}#E(){}async add(t){try{var e=this.self.add(t),[a,r]=_t();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return rt("[EI] object_store.add: Error:",t),t}}async clear(){try{var t=this.self.clear(),[e,a]=_t();return t.onerror=function(t){a(t.target.error)},t.onsuccess=function(t){a(t.target.result)},await e}catch(t){return rt("[EI] object_store.clear: Error:",t),t}}async count(t){try{if(null==t)var e=this.self.count();else e=t.constructor==Y?this.self.count(t.self):this.self.count(t);var[a,r]=_t();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return rt("[EI] object_store.count: Error:",t),t}}create_index(t,e,a){try{if(a==vt.n1)var r={unique:!1,multiEntry:!1};else a==vt.n2?r={unique:!1,multiEntry:!0}:a==vt.u1?r={unique:!0,multiEntry:!1}:a==vt.u2&&(r={unique:!0,multiEntry:!0});return new et(this.self.createIndex(t,e,r))}catch(t){return rt("[EI] object_store.create_index: Error:",t),t}}async delete(t){try{if(t.constructor==Y)var e=this.self.delete(t.self);else e=this.self.delete(t);var[a,r]=_t();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return rt("[EI] object_store.delete: Error:",t),t}}delete_index(t){try{this.self.deleteIndex(t)}catch(t){return rt("[EI] object_store.delete_index: Error:",t),t}}async get(t){try{if(null==t)var e=this.self.get();else e=t.constructor==Y?this.self.get(t.self):this.self.get(t);var[a,r]=_t();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return rt("[EI] object_store.get: Error:",t),t}}async get_all(t){try{if(null==t)var e=this.self.getAll();else e=t.constructor==Y?this.self.getAll(t.self):this.self.getAll(t);var[a,r]=_t();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return rt("[EI] object_store.get_all: Error:",t),t}}async get_all_keys(t,e){try{if(null==t)var a=this.self.getAllKeys();else a=t.constructor==Y?this.self.getAllKeys(t.self,e):this.self.getAllKeys(t,e);var[r,_]=_t();return a.onerror=function(t){_(t.target.error)},a.onsuccess=function(t){_(t.target.result)},await r}catch(t){return rt("[EI] object_store.get_all_keys: Error:",t),t}}async get_key(t){try{if(null==t)var e=this.self.getKey();else e=t.constructor==Y?this.self.getKey(t.self):this.self.getKey(t);var[a,r]=_t();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return rt("[EI] object_store.get_key: Error:",t),t}}index(t){try{return new et(this.self.index(t))}catch(t){return rt("[EI] object_store.index: Error:",t),t}}async open_cursor(t,e="next",a){try{if(null==t)var r=this.self.openCursor();else r=t.constructor==Y?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[_,s]=_t();return r.onerror=function(t){s(t.target.error)},r.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await a(e)?s():e.continue():s(null)},await _}catch(t){return rt("[EI] object_store.open_cursor: Error:",t),t}}async open_key_cursor(t,e="next",a){try{if(null==t)var r=this.self.openKeyCursor();else r=t.constructor==Y?this.self.openKeyCursor(t.self,e):this.self.openKeyCursor(t,e);var[_,s]=_t();return r.onerror=function(t){s(t.target.error)},r.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await a(e)?s():e.continue():s(null)},await _}catch(t){return rt("[EI] object_store.open_key_cursor: Error:",t),t}}async put(t,e,a=!0,r){try{if(null==e)var _=this.self.put(t);else e.constructor==Y?_=this.self.put(t,e.self):(at(t,e),_=this.self.put(t,e));var[s,n]=_t();return _.onerror=function(t){0==a&&r(t.target.error),n(t.target.error)},_.onsuccess=function(t){0==a&&r(t.target.result),n(t.target.result)},a?await s:void 0}catch(t){return rt("[EI] object_store.put: Error:",t),t}}};console.log,console.warn;var nt=console.error;const ot=class{self=null;constructor(t){this.self=t}#P(){}get Db(){return new lt(this.self.db)}get Durability(){return null==this.self.durability?"none":this.self.durability}get Error(){return this.self.error}get Mode(){return this.self.mode}get Object_Store_Names(){return[...this.self.objectStoreNames]}#L(){}set on_abort(t){this.self.onabort=t}set on_complete(t){this.self.oncomplete=t}set on_error(t){this.self.onerror=t}#E(){}abort(){try{this.self.abort()}catch(t){return nt("[EI] transaction.abort: Error:",t),t}}commit(){try{this.self.commit()}catch(t){return nt("[EI] transaction.commit: Error:",t),t}}object_store(t){try{var e=this.self.objectStore(t);return new st(e)}catch(t){return nt("[EI] transaction.object_store: Error:",t),t}}#M(){}store1(){return this.object_store([...this.self.objectStoreNames][0])}};console.log,console.warn;var it=console.error;const lt=class{self=null;constructor(t){this.self=t}#P(){}get Name(){return this.self.name}get Object_Store_Names(){return[...this.self.objectStoreNames]}get version(){return this.self.version}#L(){}set on_close(t){this.self.onclose=t}set on_version_change(t){this.self.onversionchange=t}#E(){}close(){vt._num_db_cons-=1;var t=this.self.close();return window._num_db_cons--,t}create_object_store(t){try{return new st(this.self.createObjectStore(t,{keyPath:"id",autoIncrement:!0}))}catch(t){return it("[EI] database.create_object_store: Error:",t),t}}delete_object_store(t){try{return this.self.deleteObjectStore(t)}catch(t){return it("[EI] database.delete_object_store: Error:",t),t}}transaction(t,e,a){try{return new ot(this.self.transaction(t,e,a))}catch(t){return it("[EI] database.transaction: Error:",t),t}}};var ct=console.log,ut=console.warn,dt=console.error,ft=a.new_lock;console.log,console.warn,console.error;const yt=class{static keys(){return Object.keys(localStorage)}#H(){}static set(t,e){try{var a=n.obj_to_json(e);localStorage[t]=a}catch(t){return null}}static get(t){try{var e=localStorage[t];return n.json_to_obj_bd(e)}catch(t){return null}}static clear(t){delete localStorage[t]}};console.log,console.warn,console.error;const pt=class{static keys(){return Object.keys(sessionStorage)}#H(){}static set(t,e){try{var a=n.obj_to_json(e);sessionStorage[t]=a}catch(t){return null}}static get(t){try{var e=sessionStorage[t];return n.json_to_obj_bd(e)}catch(t){return null}}static clear(t){delete sessionStorage[t]}};var bt=console.log;console.warn,console.error;class wt{#g(){}static idb;static idbx;static idbxs;static sec;static wcrypto;static utils;#G(){}static n1=1;static n2=2;static u1=3;static u2=4;#v(){}static RO="readonly";static RW="readwrite";#m(){}static Factory;#$(){}#V(){}#X(){}static databases;static open;static delete_database;#q(){}static open_av;static reopen;static num_db_cons;static set_db;static get_prop;static do_op;static del_obj_store;#J(){}static insert_one;static insert_many;static exists;static count;static count_all;static find_one;static find_many;static find_all;static filter;static update_one;static update_many;static upsert_one;static remove_one;static remove_many;static remove_all;#z(){}static set_max_history;static get_op_hist_status;static enable_op_hist;static disable_op_hist;static get_op_hist;static clear_op_hist;#Z(){}static enable_fts;static disable_fts;static find_many_by_terms;#Y(){}static s_open_av;#Q(){}static s_insert_one;static s_insert_many;static s_exists;static s_count;static s_count_all;static s_find_one;static s_find_many;static s_find_all;static s_filter;static s_update_one;static s_update_many;static s_upsert_one;static s_remove_one;static s_remove_many;#tt(){}static s_set_max_history;static s_get_op_hist_status;static s_enable_op_hist;static s_disable_op_hist;static s_get_op_hist;static s_clear_op_hist;#et(){}static s_enable_fts;static s_disable_fts;static s_find_many_by_terms;#at(){}#E(){}static init_essential_globals(t){t&&(window.n1=wt.n1),t&&(window.n2=wt.n2),t&&(window.u1=wt.u1),t&&(window.u2=wt.u2),wt._secure=!0,t&&(window._secure=!0),wt._stop="stop",t&&(window._stop="stop");const e=wt.RO;t&&(window.RO=e);const r=wt.RW;t&&(window.RW=r),wt.WITH_LEFT=!1,t&&(window.WITH_LEFT=!1),wt.WITH_RIGHT=!1,t&&(window.WITH_RIGHT=!1),wt.NO_LEFT=!0,t&&(window.NO_LEFT=!0),wt.NO_RIGHT=!0,t&&(window.NO_RIGHT=!0);const _=t=>new Y(IDBKeyRange.lowerBound(t));wt.range_gte=_,t&&(window.range_gte=_);const s=t=>new Y(IDBKeyRange.lowerBound(t,!0));wt.range_gt=s,t&&(window.range_gt=s);const n=t=>new Y(IDBKeyRange.upperBound(t));wt.range_lte=n,t&&(window.range_lte=n);const o=t=>new Y(IDBKeyRange.upperBound(t,!0));wt.range_lt=o,t&&(window.range_lt=o);const i=(t,e,a,r)=>new Y(IDBKeyRange.bound(t,e,a,r));wt.range_between=i,t&&(window.range_between=i);const l=t=>new Y(IDBKeyRange.only(t));wt.value_is=l,t&&(window.value_is=l);const c=a.new_lock;wt.new_lock=c,t&&(window.new_lock=c);const u=a.stay_idle;wt.stay_idle=u,t&&(window.stay_idle=u),t&&(window.eidb=wt),wt.slocal=yt,wt.ssession=pt,t&&(window.slocal=yt),t&&(window.ssession=pt)}static init_more_globals(t){wt._add="add",t&&(window._add="add");const e="clear";wt._clear=e,t&&(window._clear=e);const a="count";wt._count=a,t&&(window._count=a);const r="create_index";wt._create_index=r,t&&(window._create_index=r);const _="delete";wt._delete=_,t&&(window._delete=_);const s="delete_index";wt._delete_index=s,t&&(window._delete_index=s),wt._get="get",t&&(window._get="get");const n="get_all";wt._get_all=n,t&&(window._get_all=n);const o="get_all_keys";wt._get_all_keys=o,t&&(window._get_all_keys=o);const i="get_key";wt._get_key=i,t&&(window._get_key=i);const l="index";wt._index=l,t&&(window._index=l);const c="open_cursor";wt._open_cursor=c,t&&(window._open_cursor=c);const u="open_key_cursor";wt._open_key_cursor=u,t&&(window._open_key_cursor=u),wt._put="put",t&&(window._put="put")}#n(){}static init(t=!0){wt.idb=r,wt.idbx=z,wt.idbxs=D,wt.sec=D,wt.wcrypto=h,wt.utils=n,wt.idb.init(),wt.idbx.init(),wt.idbxs.init(),wt.wcrypto.init(),wt.utils.init(),gt.init_essential_globals(t),gt.init_more_globals(t),wt.Factory=new class{self=null;constructor(t){this.self=t}#rt(){}async databases(t){try{return null==this.self.databases?((await this.open(t)).close(),[{name:t}]):await this.self.databases()}catch(t){return dt("[EI] factory.databases: Error:",t),t}}async delete_database(t){var e=this.self.deleteDatabase(t),[a,r]=ft();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(null)},await a}async open(t,e){null==window._num_db_cons?window._num_db_cons=1:window._num_db_cons++;try{var a=this.self.open(t,e)}catch(t){return dt("[EI] idb.open: Error caught:",t),t.Status="errored",t}var[r,_]=ft(),s=null,n=null,o=null;a.onerror=function(t){s=t.target.error,_("errored")},a.onblocked=function(t){ut(`[EI] idb.open: Upgrade blocked, requested to change to version ${e}`),ut("[EI] Check source code, shouldn't be blocked by connections in current tab or other tabs."),ut("[EI] Tip: Avoid being blocked by using temporary connections in all tabs together with IDBDatabase.versionchange event."),n=t,_("blocked"),o="blocked"},a.onupgradeneeded=function(t){if(null!=o)return ut(`[EI] idb.open: Upgrade cancelled due to '${o}' event fired right previously`),void _();ct(`[EI] idb.open: Upgrade needed, to version ${e}`),_("to-upgrade"),o="to-upgrade"},a.onsuccess=function(t){if(null!=o)return ut(`[EI] idb.open: Open cancelled due to '${o}' event fired right previously`),void _();_("opened")};var i=await r;if("errored"==i)return s.Status="errored",s;if("blocked"==i){let t=new Error("Upgrade is blocked by other connections, close them all first.");return t.Status="blocked",t.Event=n,t}if("to-upgrade"==i){let t=new lt(a.result);return t.to_upgrade=!0,t.Transaction=new ot(a.transaction),null==vt._num_db_cons?vt._num_db_cons=1:vt._num_db_cons+=1,t}if("opened"==i){let t=new lt(a.result);return t.to_upgrade=!1,null==vt._num_db_cons?vt._num_db_cons=1:vt._num_db_cons+=1,t}}}(window.indexedDB),wt.databases=r.databases,wt.open=r.open,wt.delete_database=r.delete_database,wt.open_av=z.open_av,wt.reopen=z.reopen,wt.num_db_cons=z.num_db_cons,wt.set_db=z.set_db,wt.get_prop=z.get_prop,wt.do_op=z.do_op,wt.del_obj_store=z.del_obj_store,wt.insert_one=z.crud.insert_one,wt.insert_many=z.crud.insert_many,wt.exists=z.crud.exists,wt.count=z.crud.count,wt.count_all=z.crud.count_all,wt.find_one=z.crud.find_one,wt.find_many=z.crud.find_many,wt.find_all=z.crud.find_all,wt.filter=z.crud.filter,wt.update_one=z.crud.update_one,wt.update_many=z.crud.update_many,wt.upsert_one=z.crud.upsert_one,wt.remove_one=z.crud.remove_one,wt.remove_many=z.crud.remove_many,wt.remove_all=z.crud.remove_all,wt.set_max_history=z.op_hist.set_max_history,wt.get_op_hist_status=z.op_hist.get_op_hist_status,wt.enable_op_hist=z.op_hist.enable_op_hist,wt.disable_op_hist=z.op_hist.disable_op_hist,wt.get_op_hist=z.op_hist.get_op_hist,wt.clear_op_hist=z.op_hist.clear_op_hist,wt.enable_fts=z.fts.enable_fts,wt.disable_fts=z.fts.disable_fts,wt.find_many_by_terms=z.fts.find_many_by_terms,wt.s_open_av=D.open_av,wt.s_insert_one=D.cruds.insert_one,wt.s_insert_many=D.cruds.insert_many,wt.s_exists=D.cruds.exists,wt.s_count=D.cruds.count,wt.s_count_all=D.cruds.count_all,wt.s_find_one=D.cruds.find_one,wt.s_find_many=D.cruds.find_many,wt.s_find_all=D.cruds.find_all,wt.s_filter=D.cruds.filter,wt.s_update_one=D.cruds.update_one,wt.s_update_many=D.cruds.update_many,wt.s_upsert_one=D.cruds.upsert_one,wt.s_remove_one=D.cruds.remove_one,wt.s_remove_many=D.cruds.remove_many,wt.s_set_max_history=D.op_hists.set_max_history,wt.s_get_op_hist_status=D.op_hists.get_op_hist_status,wt.s_enable_op_hist=D.op_hists.enable_op_hist,wt.s_disable_op_hist=D.op_hists.disable_op_hist,wt.s_get_op_hist=D.op_hists.get_op_hist,wt.s_clear_op_hist=D.op_hists.clear_op_hist,wt.s_enable_fts=D.ftss.enable_fts,wt.s_disable_fts=D.ftss.disable_fts,wt.s_find_many_by_terms=D.ftss.find_many_by_terms}}var ht=window.location;bt("[EI] EnIndex loaded"),bt("     In web page:",`${ht.protocol}//${ht.host}${ht.pathname}`),bt("     Imported as:",import.meta.url);const gt=wt,vt=gt;var mt=e.Z;export{mt as default};