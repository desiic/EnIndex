var e={d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{Z:()=>ge}),console.log,console.warn,console.error;const r=class{static new_lock(){var e;return[new Promise(((t,r)=>{e=t})),e]}static async stay_idle(e){var t=new Promise(((t,r)=>{setTimeout((()=>{t()}),e)}));await t}};console.log,console.warn,console.error;const a=class{static async databases(){return await ge.Factory.databases()}static async open(e,t){return window._Db_Name=e,await ge.Factory.open(e,t)}static async delete_database(e){return await ge.Factory.delete_database(e)}static init(){}},s=(console.log,console.warn,console.error);class n{static intersect_arrs(e){return e.reduce(((e,t)=>e.filter((e=>t.includes(e)))))}static#e(e){if(e.constructor!=Object)return"";var t="";for(let r in e){let a=e[r];null!=a&&(a.constructor==Object?t+=n.obj_to_valuestr(a):"string"==typeof a&&(t+=a+" "))}return t}static obj_to_valuestr(e){return n.#e(e).trim()}static obj_to_json(e){return JSON.stringify(e)}static json_to_obj_sd(e){return JSON.parse(e)}static json_to_obj_bd(e){return JSON.parse(e,((e,t)=>t.constructor!=String||null==t.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/)?t:new Date(t)))}static prop_set(e,t,r){var a=t.split("."),n=e;if(0!=a.length){if(1==a.length)return e[t]=r,e;for(let t=0;t<a.length;t++){let s=a[t];if(!(t<a.length-1))return n[s]=r,e;null==n[s]&&(n[s]={}),n=n[s]}}else s("[EI] utils.prop_set: Invalid path")}static prop_get(e,t){var r=t.split("."),a=e;if(0!=r.length){if(1==r.length)return e[t];for(let e=0;e<r.length;e++){let t=r[e];if(null==a[t])return null;a=a[t]}return a}s("[EI] utils.prop_get: Invalid path")}static deepcopy(e){return n.json_to_obj_bd(n.obj_to_json(e))}static escape_for_regex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}static init(){}}const o=n;console.log,console.warn;var i=console.error;const _={create:"Recent_Creates",read:"Recent_Reads",update:"Recent_Updates",delete:"Recent_Deletes"};class c{static max_history=1e3;static enabled=!1;static set_max_history(e){history.max_history=e}static get_op_hist_status(){return c.enabled?"enabled":"disabled"}static async enable_op_hist(){c.enabled=!0}static disable_op_hist(){c.enabled=!1}static sort_docmetas_des(e){return e.sort(((e,t)=>e.Timestamp<t.Timestamp?1:e.Timestamp>t.Timestamp?-1:0)),e}static async#e(e,t,r){if(c.enabled&&null!=r&&0!=r.length)if(-1!=["create","read","update","delete"].indexOf(t)){var a=await q.reopen();if(-1!=a.Object_Store_Names.indexOf("op_hist")){var s=a.transaction("op_hist",RW).store1(),n=await s.index("Store_Name").get(value_is(e));if(null==n){let n={Store_Name:e},o=[],i=new Date;for(let e of r)o.length<c.max_history&&o.push({id:e,Timestamp:i});for(let e in _)n[_[e]]=[];return n[_[t]]=o,await s.add(n),void a.close()}var o=n[_[t]],l=o.map((e=>e.id)),u=new Date;for(let e of r)-1==l.indexOf(e)&&o.push({id:e,Timestamp:u});o=(o=c.sort_docmetas_des(o)).slice(0,c.max_history),n[_[t]]=o,await s.put(n),a.close()}else a.close()}else i("[EI] op_hist.update_op_hist: No such operation type:",t)}static update_op_hist_c(e,t){c.#e(e,"create",t)}static update_op_hist_r(e,t){c.#e(e,"read",t)}static update_op_hist_u(e,t){c.#e(e,"update",t)}static update_op_hist_d(e,t){c.#e(e,"delete",t)}static async get_op_hist(e,t){var r=await q.reopen(),a=r.transaction("op_hist",RO).store1(),s=await a.index("Store_Name").get(value_is(e));return r.close(),s}static async clear_op_hist(){var e=await q.reopen();if(e instanceof Error)i("[EI] op_hist.clear_op_hist: Failed to open db, error:",e);else{var t=e.transaction("op_hist",RW).store1();await t.delete(range_gte(0)),e.close()}}static init(){}}const l=c;console.log,console.warn;var u=console.error,d=r.new_lock;const f=new Uint8Array([0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45]),y="000306090c0f1215181b1e2124272a2d";class p{static BIT_LEN=256;static FIXED_IV_BYTES=f;static FIXED_IV=y;static EXTERNAL_LIBS(){}static async get_pubkey_point(e){var[t,r]=d();return setTimeout((()=>{null==window.elliptic&&u("[EI] wcrypto.get_pubkey_point: No Elliptic lib found.")}),3e4),setTimeout((function t(){if(null!=window.elliptic){for(var a=elliptic.ec("p256").keyFromPrivate(e).getPublic(),s=a.getX().toString(16),n=a.getY().toString(16);s.length<64;)s="0"+s;for(;n.length<64;)n="0"+n;r([s,n])}else setTimeout(t,0)}),0),await t}static BASE_FUNCS(){}static get_random_values_unsigned(e,t){if(8==e||16==e||32==e||64==e){if(8==e)var r=new Uint8Array(t);return 16==e&&(r=new Uint16Array(t)),32==e&&(r=new Uint32Array(t)),64==e&&(r=new BigUint64Array(t)),window.crypto.getRandomValues(r),r}u("[EI] wcrypto.get_random_values_unsigned: Bits must be 8, 16, 32, or 64")}static get_random_values_signed(e,t){if(8==e||16==e||32==e||64==e){if(8==e)var r=new Int8Array(t);return 16==e&&(r=new Int16Array(t)),32==e&&(r=new Int32Array(t)),64==e&&(r=new BigInt64Array(t)),window.crypto.getRandomValues(r),r}u("[EI] wcrypto.get_random_values_signed: Bits must be 8, 16, 32, or 64")}static random_iv(){return p.get_random_values_unsigned(8,16)}static random_uuid(){return window.crypto.randomUUID()}static random_uuidx(){return(window.crypto.randomUUID()+window.crypto.randomUUID()).replaceAll("-","")}static UTILS(){}static base64url_to_base64(e){return e.replaceAll("-","+").replaceAll("_","/")}static base64_to_base64url(e){return e.replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}static utf8_to_bytes(e){return(new TextEncoder).encode(e)}static bytes_to_utf8(e){return new TextDecoder("utf-8").decode(e)}static buff_to_bytes(e){return new Uint8Array(e)}static bytes_to_buff(e){return e.buffer}static buff_to_hex(e){return[...new Uint8Array(e)].map((e=>e.toString(16).padStart(2,"0"))).join("")}static hex_to_buff(e){return p.hex_to_bytes(e).buffer}static bytes_to_hex(e){return[...e].map((e=>e.toString(16).padStart(2,"0"))).join("")}static hex_to_bytes(e){var t=new Uint8Array(e.length/2);for(let r=0;r<t.byteLength;r++)t[r]=parseInt(e.substring(2*r,2*r+2),16);return t}static buff_to_base64(e){for(var t=new Uint8Array(e),r=t.byteLength,a="",s=0;s<r;s++)a+=String.fromCharCode(t[s]);return window.btoa(a)}static base64_to_buff(e){var t=window.atob(e),r=new Uint8Array(t.length);for(let e=0;e<r.byteLength;e++)r[e]=t.charCodeAt(e);return r.buffer}static bytes_to_base64(e){var t=e.byteLength,r="";for(let a=0;a<t;a++)r+=String.fromCharCode(e[a]);return window.btoa(r)}static base64_to_bytes(e){var t=window.atob(e),r=new Uint8Array(t.length);for(let e=0;e<r.byteLength;e++)r[e]=t.charCodeAt(e);return r}static base64_to_hex(e){return p.bytes_to_hex(p.base64_to_bytes(e))}static hex_to_base64(e){return p.bytes_to_base64(p.hex_to_bytes(e))}static base64url_to_hex(e){return e=p.base64url_to_base64(e),p.bytes_to_hex(p.base64_to_bytes(e))}static hex_to_base64url(e){var t=p.bytes_to_base64(p.hex_to_bytes(e));return p.base64_to_base64url(t)}static SUBTLE(){}static async digest_sha1(e){var t=p.utf8_to_bytes(e),r=await window.crypto.subtle.digest("SHA-1",t);return this.buff_to_hex(r)}static async digest_sha256(e){var t=p.utf8_to_bytes(e),r=await window.crypto.subtle.digest("SHA-256",t);return this.buff_to_hex(r)}static async generate_key_aes(){return await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}static async generate_key_aes_kw(){return await window.crypto.subtle.generateKey({name:"AES-KW",length:256},!0,["wrapKey","unwrapKey"])}static async generate_keys_rsa_ed(){var e={name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"};return await window.crypto.subtle.generateKey(e,!0,["encrypt","decrypt"])}static async generate_keys_rsa_sv(){var e={name:"RSA-PSS",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"};return await window.crypto.subtle.generateKey(e,!0,["sign","verify"])}static async generate_keys_ec_ed(){}static async generate_keys_ec_sv(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"])}static async import_key_pb_raw(e){var t=p.utf8_to_bytes(e);try{var r=await window.crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveBits","deriveKey"])}catch(e){return u("[EI] wcrypto.import_key_pb_raw: Failed to import, error:",e),null}return r}static async import_key_aes_raw(e){if(64!=e.length)return u("[EI] wcrypto.import_key_raw: Hex of key must be of length 64 chars"),null;var t=p.hex_to_bytes(e);try{var r=await window.crypto.subtle.importKey("raw",t,{name:"AES-GCM"},!0,["encrypt","decrypt"])}catch(e){return u("[EI] wcrypto.import_key_aes_raw: Failed to import, error:",e),null}return r}static async import_key_rsa_jwk(e,t="RSA-PSS"){var r={name:t,hash:"SHA-256"};if("RSA-OAEP"==t)var a=["encrypt","decrypt"];else a=["sign","verify"];try{return await window.crypto.subtle.importKey("jwk",e,r,!0,a)}catch(e){return u("[EI] wcrypto.import_key_rsa_jwk: Failed to import, error:",e),null}}static async import_key_ec_jwk(e,t="ECDSA"){var r={name:t,namedCurve:"P-256"};if(null!=e.d)var a=["sign"];else a=["verify"];try{return await window.crypto.subtle.importKey("jwk",e,r,!0,a)}catch(e){return u("[EI] wcrypto.import_key_ec_jwk: Failed to import, error:",e),null}}static async export_key_hex(e){return p.buff_to_hex(await window.crypto.subtle.exportKey("raw",e))}static async export_key_jwk(e){try{return await window.crypto.subtle.exportKey("jwk",e)}catch(e){return u("[EI] wcrypto.export_key_jwk: Failed to export, error:",e),null}}static async derive_bits_pb(e,t,r,a=256){var s=await p.import_key_pb_raw(e),n={name:"PBKDF2",hash:"SHA-256",salt:p.utf8_to_bytes(t),iterations:r};try{var o=await window.crypto.subtle.deriveBits(n,s,a);return p.buff_to_hex(o)}catch(e){return u("[EI] wcrypto.derive_bits_pb: Failed to derive, error:",e),null}}static async derive_key_pb2aes(e,t,r){var a=await p.import_key_pb_raw(e),s={name:"PBKDF2",hash:"SHA-256",salt:p.utf8_to_bytes(t),iterations:r};try{return await window.crypto.subtle.deriveKey(s,a,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}catch(e){return u("[EI] wcrypto.derive_key_pb2aes: Failed to derive, error:",e),null}}static async derive_keys_pb2rsa(e,t,r){}static async derive_keys_pb2ec(e,t,r){BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff"),BigInt("0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc"),BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"),BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),BigInt("0x01");var a=await p.generate_keys_ec_sv(),s=await p.export_key_jwk(a.privateKey),n=await p.export_key_jwk(a.publicKey),o=e+t;for(let e=0;e<r;e++)o=await p.digest_sha256(o);var[i,_]=await p.get_pubkey_point(o);return o=p.hex_to_base64url(o),i=p.hex_to_base64url(i),_=p.hex_to_base64url(_),s.d=o,s.x=i,s.y=_,n.x=i,n.y=_,{privateKey:await p.import_key_ec_jwk(s,"ECDSA"),publicKey:await p.import_key_ec_jwk(n,"ECDSA")}}static async encrypt_aes(e,t,r=null){if(null==r)var a=p.random_iv();else a=p.hex_to_bytes(r);var s=p.utf8_to_bytes(e),n={name:"AES-GCM",iv:a};try{var o=await window.crypto.subtle.encrypt(n,t,s)}catch(e){return u("[EI] wcrypto.encrypt_aes: Failed to encrypt, error:",e),null}return[p.buff_to_base64(o),p.bytes_to_hex(a)]}static async encrypt_aes_fiv(e,t){return await p.encrypt_aes(e,t,y)}static async encrypt_rsa(e,t){var r=p.utf8_to_bytes(e);try{var a=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},t,r)}catch(e){return u("[EI] wcrypto.encrypt_rsa: Failed to encrypt, error:",e),null}return p.buff_to_base64(a)}static async encrypt_ec(e,t){}static async decrypt_aes(e,t,r){var a=p.base64_to_bytes(e),s={name:"AES-GCM",iv:p.hex_to_bytes(t)};try{var n=await window.crypto.subtle.decrypt(s,r,a)}catch(e){return u("[EI] wcrypto.decrypt_aes: Failed to decrypt, error:",e),null}return p.bytes_to_utf8(new Uint8Array(n))}static async decrypt_aes_fiv(e,t){return await p.decrypt_aes(e,y,t)}static async decrypt_rsa(e,t){var r=p.base64_to_bytes(e);try{var a=await window.crypto.subtle.decrypt({name:"RSA-OAEP"},t,r)}catch(e){return u("[EI] wcrypto.decrypt_rsa: Failed to decrypt, error:",e),null}return p.bytes_to_utf8(new Uint8Array(a))}static async decrypt_ec(e,t){}static async sign(e,t){if("RSA-PSS"==t.algorithm.name)var r={name:"RSA-PSS",saltLength:256};else r={name:"ECDSA",hash:"SHA-256"};var a=p.utf8_to_bytes(e);try{var s=await window.crypto.subtle.sign(r,t,a)}catch(e){return u("[EI] wcrypto.sign: Failed to sign, error:",e),null}return p.buff_to_hex(s)}static async verify(e,t,r){if("RSA-PSS"==r.algorithm.name)var a={name:"RSA-PSS",saltLength:256};else a={name:"ECDSA",hash:"SHA-256"};var s=p.utf8_to_bytes(e),n=p.hex_to_bytes(t);try{return await window.crypto.subtle.verify(a,r,n,s)}catch(e){return u("[EI] wcrypto.verify: Failed to verify, error:",e),null}}static async wrap_key(){}static async unwrap_key(){}static EXTENDED(){}static split_into_2(e){var t=Math.floor(e.length/2);return[e.substring(0,t),e.substring(t)]}static async password2keys(e,t,r){var a=await p.derive_bits_pb(e,t,r,512),[s,n]=p.split_into_2(a);return[await p.derive_key_pb2aes(s,t,r),await p.derive_keys_pb2ec(n,t,r)]}static async make_static_key(e,t){var r=p.random_uuidx();return await p.derive_key_pb2aes(r,e,t)}static init(){}}const b=p,w=(console.log,console.warn,console.error),h=r.new_lock,g=class{static async insert_one(e,t){if(null!=A.Skey){e="#"+e;var r=await A.obj_to_sobj(e,t);return await W.insert_one(e,r,_secure,t)}w("[EI] cruds.insert_one: Static key not set")}static async insert_many(e,t){if(null!=A.Skey){e="#"+e;var r=[];for(let a of t)r.push(await A.obj_to_sobj(e,a));return await W.insert_many(e,r,_secure,t)}w("[EI] cruds.insert_many: Static key not set")}static async get_1stcond_obj(e,t){}static async get_1stcond_objs(e,t){}static async intersect_cond(e,t){}static async intersect_cond_getobjs(e,t){}static async exists(e,t){if(null!=A.Skey){e="#"+e;var r={};for(let e in t)"id"==e?r[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?r[e]=await A.array_to_sarray(t[e]):r[e]=await A.value_to_svalue(t[e]);return await W.exists(e,r,_secure)}w("[EI] cruds.exists: Static key not set")}static async count(e,t){if(null!=A.Skey){e="#"+e;var r={};for(let e in t)"id"==e?r[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?r[e]=await A.array_to_sarray(t[e]):r[e]=await A.value_to_svalue(t[e]);return await W.count(e,r,_secure)}w("[EI] cruds.count: Static key not set")}static async count_all(e){if(null!=A.Skey)return e="#"+e,await W.count_all(e,_secure);w("[EI] cruds.count_all: Static key not set")}static async find_one(e,t){if(null!=A.Skey){e="#"+e;var r={};for(let e in t)"id"==e?r[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?r[e]=await A.array_to_sarray(t[e]):r[e]=await A.value_to_svalue(t[e]);var a=await W.find_one(e,r,_secure);if(null==a)return null;var s=await b.decrypt_aes_fiv(a.Etds_Obj,A.Skey),n=o.json_to_obj_bd(s);return n.id=a.id,n}w("[EI] cruds.find_one: Static key not set")}static async find_many(e,t,r=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){e="#"+e;var a={};for(let e in t)"id"==e?a[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?a[e]=await A.array_to_sarray(t[e]):a[e]=await A.value_to_svalue(t[e]);var s=await W.find_many(e,a,r,_secure),n=[];for(let e of s){var i=await b.decrypt_aes_fiv(e.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_.id=e.id,n.push(_)}return n}w("[EI] cruds.find_many: Static key not set")}static async find_all(e){if(null!=A.Skey){e="#"+e;var t=await W.find_all(e,_secure),r=[];for(let e of t){var a=await b.decrypt_aes_fiv(e.Etds_Obj,A.Skey);if(null!=a){var s=o.json_to_obj_bd(a);s.id=e.id,r.push(s)}}return r}w("[EI] cruds.find_all: Static key not set")}static get_proppath_value(e,t){}static obj_matches_cond(e,t){}static async filter(e,t,r=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){e="#"+e;var a={};for(let e in t)a[e]="id"==e?t[e]:await A.value_to_svalue(t[e]);var s=await W.filter(e,a,r,_secure),n=[];for(let e of s){var i=await b.decrypt_aes_fiv(e.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_.id=e.id,n.push(_)}return n}w("[EI] cruds.filter: Static key not set")}static async update_one(e,t,r){if(null!=A.Skey){e="#"+e;var a=await A.obj_to_sobj_arb(r),s={};for(let e in t)"id"==e?s[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?s[e]=await A.array_to_sarray(t[e]):s[e]=await A.value_to_svalue(t[e]);var n=await W.find_one(e,s,_secure),i=await b.decrypt_aes_fiv(n.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_={..._,...r},i=o.obj_to_json(_),a.Etds_Obj=(await b.encrypt_aes_fiv(i,A.Skey))[0];var c=await W.update_one(e,s,a,_secure,_);return i=await b.decrypt_aes_fiv(c.Etds_Obj,A.Skey),(_=o.json_to_obj_bd(i)).id=c.id,_}w("[EI] cruds.update_one: Static key not set")}static async update_many(e,t,r,a=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){e="#"+e;var s=o.deepcopy(r);delete s.id,r=s;var n=await A.obj_to_sobj_arb(r),i=[],_={};for(let e in t)"id"==e?_[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?_[e]=await A.array_to_sarray(t[e]):_[e]=await A.value_to_svalue(t[e]);var c=await W.find_many(e,_,_secure),l=[];for(let e of c){let t=await b.decrypt_aes_fiv(e.Etds_Obj,A.Skey),a=o.json_to_obj_bd(t);a={...a,...r,id:e.id},t=o.obj_to_json(a),l.push(a);let s=o.deepcopy(n);s.Etds_Obj=(await b.encrypt_aes_fiv(t,A.Skey))[0],i.push(s)}var u=await eidb.reopen(),d=u.transaction(e,RW).store1(),f=0,y=[],[p,g]=h();for(let t=0;t<c.length;t++){let r,a={...c[t],...i[t]};d.put(a,null,r=!1,(r=>{r instanceof Error?(w("[EI] cruds.update_many: Error:",r),y.push(null)):y.push(a),D.update_fts_u(e,l[t].id,l[t]),++f==c.length&&g()}))}await p;var v=[];for(let e of y){let t=await b.decrypt_aes_fiv(e.Etds_Obj,A.Skey),r=o.json_to_obj_bd(t);r.id=e.id,v.push(r)}return u.close(),v}w("[EI] cruds.update_many: Static key not set")}static async upsert_one(e,t,r){if(null!=A.Skey){e="#"+e;var a=await A.obj_to_sobj_arb(r),s={};for(let e in t)"id"==e?s[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?s[e]=await A.array_to_sarray(t[e]):s[e]=await A.value_to_svalue(t[e]);var n=await W.find_one(e,s,_secure),i=await b.decrypt_aes_fiv(n.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);return _={..._,...r},i=o.obj_to_json(_),a.Etds_Obj=(await b.encrypt_aes_fiv(i,A.Skey))[0],await W.upsert_one(e,s,a,_secure,_)}w("[EI] cruds.upsert_one: Static key not set")}static async remove_one(e,t){if(null!=A.Skey){e="#"+e;var r={};for(let e in t)"id"==e?r[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?r[e]=await A.array_to_sarray(t[e]):r[e]=await A.value_to_svalue(t[e]);var a=await W.find_one(e,r,_secure);if(null==a)return null;var s=await b.decrypt_aes_fiv(a.Etds_Obj,A.Skey),n=o.json_to_obj_bd(s);n.id=a.id,await W.remove_one(e,r,_secure,n)}else w("[EI] cruds.remove_one: Static key not set")}static async remove_many(e,t){if(null!=A.Skey){e="#"+e;var r={};for(let e in t)"id"==e?r[e]=t[e]:t[e]instanceof Array&&e.indexOf(",")>=0?r[e]=await A.array_to_sarray(t[e]):r[e]=await A.value_to_svalue(t[e]);var a=[],s=await W.find_many(e,r,_secure);if(null==s||0==s.length)return null;for(let e of s){var n=await b.decrypt_aes_fiv(e.Etds_Obj,A.Skey),i=o.json_to_obj_bd(n);i.id=e.id,a.push(i)}await W.remove_many(e,r,_secure,a)}else w("[EI] cruds.remove_many: Static key not set")}static init(){}};console.log,console.warn,console.error;const v=class{static set_max_history(e){l.set_max_history(e)}static get_op_hist_status(){return l.get_op_hist_status()}static async enable_op_hist(){l.enable_op_hist()}static disable_op_hist(){l.disable_op_hist()}static sort_docmetas_des(e){}static async#e(e,t,r){}static update_op_hist_c(e,t){e="#"+e,l.update_op_hist_c(e,t)}static update_op_hist_r(e,t){e="#"+e,l.update_op_hist_r(e,t)}static update_op_hist_u(e,t){e="#"+e,l.update_op_hist_u(e,t)}static update_op_hist_d(e,t){e="#"+e,l.update_op_hist_d(e,t)}static async get_op_hist(e,t){return e="#"+e,await l.get_op_hist(e,t)}static async clear_op_hist(){await l.clear_op_hist()}static init(){}},m=(console.log,console.warn,console.error),S=class{static enable_fts(){D.enable_fts()}static disable_fts(){D.disable_fts()}static str_to_unique_words(e){}static obj_to_unique_words(e){}static async obj_exists(e,t,r){}static async increase_num_objs(e,t,r){}static async decrease_num_objs(e,t,r){}static async update_fts(e,t,r,a){}static update_fts_c(e,t,r){D.update_fts_c(e,t,r,_secure)}static update_fts_r(e,t,r){}static update_fts_u(e,t,r){D.update_fts_u(e,t,r,_secure)}static update_fts_d(e,t,r){D.update_fts_d(e,t,r,_secure)}static async#e(e,t,r,a){}static#t(e,t){}static async find_many_by_terms(e,t,r=1e3){if(null!=A.Skey){e="#"+e;var a=await D.find_many_by_terms(e,t,r,_secure);for(let e=0;e<a.Items.length;e++){let t=a.Items[e].Object,r=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),s=o.json_to_obj_bd(r);s.id=t.id,a.Items[e]=s}for(let e=0;e<a.Search_Terms.length;e++)a.Search_Terms[e]=await b.decrypt_aes_fiv(a.Search_Terms[e],A.Skey);for(let e=0;e<a.Excluded_Terms.length;e++)a.Excluded_Terms[e]=await b.decrypt_aes_fiv(a.Excluded_Terms[e],A.Skey);return a}m("[EI] ftss.find_many_by_terms: Static key not set")}static init(){}},k=console.log,E=console.warn,x=console.error;var j={Store:"_global",Etde_Skey:null,Etde_Skey_Iv:null,Etdr_Recovery:null,Etdr_Recovery_Iv:null};class I{SUB_NAMESPACES;static cruds;static op_hists;static ftss;CONSTANTS;static ITERATIONS=1e5;PROPERTIES;static Ekey=null;static Akeypair=null;static Skey=null;static Rkey=null;METHODS;static async open_av(e,t){var r=Object.keys(t);for(let e of r)null!=t[e]._secure&&(delete t[e]._secure,t["#"+e]={...t[e]},delete t[e]);return await q.open_av(e,t)}static async value_to_svalue(e){var t;return t=e instanceof Object&&!(e instanceof Date)?o.obj_to_json(e):e instanceof Date?e.toISOString():e.toString(),(await b.encrypt_aes_fiv(t,I.Skey))[0]}static async array_to_sarray(e){var t=[];for(let r of e)t.push(await O.value_to_svalue(r));return t}static async obj_to_sobj(e,t){if(null==I.Skey)return void x("[EI] idbxs.obj_to_sobj: Static key not set");var r=Object.keys(q.Indices[e]);r=r.filter((e=>"id"!=e));let a=[];if(null!=t.id)var s={id:t.id};else s={};for(let e of r){if(e.indexOf(",")>=0){let r=e.split(",");for(let e of r)a.push({Path:e,Value:o.prop_get(t,e)})}else a.push({Path:e,Value:o.prop_get(t,e)});for(let e=0;e<a.length;e++){let t;t=a[e].Value instanceof Object&&!(a[e].Value instanceof Date)?o.obj_to_json(a[e].Value):a[e].Value instanceof Date?a[e].Value.toISOString():a[e].Value.toString();let r=await b.encrypt_aes_fiv(t,I.Skey);a[e].Svalue=r[0]}}for(let e of a){let t=e.Path,r=e.Svalue;s=o.prop_set(s,t,r)}var n=o.obj_to_json(t),i=await b.encrypt_aes_fiv(n,I.Skey);return s.Etds_Obj=i[0],s}static async obj_to_sobj_arb(e){var t={};for(let r in e){let a;a=e[r]instanceof Object&&!(e[r]instanceof Date)?o.obj_to_json(e[r]):e[r]instanceof Date?e[r].toISOString():e[r].toString(),t[r]=(await b.encrypt_aes_fiv(a,I.Skey))[0]}return t}static async#e(e){if(null==e)return null;if(!(e instanceof Object))return(await b.encrypt_aes_fiv(e,I.Skey))[0];if(e instanceof Date)return(await b.encrypt_aes_fiv(e.toISOString(),I.Skey))[0];for(let t in e)e[t]=await I.#e(e[t]);return e}static async obj_to_sobj_arb_rec(e){var t=JSON.parse(JSON.stringify(e));return await I.#e(t)}static set_ea_keys(e,t){I.Ekey=e,I.Akeypair=t}static set_static_key(e){I.Skey=e}static async ensure_global_meta(e){null==await I.load_global_meta(e)&&await e.add(j)}static async load_global_meta(e){var t=e;if(null==e){var r=await eidb.reopen();e=r.transaction("_meta",RO).store1()}var a=await e.index("Store").get(value_is("_global"));return null==t&&r.close(),a}static async update_global_meta(e,t){var r=e;if(null==e){var a=await eidb.reopen();e=a.transaction("_meta",RW).store1()}var s=await I.load_global_meta(e);s={...s,...t},await e.put(s),null==r&&a.close()}static async save_static_key(e,t=!1){if(null!=I.Ekey&&null!=I.Akeypair){var r=await b.export_key_hex(e),a=await b.encrypt_aes(r,I.Ekey),[s,n]=a,o=await eidb.reopen(),i=o.transaction("_meta",RW).store1(),_=await i.index("Store").get(value_is("_global"));if(null==_&&(I.ensure_global_meta(i),_=await i.index("Store").get(value_is("_global"))),null!=_.Etde_Skey&&0==t)return E("[EI] idbxs.set_static_key: Static key exists, no enforcing"),void o.close();_.Etde_Skey=s,_.Etde_Skey_Iv=n,i.put(_),o.close()}else x("[EI] idbxs.set_static_key: Encryption key and auth key pair must exist first, call set_ea_keys")}static async load_static_key(){if(null!=I.Ekey&&null!=I.Akeypair){var e=await eidb.reopen(),t=e.transaction("_meta",RW).store1(),r=await t.index("Store").get(value_is("_global"));if(null==r)return E("[EI] idbxs.get_static_key: Global metadata not set"),await I.ensure_global_meta(t),void e.close();if(null==r.Etde_Skey)return E("[EI] idbxs.get_static_key: No static key in global metadata"),void e.close();var a=r.Etde_Skey,s=r.Etde_Skey_Iv,n=await b.decrypt_aes(a,s,I.Ekey),o=await b.import_key_aes_raw(n);return e.close(),o}x("[EI] idbxs.get_static_key: Encryption key and auth key pair must exist first, call set_ea_keys")}static async prepare_keys(e,t){var r=slocal.get("Ekey_Hex"),a=slocal.get("Akeypriv_Jwk"),s=slocal.get("Akeypub_Jwk"),n=!1;if(null!=r&&null!=a&&null!=s){var o=await b.import_key_aes_raw(r),i={privateKey:_=await b.import_key_ec_jwk(a),publicKey:c=await b.import_key_ec_jwk(s)};I.set_ea_keys(o,i);try{k("[EI] Trying stored keys..."),n=null!=(l=await I.load_static_key())}catch(e){}}if(!n){var[o,i]=await I.get_key_chain(e,t);I.set_ea_keys(o,i);var _=i.privateKey,c=i.publicKey;k("[EI] Trying keys from username and password...");var l=await I.load_static_key()}if(null==l){let t;E("[EI] idbxs.prepare_keys: No static key, creating one..."),l=await I.get_new_static_key(e),await I.save_static_key(l,t=!0)}I.set_static_key(l),slocal.set("Ekey_Hex",await b.export_key_hex(o)),slocal.set("Akeypriv_Jwk",await b.export_key_jwk(_)),slocal.set("Akeypub_Jwk",await b.export_key_jwk(c))}static clear_keys(){slocal.clear("Ekey_Hex"),slocal.clear("Akeypriv_Jwk"),slocal.clear("Akeypub_Jwk")}static async set_user_and_pw(e,t){var r=await I.load_static_key();if(null==r)return new Error("failed-to-load-static-key");I.set_static_key(r);var[a,s]=await I.get_key_chain(e,t);let n;I.set_ea_keys(a,s),await I.save_static_key(r,n=!0)}static async get_key_chain(e,t){e=e.trim(),t=t.trim(),k(`[EI] Creating key chain, ${I.ITERATIONS} iterations`);var r=performance.now(),a=await b.digest_sha256(e),[s,n]=await b.password2keys(t,a,I.ITERATIONS),o=performance.now();return k(`[EI] Key chain made in ${(o-r)/1e3} seconds`),[s,n]}static async get_new_static_key(e){e=e.trim();var t=await b.digest_sha256(e);return await b.make_static_key(t,1e3)}static async gen_recovery_info(e,t){var r=await b.generate_key_aes(),a=await b.export_key_hex(e),s=await b.export_key_jwk(t.privateKey),n=`${a}::${b.base64url_to_hex(s.d)}::${b.base64url_to_hex(s.x)}::${b.base64url_to_hex(s.y)}`,[o,i]=await b.encrypt_aes(n,r);return{Ciphertext:o,Iv:i,Recovery_Key:r}}static async save_recovery_info(e,t){var r=await eidb.reopen(),a=r.transaction("_meta",RW).store1(),s={Etdr_Recovery:e,Etdr_Recovery_Iv:t};await I.update_global_meta(a,s),r.close()}static async recover_key_chain(e,t,r){var a=await b.decrypt_aes(e,t,r);if(null==a)return null;var[s,n,o,i]=a.split("::"),_=await b.import_key_aes_raw(s),c=await b.generate_keys_ec_sv(),l=await b.export_key_jwk(c.privateKey),u=await b.export_key_jwk(c.publicKey);l.d=b.hex_to_base64url(n),l.x=b.hex_to_base64url(o),l.y=b.hex_to_base64url(i),u.x=b.hex_to_base64url(o),u.y=b.hex_to_base64url(i);var d={};return d.privateKey=await b.import_key_ec_jwk(l),d.publicKey=await b.import_key_ec_jwk(u),[_,d]}static async recover_and_set_keys(e){if(e instanceof CryptoKey){var t=await eidb.reopen(),r=t.transaction("_meta",RO).store1(),a=await I.load_global_meta(r);if(null==a)return x("[EI] idbxs.recover_and_set_keys: Bad global metadata:",a),void t.close();var s=a.Etdr_Recovery,n=a.Etdr_Recovery_Iv;if(null==s||null==n)return x("[EI] idbxs.recovery_and_set_keys: No or bad recovery data in global metadata"),void t.close();var[o,i]=await I.recover_key_chain(s,n,e);if(!(null!=o&&null!=i&&o instanceof CryptoKey&&i.privateKey instanceof CryptoKey&&i.publicKey instanceof CryptoKey))return x("[EI] idbxs.recovery_and_set_keys: Failed to recover keys, found:",o,i),void t.close();var _=a.Etde_Skey,c=a.Etde_Skey_Iv,l=await b.decrypt_aes(_,c,o);if(null==l)return x("[EI] idbxs.recovery_and_set_keys: Failed to decrypt for static key"),void t.close();var u=await b.import_key_aes_raw(l);return I.set_ea_keys(o,i),I.set_static_key(u),t.close(),[o,i]}x("[EI] idbxs.recover_and_set_keys: First param is not CryptoKey")}static get_micro_dict(){var e=["a","e","i","o","u","y"],t=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","z"],r=[],a=[];for(let a of t)for(let t of e)r.push(a+t);for(let r of e)for(let e of t)a.push(r+e);var s=[],n=r.length-1;for(let e=0;e<120;e++)e%8==0?s.push(r[e]):e%8==1?s.push(a[e]):e%8==2?s.push(r[e]+r[n-e]):e%8==3?s.push(r[e]+a[e]):e%8==4?s.push(a[e]+r[e]):e%8==5?s.push(a[e]+a[n-e]):e%8==6?s.push(r[e]+a[e]+a[n-e]):e%8==7&&s.push(a[e]+r[e]+r[n-e]);s=Array.from(new Set(s)).sort();var o=[];for(let e of s)o.push(e),o.push(e.split("").reverse().join(""));o=Array.from(new Set(o)).sort();var i=[...o],_=256-o.length;for(let e=0;e<_;e++){let t=Math.floor(o.length/_*e);i.push(o[t]+o[t+1])}return Array.from(new Set(i)).sort()}static#r(e,t){for(let r=0;r<t;r++){let t=[...e.matchAll(/[\s]+/g)].map((e=>e.index)),r=t[Math.floor(Math.random()*t.length)],a=e.split("");a[r]=".",e=a.join("")}return e}static#a(e,t){for(let r=0;r<t;r++){let t=[...e.matchAll(/[\s]+/g)].map((e=>e.index)),r=t[Math.floor(Math.random()*t.length)],a=e.split("");a[r]=",",e=a.join("")}return e}static#t(e){var t=(e=e.replaceAll(",",", ")).split(".");for(let e=0;e<t.length;e++)t[e]=t[e].charAt(0).toUpperCase()+t[e].substring(1);return(e=t.join(". "))+"."}static async key_to_text(e){var t=await b.export_key_hex(e),r=I.get_micro_dict(),a=b.hex_to_bytes(t),s=[];for(let e=0;e<a.byteLength;e++)s.push(r[a[e]]);var n=s.join(" ");return n=I.#r(n,4),n=I.#a(n,8),I.#t(n)}static async text_to_key(e){var t=(e=(e=(e=e.toLowerCase().replaceAll(/[^a-z]+/g," ")).trim()).replaceAll(/[\s]{2,}/g," ")).split(" "),r=I.get_micro_dict(),a=new Uint8Array(32);for(let e of t)if(-1==r.indexOf(e))return void x("[EI] idbxs.text_to_key: Invalid word:",e);for(let e=0;e<t.length;e++){let s=t[e],n=r.indexOf(s);a[e]=n}var s=b.bytes_to_hex(a);return await b.import_key_aes_raw(s)}static init(){I.cruds=g,I.op_hists=v,I.ftss=S,I.cruds.init(),I.op_hists.init(),I.ftss.init()}}const O=I,A=O,N=(console.log,console.warn),T=console.error;class R{static enabled=!1;static score_rate=2;static enable_fts(){R.enabled=!0}static disable_fts(){R.enabled=!1}static str_to_unique_words(e){var t=(e=(e=(e=e.toLowerCase()).replace(/[^0-9A-Za-z_\-]/g," ")).replace(/[\s]{2,}/g," ").trim()).split(" ");return Array.from(new Set(t))}static obj_to_unique_words(e){var t=o.obj_to_valuestr(e);return R.str_to_unique_words(t)}static async obj_exists(e,t,r){var a=e.index(t);return null!=await a.get_key(value_is(r))}static async increase_num_objs(e,t,r){var a=await e.index("Store,Word").get(value_is([t,r]));a.num_obj_ids++,await e.put(a)}static async decrease_num_objs(e,t,r){var a=await e.index("Store,Word").get(value_is([t,r]));a.num_obj_ids>0&&a.num_obj_ids--,a.num_obj_ids>0?await e.put(a):await e.delete(value_is(a.id))}static async update_fts(e,t,r,a,s=!1){if(-1!=["create","update","delete"].indexOf(e)){if(s)var n="#fts_words",o="#fts_ids";else n="fts_words",o="fts_ids";var i=R.obj_to_unique_words(a);if(s)for(let e=0;e<i.length;e++){let t=(await b.encrypt_aes_fiv(i[e],A.Skey))[0];i[e]=t}var _=await q.reopen(),c=_.transaction([n,o],RW),l=c.object_store(n),u=c.object_store(o);for(let a of i)await R.obj_exists(l,"Store,Word",[t,a])||await l.add({Store:t,Word:a,num_obj_ids:0}),"create"==e?(await u.add({Store:t,Word:a,obj_id:r}),await R.increase_num_objs(l,t,a)):"update"==e?await R.obj_exists(u,"Store,Word,obj_id",[t,a,r])||(await u.add({Store:t,Word:a,obj_id:r}),await R.increase_num_objs(l,t,a)):(await u.index("Store,Word,obj_id").delete(value_is([t,a,r])),await R.decrease_num_objs(l,t,a));var d=await u.index("Store,obj_id").get_all(value_is([t,r])),f=(d=d.map((e=>e.Word))).filter((e=>-1==i.indexOf(e)));for(let e of f)await u.index("Store,Word,obj_id").delete(value_is([t,e,r])),await R.decrease_num_objs(l,t,e);_.close()}else T("[EI] fts.update_fts: Bad operation:",e)}static update_fts_c(e,t,r,a=!1){R.enabled&&R.update_fts("create",e,t,r,a)}static update_fts_r(e,t,r,a=!1){}static update_fts_u(e,t,r,a=!1){R.enabled&&R.update_fts("update",e,t,r,a)}static update_fts_d(e,t,r,a=!1){R.enabled&&R.update_fts("delete",e,t,r,a)}static async#r(e,t,r,a){var s=t.Name,n=[];await e.index("Store,Word").open_cursor(value_is([s,r]),"next",(e=>{if(n.push(e.value.obj_id),n.length>=a)return _stop}));var o=[];for(let e of n){let r=await t.get(value_is(e));null!=r?o.push(r):N("[EI] fts.#term_to_objs: Found bad id:",e)}return o}static#e(e,t){var r=[],a={},s=1;for(let e=t.length-1;e>=0;e--)a[t[e]]=s,s<Number.MAX_SAFE_INTEGER/R.score_rate&&(s*=R.score_rate);for(let s of e){let e={Object:s,score:0},n=o.obj_to_valuestr(s).toLowerCase(),i=0;for(let e of t){let t=o.escape_for_regex(e);i+=a[e]*(n.match(new RegExp(t,"g"))||[]).length}e.score=i,r.push(e)}return r.sort(((e,t)=>t.score-e.score))}static async find_many_by_terms(e,t,r=1e3,a=!1){if(0==R.enabled&&N("[EI] fts.find_many_by_terms: FTS is disabled, there might be results but no changes."),a)var s="#fts_words",n="#fts_ids";else s="fts_words",n="fts_ids";var o=R.str_to_unique_words(t);if(a)for(let e=0;e<o.length;e++)o[e]=(await b.encrypt_aes_fiv(o[e],A.Skey))[0];var i=await eidb.reopen(),_=i.transaction([s,n,e],RO),c=_.object_store(s),l=_.object_store(n),u=_.object_store(e),d=[],f=[];for(let t of o){let r=await c.index("Store,Word").get(value_is([e,t]));if(null==r){d.push(t);continue}let a={Term:t,exists:!0,size:r.num_obj_ids};f.push(a)}var y="More specific terms are listed first in Search_Terms; higher score items are listed first.";if(0==f.length)return{Items:[],Search_Terms:[],Excluded_Terms:d,Note:y};if(1==f.length){let e=f[0].Term,t=await R.#r(l,u,e,r);return{Items:R.#e(t,[e]),Search_Terms:[e],Excluded_Terms:d,Note:y}}var p=(f=f.sort(((e,t)=>e.size-t.size))).map((e=>e.Term)),w=f[0].Term,h=f.slice(1).map((e=>e.Term)),g=[];await l.index("Store,Word").open_cursor(value_is([e,w]),"next",(async t=>{var r=t.value.obj_id,a=!0;for(let t of h)if(0==await l.index("Store,Word,obj_id").count(value_is([e,t,r]))){a=!1;break}a&&g.push(r)}));var v=[];for(let e of g){let t=await u.get(value_is(e));null!=t?v.push(t):N("[EI] fts.find_many_by_terms: Found bad id:",e)}var m=R.#e(v,p);return i.close(),{Items:m,Search_Terms:p,Excluded_Terms:d,Note:y}}static init(){}}const D=R;console.log,console.warn;var K=console.error,C=r.new_lock,U=(JSON.parse,JSON.stringify);class F{static async insert_one(e,t,r=!1,a=null){var s=await eidb.reopen(),n=s.transaction(e,RW).store1(),o={...t};delete o.id;var i=await n.add(o);return i instanceof Error?(K("[EI] crud.insert_one: Failed, error:",i),null==n&&s.close(),null):(l.update_op_hist_c(n.Name,[i]),r?S.update_fts_c(n.Name,i,a):D.update_fts_c(n.Name,i,t),null==n&&s.close(),i)}static async insert_many(e,t,r=!1,a=null){var s=await eidb.reopen(),n=s.transaction(e,RW).store1(),o=[],[i,_]=C();if(null==t||0==t.length)return s.close(),[];for(let e of t){let r={...e};delete r.id;let a=n.self.add(r);a.onerror=e=>{K("[EI] crud.insert_many: Failed to add object, error:",e.target.error),o.push(null),o.length==t.length&&_()},a.onsuccess=e=>{o.push(e.target.result),o.length==t.length&&_()}}await i;for(let e=0;e<o.length;e++)r?S.update_fts_c(n.Name,o[e],a[e]):D.update_fts_c(n.Name,o[e],t[e]);return s.close(),o}static async get_1stcond_obj(e,t){var r=Object.keys(t),a=e.index(r[0]);if(a instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",e.Name,"/",r[0]),null;var s=t[r[0]];return await a.get(s)}static async get_1stcond_objs(e,t){var r=Object.keys(t),a=e.index(r[0]);if(a instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",e.Name,"/",r[0]),null;var s=t[r[0]];return await a.get_all(s)}static async intersect_cond(e,t){var r=Object.keys(t);if(0==r.length)return[];var a=[];for(let s of r){let r=e.index(s);if(r instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",e.Name,"/",s),null;let n=t[s],o=(await r.get_all(n)).map((e=>e.id));a.push(o)}return o.intersect_arrs(a)}static async intersect_cond_getobjs(e,t){var r=Object.keys(t);if(0==r.length)return[];var a=[],s={};for(let n of r){let r=e.index(n);if(r instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",e.Name,"/",n),null;let o=t[n],i=(await r.get_all(o)).map((e=>(s[e.id]=e,e.id)));a.push(i)}return o.intersect_arrs(a).map((e=>s[e]))}static async exists(e,t,r=!1){var a=await eidb.reopen(),s=a.transaction(e,RO).store1(),n=Object.keys(t);if(0==n.length)return a.close(),[];if(1==n.length){let e=await F.get_1stcond_obj(s,t);return a.close(),null!=e}var o=await F.intersect_cond(s,t);return a.close(),o.length>0}static async count(e,t,r=!1){var a=await eidb.reopen(),s=a.transaction(e,RO).store1(),n=Object.keys(t);if(0==n.length)return a.close(),null;if(1==n.length){let e=await F.get_1stcond_objs(s,t);return a.close(),e.length}var o=await F.intersect_cond(s,t);return a.close(),o.length}static async count_all(e,t=!1){var r=await eidb.reopen(),a=r.transaction(e,RO).store1(),s=await a.count();return r.close(),s}static async find_one(e,t,r=!1){var a=await eidb.reopen(),s=a.transaction(e,RO).store1(),n=Object.keys(t);if(0==n.length)return a.close(),null;if(1==n.length){let e=await F.get_1stcond_obj(s,t);return null==e?(a.close(),null):(l.update_op_hist_r(s.Name,[e.id]),a.close(),e)}var o=await F.intersect_cond(s,t);if(0==o.length)return a.close(),null;var i=await s.get(value_is(o[0]));return l.update_op_hist_r(s.Name,o),a.close(),i}static async find_many(e,t,r=Number.MAX_SAFE_INTEGER,a=!1){var s=await eidb.reopen(),n=s.transaction(e,RO).store1(),o=Object.keys(t);if(0==o.length)return s.close(),null;if(1==o.length){let e=await F.get_1stcond_objs(n,t);return s.close(),e}var i=await F.intersect_cond(n,t);if(null==i||0==i.length)return s.close(),[];var _=[],[c,l]=C();for(let e of i){let t=n.self.get(value_is(e).self);t.onerror=e=>{_.push(null),_.length==i.length&&l(),_.length>=r&&l()},t.onsuccess=e=>{_.push(e.target.result),_.length==i.length&&l(),_.length>=r&&l()}}return await c,s.close(),_}static async find_all(e,t=!1){var r=await eidb.reopen(),a=r.transaction(e,RO).store1(),s=await a.get_all();return r.close(),s}static get_proppath_value(e,t){var r=t.split("."),a=e;for(let e of r){if(null==a[e])return null;a=a[e]}return a}static obj_matches_cond(e,t){for(let r in t){let a=t[r],s=F.get_proppath_value(e,r);if(null==s)return!1;if(-1==U(s).indexOf(a))return!1}return!0}static async filter(e,t,r=Number.MAX_SAFE_INTEGER,a=!1){var s=await eidb.reopen(),n=s.transaction(e,RO).store1(),o=[];return await n.open_cursor(range_gte(0),"next",(e=>{var a=e.value;if(F.obj_matches_cond(a,t)&&o.push(a),o.length>=r)return _stop})),s.close(),o}static async update_one(e,t,r,a=!1,s=null){var n=await eidb.reopen(),o=n.transaction(e,RW).store1(),i=Object.keys(t);if(0==i.length)return n.close(),null;let _={...r};if(delete _.id,1==i.length){let e=await F.get_1stcond_obj(o,t);return null==e?(n.close(),null):(e={...e,..._},o.put(e),l.update_op_hist_u(o.Name,[e.id]),a?S.update_fts_u(o.Name,e.id,s):D.update_fts_u(o.Name,e.id,e),n.close(),e)}var c=await F.intersect_cond(o,t);if(null==c||0==c.length)return n.close(),null;var u=await o.get(value_is(c[0]));return null==u?(n.close(),null):(u={...u,..._},await o.put(u),l.update_op_hist_u(o.Name,[u.id]),a?S.update_fts_u(o.Name,u.id,u):D.update_fts_u(o.Name,u.id,u),n.close(),u)}static async update_many(e,t,r,a=Number.MAX_SAFE_INTEGER,s=!1){var n=await eidb.reopen(),o=n.transaction(e,RW).store1(),i=Object.keys(t);if(0==i.length)return n.close(),null;let _={...r};if(delete _.id,1==i.length){if(null==(c=await F.get_1stcond_objs(o,t)))return n.close(),null;if(0==c.length)return n.close(),[]}else{var c;if(null==(c=await F.intersect_cond_getobjs(o,t)))return n.close(),null;if(0==c.length)return n.close(),[]}let l=[],[u,d]=C();for(let e of c){let t={...e,..._},r=o.self.put(t);r.onerror=t=>{K("[EI] crud.update_many: Failed to update object:",e),l.push(null),l.length==c.length&&d(),l.length>=a&&d()},r.onsuccess=e=>{l.push({...t,id:e.target.result}),l.length==c.length&&d(),l.length>=a&&d()}}await u;for(let e=0;e<l.length;e++)s||D.update_fts_u(o.Name,l[e].id,l[e]);return n.close(),l}static async upsert_one(e,t,r,a=!1,s=null){var n=await eidb.reopen(),o=n.transaction(e,RW).store1(),i=Object.keys(t);if(0==i.length)return n.close(),null;let _={...r};if(delete _.id,1==i.length){let e=await F.get_1stcond_obj(o,t);if(null==e){let e=await o.add(_);return l.update_op_hist_c(o.Name,[e]),a?S.update_fts_c(o.Name,e,s):D.update_fts_c(o.Name,e,r),n.close(),e}return e={...e,..._},o.put(e),l.update_op_hist_u(o.Name,[e.id]),a?S.update_fts_u(o.Name,e.id,s):D.update_fts_u(o.Name,e.id,e),n.close(),e.id}var c=await F.intersect_cond(o,t);if(null==c||0==c.length)return n.close(),null;var u=await o.get(value_is(c[0]));if(null==u){let e=await o.add(_);return l.update_op_hist_c(o.Name,[e]),a?S.update_fts_c(o.Name,e,s):D.update_fts_c(o.Name,e,r),n.close(),e}return u={...u,..._},o.put(u),l.update_op_hist_u(o.Name,[u.id]),a?S.update_fts_u(o.Name,u.id,s):D.update_fts_u(o.Name,u.id,u),n.close(),u.id}static async remove_one(e,t,r=!1,a=null){var s=await eidb.reopen(),n=s.transaction(e,RW).store1(),o=Object.keys(t);if(0==o.length)return s.close(),null;if(1==o.length){let e=await F.get_1stcond_obj(n,t);if(null==e)return s.close(),null;let o=await n.delete(value_is(e.id));return l.update_op_hist_d(n.Name,[e.id]),r?S.update_fts_d(n.Name,e.id,a):D.update_fts_d(n.Name,e.id,e),s.close(),o}var i=await F.intersect_cond_getobjs(n,t),_=i.map((e=>e.id));if(null==_||0==_.length)return s.close(),null;var c=await n.delete(value_is(_[0]));return l.update_op_hist_d(n.Name,[_[0]]),r?S.update_fts_d(n.Name,_[0],a):D.update_fts_d(n.Name,_[0],i[0]),s.close(),c}static async remove_many(e,t,r=!1,a=null){var s=await eidb.reopen(),n=s.transaction(e,RW).store1(),o=Object.keys(t);if(0==o.length)return s.close(),null;var i=[],_=[];if(1==o.length){if(i=await F.get_1stcond_objs(n,t),_=i.map((e=>e.id)),null==i||0==i.length)return s.close(),null}else if(i=await F.intersect_cond_getobjs(n,t),null==(_=i.map((e=>e.id)))||0==_.length)return s.close(),null;var[c,l]=C(),u=0;for(let e of _){let t=n.self.delete(value_is(e).self);t.onerror=e=>{++u==_.length&&l()},t.onsuccess=e=>{++u==_.length&&l()}}await c;for(let e=0;e<_.length;e++)r?S.update_fts_d(n.Name,_[e],a[e]):D.update_fts_d(n.Name,_[e],i[e]);return s.close(),null}static init(){}}const W=F;var P=console.log,B=(console.warn,console.error),M=JSON.stringify,H=JSON.parse,L={_meta:{Store:3},op_hist:{Store_Name:1},"#op_hist":{},fts_words:{Store:1,Word:1,"Store,Word":3,num_obj_ids:1},fts_ids:{Store:1,Word:1,"Store,Word":1,obj_id:1,"Store,obj_id":1,"Store,Word,obj_id":3},"#fts_words":{Store:1,Word:1,"Store,Word":3,num_obj_ids:1},"#fts_ids":{Store:1,Word:1,"Store,Word":1,obj_id:1,"Store,obj_id":1,"Store,Word,obj_id":3}};class ${SUB_NAMESPACES;static crud;static op_hist;static fts;PROPERTIES;static Indices={};METHODS;static#r(e,t){return null!=localStorage.Unused_Stores&&0!=localStorage.Unused_Stores.trim().length&&-1!=e.Object_Store_Names.indexOf(t)&&H(localStorage.Unused_Stores).indexOf(t)>=0}static#e(e){if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)return!1;var t=e.Object_Store_Names,r=H(localStorage.Unused_Stores),a=[];for(let e of r)t.indexOf(e)>=0&&a.push(e);localStorage.Unused_Stores=M(a)}static#s(e,t){if("add"==e)if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)localStorage.Unused_Stores=M([t]);else{let e=H(localStorage.Unused_Stores);e=Array.from(new Set([...e,t])),localStorage.Unused_Stores=M(e)}else if("remove"==e)if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)localStorage.Unused_Stores=M([]);else{let e=H(localStorage.Unused_Stores),r=e.indexOf(t);r>=0&&e.splice(r,1),localStorage.Unused_Stores=M(e)}}static indexname_to_keypath(e){return e.indexOf(",")>=0?e.split(","):e}static keypath_to_indexname(e){return e.constructor===Array?e.join(","):e}static async db_exists(e){return-1!=(await a.databases()).map((e=>e.name)).indexOf(e)}static async get_cur_indices(e){if(!await G.db_exists(e))return{};var t=await a.open(e),r={},s=t.transaction(t.Object_Store_Names,RO);for(let e of t.Object_Store_Names){if($.#r(t,e))continue;let a=s.object_store(e);r[e]={};for(let t of a.Index_Names){let s=a.index(t),o=s.Key_Path;var n=$.keypath_to_indexname(o);let i,_=s.unique,c=s.multientry;0==_&&0==c?i=1:0==_&&1==c?i=2:1==_&&0==c?i=3:1==_&&1==c&&(i=4),r[e][n]=i}}return t.close(),r}static add_more_indices(e){return{...e,...L}}static indices2str(e){var t=[];for(let r in e)for(let a in e[r]){let s=e[r][a];t.push(`${r}/${a}:${s};`)}return t.sort(),t.join("")}static async get_cur_db_ver(e){var t=await a.open(e),r=t.version;return t.close(),r}static async upgrade_db(e,t,r){if(await G.db_exists(e))var s=await $.get_cur_db_ver(e)+1;else s=1;P("[EI] idbx.upgrade_db: Upgrading to version",s);var n=await a.open(e,s),o=Object.keys(t),i=Object.keys(r),_=[];for(let e of o)-1==i.indexOf(e)&&_.push(e);for(let e of _)P("[EI] idbx.upgrade_db: Found unused store:",e),$.#s("add",e);var c=[];for(let e of i)-1==o.indexOf(e)&&($.#r(n,e)?(t[e]={},$.#s("remove",e)):c.push(e));for(let e of c){P("[EI] idbx.upgrade_db: Creating new store:",e);let t=n.create_object_store(e);for(let a in r[e]){let s=r[e][a],n=$.indexname_to_keypath(a);P("[EI] idbx.upgrade_db: Creating new index:",e,"/",a),t.create_index(a,n,s)}}var l=[],u=Array.from(new Set([...o,...i]));for(let e of u)-1==_.indexOf(e)&&-1==c.indexOf(e)&&l.push(e);var d=n.Transaction;for(let e of l){let a=d.object_store(e),s=Object.keys(t[e]),n=Object.keys(r[e]),o=[],i=[];for(let t of s)-1==n.indexOf(t)&&(P("[EI] idbx.upgrade_db: Deleting unused index:",e,"/",t),a.delete_index(t),o.push(t));for(let t of n)if(-1==s.indexOf(t)){let s=r[e][t],n=$.indexname_to_keypath(t);P("[EI] idbx.upgrade_db: Creating new index:",e,"/",t),a.create_index(t,n,s),i.push(t)}let _=[],c=Array.from(new Set([...s,...n]));for(let e of c)-1==o.indexOf(e)&&-1==i.indexOf(e)&&_.push(e);for(let s of _)if(r[e][s]!=t[e][s]){let t=r[e][s],n=$.indexname_to_keypath(s);P("[EI] idbx.upgrade_db: Updating index to new type:",e,"/",s+":"+t),a.delete_index(s),a.create_index(s,n,t)}}n.close()}static async open_av(e,t){if(null!=e){if(null!=t){t=$.add_more_indices(t);for(let e in t)t[e].id=3;$.Indices=t;var r=(await a.databases()).map((e=>e.name));window._Db_Name=e;var s=t;if(r.indexOf(e)>=0)var n=await $.get_cur_indices(e);else n={};var o=$.indices2str(n);if($.indices2str(s)==o)return await a.open(e);await $.upgrade_db(e,n,s);var i=await a.open(e);return $.#e(i),i}B("[EI] idbx.open_av: Indices name cannot be null")}else B("[EI] idbx.open_av: Db name cannot be null")}static async reopen(){return await a.open(window._Db_Name)}static num_db_cons(){return window._num_db_cons}static set_db(e){window._Db_Name=e}static async get_prop(e,t){if(null!=window._Db_Name&&0!=window._Db_Name.trim().length)return(await a.open(window._Db_Name)).transaction(e,RW).store1()[t];B("[EI] idbx.get_prop: Call 'idb.open', 'idbx.open_av', or 'idbx.set_db' first")}static async do_op(e,t,...r){if(null!=window._Db_Name&&0!=window._Db_Name.trim().length){var s=(await a.open(window._Db_Name)).transaction(e,RW).store1();return await s[t](...r)}B("[EI] idbx.do_op: Call 'idb.open', 'idbx.open_av', or 'idbx.set_db' first")}static async del_obj_store(e,t){var r=await $.get_cur_db_ver(e)+1,s=await a.open(e,r);s instanceof Error?B(`[EI] idbx.del_obj_store: Failed to delete object store '${t}' in db '${e}', error:`,s):(await s.delete_object_store(t),$.#s("remove",t),s.close())}static init(){$.crud=W,$.op_hist=l,$.fts=D,$.crud.init(),$.op_hist.init(),$.fts.init()}}const G=$,q=G;console.log,console.warn;var J=console.error;const V=class{self=null;constructor(e){this.self=e}SETS_AND_GETS;get Lower(){return this.self.lower}get Lower_Open(){return this.self.lowerOpen}get Upper(){return this.self.upper}get Upper_Open(){return this.self.upperOpen}METHODS;includes(e){try{return this.self.includes(e.self)}catch(e){return J("[EI] key_range.includes: Error:",e),e}}};console.log,console.warn,console.error,console.log,console.warn;var X=console.error;const z=r.new_lock,Z=class{self=null;constructor(e){this.self=e}SETS_AND_GETS;get Key_Path(){return this.self.keyPath}get multientry(){return this.self.multiEntry}get Name(){return this.self.name}get Object_Store(){return new te(this.self.objectStore)}get unique(){return this.self.unique}METHODS;async count(e){try{if(null==e)var t=this.self.count();else t=e.constructor==V?this.self.count(e.self):this.self.count(e);var[r,a]=z();return t.onerror=e=>{a(e.target.error)},t.onsuccess=e=>{a(e.target.result)},await r}catch(e){return X("[EI] index.count: Error:",e),e}}async get(e){try{if(null==e)var t=this.self.get();else t=e.constructor==V?this.self.get(e.self):this.self.get(e);var[r,a]=z();return t.onerror=e=>{a(e.target.error)},t.onsuccess=e=>{a(e.target.result)},await r}catch(e){return X("[EI] index.get: Error:",e),e}}async get_all(e,t){try{if(null==e)var r=this.self.getAll();else r=e.constructor==V?this.self.getAll(e.self,t):this.self.getAll(e,t);var[a,s]=z();return r.onerror=e=>{s(e.target.error)},r.onsuccess=e=>{s(e.target.result)},await a}catch(e){return X("[EI] index.get_all: Error:",e),e}}async get_all_keys(e,t){try{if(null==e)var r=this.self.getAllKeys();else r=e.constructor==V?this.self.getAllKeys(e.self,t):this.self.getAllKeys(e,t);var[a,s]=z();return r.onerror=e=>{s(e.target.error)},r.onsuccess=e=>{s(e.target.result)},await a}catch(e){return X("[EI] index.get_all_keys: Error:",e),e}}async get_key(e){try{if(null==e)var t=this.self.getKey();else t=e.constructor==V?this.self.getKey(e.self):this.self.getKey(e);var[r,a]=z();return t.onerror=e=>{a(e.target.error)},t.onsuccess=e=>{a(e.target.result)},await r}catch(e){return X("[EI] index.get_key: Error:",e),e}}async open_cursor(e,t="next",r){try{if(null==e)var a=this.self.openCursor();else a=e.constructor==V?this.self.openCursor(e.self,t):this.self.openCursor(e,t);var[s,n]=z();return a.onerror=function(e){n(e.target.error)},a.onsuccess=async function(e){var t=e.target.result;null!=t?"stop"==await r(t)?n():t.continue():n(null)},await s}catch(e){return X("[EI] index.open_cursor: Error:",e),e}}async open_key_cursor(e,t="next",r){try{if(null==e)var a=this.self.openCursor();else a=e.constructor==V?this.self.openCursor(e.self,t):this.self.openCursor(e,t);var[s,n]=z();return a.onerror=function(e){n(e.target.error)},a.onsuccess=async function(e){var t=e.target.result;null!=t?"stop"==await r(t)?n():t.continue():n(null)},await s}catch(e){return X("[EI] index.open_key_cursor: Error:",e),e}}EXTENDED_METHODS(){}async delete(e){var t=0;return await this.open_cursor(e,"next",(e=>{e.delete(),t++})),t}};var Y=console.log,Q=(console.warn,console.error),ee=r.new_lock;const te=class{self=null;constructor(e){this.self=e}SETS_AND_GETS;get auto_increment(){return this.self.autoIncrement}get Index_Names(){return[...this.self.indexNames]}get Key_Path(){return this.self.keyPath}get Name(){return this.self.name}get Transaction(){return new ae(this.self.transaction)}METHODS;async add(e){try{var t=this.self.add(e),[r,a]=ee();return t.onerror=function(e){a(e.target.error)},t.onsuccess=function(e){a(e.target.result)},await r}catch(e){return Q("[EI] object_store.add: Error:",e),e}}async clear(){try{var e=this.self.clear(),[t,r]=ee();return e.onerror=function(e){r(e.target.error)},e.onsuccess=function(e){r(e.target.result)},await t}catch(e){return Q("[EI] object_store.clear: Error:",e),e}}async count(e){try{if(null==e)var t=this.self.count();else t=e.constructor==V?this.self.count(e.self):this.self.count(e);var[r,a]=ee();return t.onerror=function(e){a(e.target.error)},t.onsuccess=function(e){a(e.target.result)},await r}catch(e){return Q("[EI] object_store.count: Error:",e),e}}create_index(e,t,r){try{if(r==n1)var a={unique:!1,multiEntry:!1};else r==n2?a={unique:!1,multiEntry:!0}:r==u1?a={unique:!0,multiEntry:!1}:r==u2&&(a={unique:!0,multiEntry:!0});return new Z(this.self.createIndex(e,t,a))}catch(e){return Q("[EI] object_store.create_index: Error:",e),e}}async delete(e){try{if(e.constructor==V)var t=this.self.delete(e.self);else t=this.self.delete(e);var[r,a]=ee();return t.onerror=function(e){a(e.target.error)},t.onsuccess=function(e){a(e.target.result)},await r}catch(e){return Q("[EI] object_store.delete: Error:",e),e}}delete_index(e){try{this.self.deleteIndex(e)}catch(e){return Q("[EI] object_store.delete_index: Error:",e),e}}async get(e){try{if(null==e)var t=this.self.get();else t=e.constructor==V?this.self.get(e.self):this.self.get(e);var[r,a]=ee();return t.onerror=function(e){a(e.target.error)},t.onsuccess=function(e){a(e.target.result)},await r}catch(e){return Q("[EI] object_store.get: Error:",e),e}}async get_all(e){try{if(null==e)var t=this.self.getAll();else t=e.constructor==V?this.self.getAll(e.self):this.self.getAll(e);var[r,a]=ee();return t.onerror=function(e){a(e.target.error)},t.onsuccess=function(e){a(e.target.result)},await r}catch(e){return Q("[EI] object_store.get_all: Error:",e),e}}async get_all_keys(e,t){try{if(null==e)var r=this.self.getAllKeys();else r=e.constructor==V?this.self.getAllKeys(e.self,t):this.self.getAllKeys(e,t);var[a,s]=ee();return r.onerror=function(e){s(e.target.error)},r.onsuccess=function(e){s(e.target.result)},await a}catch(e){return Q("[EI] object_store.get_all_keys: Error:",e),e}}async get_key(e){try{if(null==e)var t=this.self.getKey();else t=e.constructor==V?this.self.getKey(e.self):this.self.getKey(e);var[r,a]=ee();return t.onerror=function(e){a(e.target.error)},t.onsuccess=function(e){a(e.target.result)},await r}catch(e){return Q("[EI] object_store.get_key: Error:",e),e}}index(e){try{return new Z(this.self.index(e))}catch(e){return Q("[EI] object_store.index: Error:",e),e}}async open_cursor(e,t="next",r){try{if(null==e)var a=this.self.openCursor();else a=e.constructor==V?this.self.openCursor(e.self,t):this.self.openCursor(e,t);var[s,n]=ee();return a.onerror=function(e){n(e.target.error)},a.onsuccess=async function(e){var t=e.target.result;null!=t?"stop"==await r(t)?n():t.continue():n(null)},await s}catch(e){return Q("[EI] object_store.open_cursor: Error:",e),e}}async open_key_cursor(e,t="next",r){try{if(null==e)var a=this.self.openKeyCursor();else a=e.constructor==V?this.self.openKeyCursor(e.self,t):this.self.openKeyCursor(e,t);var[s,n]=ee();return a.onerror=function(e){n(e.target.error)},a.onsuccess=async function(e){var t=e.target.result;null!=t?"stop"==await r(t)?n():t.continue():n(null)},await s}catch(e){return Q("[EI] object_store.open_key_cursor: Error:",e),e}}async put(e,t,r=!0,a){try{if(null==t)var s=this.self.put(e);else t.constructor==V?s=this.self.put(e,t.self):(Y(e,t),s=this.self.put(e,t));var[n,o]=ee();return s.onerror=function(e){0==r&&a(e.target.error),o(e.target.error)},s.onsuccess=function(e){0==r&&a(e.target.result),o(e.target.result)},r?await n:void 0}catch(e){return Q("[EI] object_store.put: Error:",e),e}}};console.log,console.warn;var re=console.error;const ae=class{self=null;constructor(e){this.self=e}SETS_AND_GETS;get Db(){return new ne(this.self.db)}get Durability(){return this.self.durability}get Error(){return this.self.error}get Mode(){return this.self.mode}get Object_Store_Names(){return[...this.self.objectStoreNames]}EVENTS;set on_abort(e){this.self.onabort=e}set on_complete(e){this.self.oncomplete=e}set on_error(e){this.self.onerror=e}METHODS;abort(){try{this.self.abort()}catch(e){return re("[EI] transaction.abort: Error:",e),e}}commit(){try{this.self.commit()}catch(e){return re("[EI] transaction.commit: Error:",e),e}}object_store(e){try{var t=this.self.objectStore(e);return new te(t)}catch(e){return re("[EI] transaction.object_store: Error:",e),e}}ADDITIONAL_METHODS;store1(){return this.object_store([...this.self.objectStoreNames][0])}};console.log,console.warn;var se=console.error;const ne=class{self=null;constructor(e){this.self=e}SETS_AND_GETS;get Name(){return this.self.name}get Object_Store_Names(){return[...this.self.objectStoreNames]}get version(){return this.self.version}EVENTS;set on_close(e){this.self.onclose=e}set on_version_change(e){this.self.onversionchange=e}METHODS;close(){return window._num_db_cons-=1,this.self.close()}create_object_store(e){try{return new te(this.self.createObjectStore(e,{keyPath:"id",autoIncrement:!0}))}catch(e){return se("[EI] database.create_object_store: Error:",e),e}}delete_object_store(e){try{return this.self.deleteObjectStore(e)}catch(e){return se("[EI] database.delete_object_store: Error:",e),e}}transaction(e,t,r){try{return new ae(this.self.transaction(e,t,r))}catch(e){return se("[EI] database.transaction: Error:",e),e}}};var oe=console.log,ie=console.warn,_e=console.error,ce=r.new_lock;console.log,console.warn,console.error;const le=class{static keys(){return Object.keys(localStorage)}static set(e,t){try{var r=o.obj_to_json(t);localStorage[e]=r}catch(e){return null}}static get(e){try{var t=localStorage[e];return o.json_to_obj_bd(t)}catch(e){return null}}static clear(e){delete localStorage[e]}};console.log,console.warn,console.error;const ue=class{static keys(){return Object.keys(sessionStorage)}static set(e,t){try{var r=o.obj_to_json(t);sessionStorage[e]=r}catch(e){return null}}static get(e){try{var t=sessionStorage[e];return o.json_to_obj_bd(t)}catch(e){return null}}static clear(e){delete sessionStorage[e]}};var de=console.log;console.warn,console.error;class fe{SUB_NAMESPACES;static idb;static idbx;static idbxs;static sec;static wcrypto;static utils;LITERALS;static n1=1;static n2=2;static u1=3;static u2=4;CONSTANTS;static RO="readonly";static RW="readwrite";PROPERTIES;static Factory;METHODS;static databases;static open;static delete_database;static open_av;static reopen;static num_db_cons;static set_db;static get_prop;static do_op;static del_obj_store;static insert_one;static insert_many;static exists;static count;static count_all;static find_one;static find_many;static find_all;static filter;static update_one;static update_many;static upsert_one;static remove_one;static remove_many;static set_max_history;static get_op_hist_status;static enable_op_hist;static disable_op_hist;static get_op_hist;static clear_op_hist;static enable_fts;static disable_fts;static find_many_by_terms;static s_open_av;static s_insert_one;static s_insert_many;static s_exists;static s_count;static s_count_all;static s_find_one;static s_find_many;static s_find_all;static s_filter;static s_update_one;static s_update_many;static s_upsert_one;static s_remove_one;static s_remove_many;static s_set_max_history;static s_get_op_hist_status;static s_enable_op_hist;static s_disable_op_hist;static s_get_op_hist;static s_clear_op_hist;static s_enable_fts;static s_disable_fts;static s_find_many_by_terms;METHODS(){}static init(){fe.idb=a,fe.idbx=q,fe.idbxs=A,fe.sec=A,fe.wcrypto=b,fe.utils=o,fe.idb.init(),fe.idbx.init(),fe.idbxs.init(),fe.wcrypto.init(),fe.utils.init(),window.slocal=le,window.ssession=ue,fe.Factory=new class{self=null;constructor(e){this.self=e}async databases(){try{return await this.self.databases()}catch(e){return _e("[EI] factory.databases: Error:",e),e}}async delete_database(e){var t=this.self.deleteDatabase(e),[r,a]=ce();return t.onerror=function(e){a(e.target.error)},t.onsuccess=function(e){a(null)},await r}async open(e,t){try{var r=this.self.open(e,t)}catch(e){return _e("[EI] idb.open: Error caught:",e),e.Status="errored",e}var[a,s]=ce(),n=null,o=null,i=null;r.onerror=function(e){n=e.target.error,s("errored")},r.onblocked=function(e){ie(`[EI] idb.open: Upgrade blocked, requested to change to version ${t}`),ie("[EI] Check source code, shouldn't be blocked by connections in current tab or other tabs."),ie("[EI] Tip: Avoid being blocked by using temporary connections in all tabs together with IDBDatabase.versionchange event."),o=e,s("blocked"),i="blocked"},r.onupgradeneeded=function(e){if(null!=i)return ie(`[EI] idb.open: Upgrade cancelled due to '${i}' event fired right previously`),void s();oe(`[EI] idb.open: Upgrade needed, to version ${t}`),s("to-upgrade"),i="to-upgrade"},r.onsuccess=function(e){if(null!=i)return ie(`[EI] idb.open: Open cancelled due to '${i}' event fired right previously`),void s();s("opened")};var _=await a;if("errored"==_)return n.Status="errored",n;if("blocked"==_){let e=new Error("Upgrade is blocked by other connections, close them all first.");return e.Status="blocked",e.Event=o,e}if("to-upgrade"==_){let e=new ne(r.result);return e.to_upgrade=!0,e.Transaction=new ae(r.transaction),null==window._num_db_cons?window._num_db_cons=1:window._num_db_cons+=1,e}if("opened"==_){let e=new ne(r.result);return e.to_upgrade=!1,null==window._num_db_cons?window._num_db_cons=1:window._num_db_cons+=1,e}}}(window.indexedDB),fe.databases=a.databases,fe.open=a.open,fe.delete_database=a.delete_database,fe.open_av=q.open_av,fe.reopen=q.reopen,fe.num_db_cons=q.num_db_cons,fe.set_db=q.set_db,fe.get_prop=q.get_prop,fe.do_op=q.do_op,fe.del_obj_store=q.del_obj_store,fe.insert_one=q.crud.insert_one,fe.insert_many=q.crud.insert_many,fe.exists=q.crud.exists,fe.count=q.crud.count,fe.count_all=q.crud.count_all,fe.find_one=q.crud.find_one,fe.find_many=q.crud.find_many,fe.find_all=q.crud.find_all,fe.filter=q.crud.filter,fe.update_one=q.crud.update_one,fe.update_many=q.crud.update_many,fe.upsert_one=q.crud.upsert_one,fe.remove_one=q.crud.remove_one,fe.remove_many=q.crud.remove_many,fe.set_max_history=q.op_hist.set_max_history,fe.get_op_hist_status=q.op_hist.get_op_hist_status,fe.enable_op_hist=q.op_hist.enable_op_hist,fe.disable_op_hist=q.op_hist.disable_op_hist,fe.get_op_hist=q.op_hist.get_op_hist,fe.clear_op_hist=q.op_hist.clear_op_hist,fe.enable_fts=q.fts.enable_fts,fe.disable_fts=q.fts.disable_fts,fe.find_many_by_terms=q.fts.find_many_by_terms,fe.s_open_av=A.open_av,fe.s_insert_one=A.cruds.insert_one,fe.s_insert_many=A.cruds.insert_many,fe.s_exists=A.cruds.exists,fe.s_count=A.cruds.count,fe.s_count_all=A.cruds.count_all,fe.s_find_one=A.cruds.find_one,fe.s_find_many=A.cruds.find_many,fe.s_find_all=A.cruds.find_all,fe.s_filter=A.cruds.filter,fe.s_update_one=A.cruds.update_one,fe.s_update_many=A.cruds.update_many,fe.s_upsert_one=A.cruds.upsert_one,fe.s_remove_one=A.cruds.remove_one,fe.s_remove_many=A.cruds.remove_many,fe.s_set_max_history=A.op_hists.set_max_history,fe.s_get_op_hist_status=A.op_hists.get_op_hist_status,fe.s_enable_op_hist=A.op_hists.enable_op_hist,fe.s_disable_op_hist=A.op_hists.disable_op_hist,fe.s_get_op_hist=A.op_hists.get_op_hist,fe.s_clear_op_hist=A.op_hists.clear_op_hist,fe.s_enable_fts=A.ftss.enable_fts,fe.s_disable_fts=A.ftss.disable_fts,fe.s_find_many_by_terms=A.ftss.find_many_by_terms}}window.n1=fe.n1,window.n2=fe.n2,window.u1=fe.u1,window.u2=fe.u2,window._secure=!0,window._stop="stop";const ye=fe.RO;window.RO=ye;const pe=fe.RW;window.RW=pe,window.WITH_LEFT=!1,window.WITH_RIGHT=!1,window.NO_LEFT=!0,window.NO_RIGHT=!0,window._add="add",window._clear="clear",window._count="count",window._create_index="create_index",window._delete="delete",window._delete_index="delete_index",window._get="get",window._get_all="get_all",window._get_all_keys="get_all_keys",window._get_key="get_key",window._index="index",window._open_cursor="open_cursor",window._open_key_cursor="open_key_cursor",window._put="put",window.range_gte=e=>new V(IDBKeyRange.lowerBound(e)),window.range_gt=e=>new V(IDBKeyRange.lowerBound(e,!0)),window.range_lte=e=>new V(IDBKeyRange.upperBound(e)),window.range_lt=e=>new V(IDBKeyRange.upperBound(e,!0)),window.range_between=(e,t,r,a)=>new V(IDBKeyRange.bound(e,t,r,a)),window.value_is=e=>new V(IDBKeyRange.only(e));const be=r.new_lock;window.new_lock=be;const we=r.stay_idle;window.stay_idle=we,window.eidb=fe;var he=window.location;de("[EI] EnIndex loaded in",`${he.protocol}//${he.host}${he.pathname}`);const ge=fe;var ve=t.Z;export{ve as default};