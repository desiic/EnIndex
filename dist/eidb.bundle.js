var t={d:(e,a)=>{for(var r in a)t.o(a,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:a[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{Z:()=>bt}),console.log,console.warn,console.error;const a=class{static new_lock(){var t;return[new Promise(((e,a)=>{t=e})),t]}static async stay_idle(t){var e=new Promise(((e,a)=>{setTimeout((()=>{e()}),t)}));await e}};console.log,console.warn,console.error;const r=class{static async databases(){return await bt.Factory.databases()}static async open(t,e){return bt._Db_Name=t,await bt.Factory.open(t,e)}static async delete_database(t){return await bt.Factory.delete_database(t)}static init(){}},s=(console.log,console.warn,console.error);class n{static intersect_arrs(t){return t.reduce(((t,e)=>t.filter((t=>e.includes(t)))))}static#t(t){if("string"==typeof t)return t;if(t.constructor!=Object)return"";var e="";for(let a in t){let r=t[a];if(null!=r)if(r instanceof Array)for(let t of r)e+=n.obj_to_valuestr(t)+" ";else r.constructor==Object?e+=n.obj_to_valuestr(r):"string"==typeof r&&(e+=r+" ")}return e}static obj_to_valuestr(t){return n.#t(t).trim()}static obj_to_json(t){return JSON.stringify(t)}static json_to_obj_sd(t){return JSON.parse(t)}static json_to_obj_bd(t){return JSON.parse(t,((t,e)=>null==e?null:e.constructor!=String||null==e.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/)?e:new Date(e)))}static prop_set(t,e,a){var r=e.split("."),n=t;if(0!=r.length){if(1==r.length)return t[e]=a,t;for(let e=0;e<r.length;e++){let s=r[e];if(!(e<r.length-1))return n[s]=a,t;null==n[s]&&(n[s]={}),n=n[s]}}else s("[EI] utils.prop_set: Invalid path")}static prop_get(t,e){var a=e.split("."),r=t;if(0!=a.length){if(1==a.length)return t[e];for(let t=0;t<a.length;t++){let e=a[t];if(null==r[e])return null;r=r[e]}return r}s("[EI] utils.prop_get: Invalid path")}static deepcopy(t){return n.json_to_obj_bd(n.obj_to_json(t))}static escape_for_regex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}static init(){}}const o=n;console.log,console.warn;var i=console.error;const _={create:"Recent_Creates",read:"Recent_Reads",update:"Recent_Updates",delete:"Recent_Deletes"};class l{static max_history=1e3;static enabled=!1;static set_max_history(t){history.max_history=t}static get_op_hist_status(){return l.enabled?"enabled":"disabled"}static async enable_op_hist(){l.enabled=!0}static disable_op_hist(){l.enabled=!1}static sort_docmetas_des(t){return t.sort(((t,e)=>t.Timestamp<e.Timestamp?1:t.Timestamp>e.Timestamp?-1:0)),t}static async#t(t,e,a){if(l.enabled&&null!=a&&0!=a.length)if(-1!=["create","read","update","delete"].indexOf(e)){var r=await V.reopen();if(-1!=r.Object_Store_Names.indexOf("op_hist")){var s=r.transaction("op_hist",bt.RW).store1(),n=await s.index("Store_Name").get(bt.value_is(t));if(null==n){let n={Store_Name:t},o=[],i=new Date;for(let t of a)o.length<l.max_history&&o.push({id:t,Timestamp:i});for(let t in _)n[_[t]]=[];return n[_[e]]=o,await s.add(n),void r.close()}var o=n[_[e]],c=o.map((t=>t.id)),u=new Date;for(let t of a)-1==c.indexOf(t)&&o.push({id:t,Timestamp:u});o=(o=l.sort_docmetas_des(o)).slice(0,l.max_history),n[_[e]]=o,await s.put(n),r.close()}else r.close()}else i("[EI] op_hist.update_op_hist: No such operation type:",e)}static update_op_hist_c(t,e){l.#t(t,"create",e)}static update_op_hist_r(t,e){l.#t(t,"read",e)}static update_op_hist_u(t,e){l.#t(t,"update",e)}static update_op_hist_d(t,e){l.#t(t,"delete",e)}static async get_op_hist(t,e){var a=await V.reopen(),r=a.transaction("op_hist",bt.RO).store1(),s=await r.index("Store_Name").get(bt.value_is(t));return a.close(),s}static async clear_op_hist(){var t=await V.reopen();if(t instanceof Error)i("[EI] op_hist.clear_op_hist: Failed to open db, error:",t);else{var e=t.transaction("op_hist",bt.RW).store1();await e.delete(bt.range_gte(0)),t.close()}}static init(){}}const c=l;console.log,console.warn;var u=console.error,d=a.new_lock;const f=new Uint8Array([0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45]);class y{static BIT_LEN=256;static FIXED_IV_BYTES=f;static FIXED_IV="000306090c0f1215181b1e2124272a2d";static EXTERNAL_LIBS(){}static async get_pubkey_point(t){var[e,a]=d();return setTimeout((()=>{null==window.elliptic&&u("[EI] wcrypto.get_pubkey_point: No Elliptic lib found.")}),3e4),setTimeout((function e(){if(null!=window.elliptic){for(var r=elliptic.ec("p256").keyFromPrivate(t).getPublic(),s=r.getX().toString(16),n=r.getY().toString(16);s.length<64;)s="0"+s;for(;n.length<64;)n="0"+n;a([s,n])}else setTimeout(e,0)}),0),await e}static BASE_FUNCS(){}static get_random_values_unsigned(t,e){if(8==t||16==t||32==t||64==t){if(8==t)var a=new Uint8Array(e);return 16==t&&(a=new Uint16Array(e)),32==t&&(a=new Uint32Array(e)),64==t&&(a=new BigUint64Array(e)),window.crypto.getRandomValues(a),a}u("[EI] wcrypto.get_random_values_unsigned: Bits must be 8, 16, 32, or 64")}static get_random_values_signed(t,e){if(8==t||16==t||32==t||64==t){if(8==t)var a=new Int8Array(e);return 16==t&&(a=new Int16Array(e)),32==t&&(a=new Int32Array(e)),64==t&&(a=new BigInt64Array(e)),window.crypto.getRandomValues(a),a}u("[EI] wcrypto.get_random_values_signed: Bits must be 8, 16, 32, or 64")}static random_iv(){return y.get_random_values_unsigned(8,16)}static random_uuid(){return window.crypto.randomUUID()}static random_uuidx(){return(window.crypto.randomUUID()+window.crypto.randomUUID()).replaceAll("-","")}static UTILS(){}static base64url_to_base64(t){return t.replaceAll("-","+").replaceAll("_","/")}static base64_to_base64url(t){return t.replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}static utf8_to_bytes(t){return(new TextEncoder).encode(t)}static bytes_to_utf8(t){return new TextDecoder("utf-8").decode(t)}static buff_to_bytes(t){return new Uint8Array(t)}static bytes_to_buff(t){return t.buffer}static buff_to_hex(t){return[...new Uint8Array(t)].map((t=>t.toString(16).padStart(2,"0"))).join("")}static hex_to_buff(t){return y.hex_to_bytes(t).buffer}static bytes_to_hex(t){return[...t].map((t=>t.toString(16).padStart(2,"0"))).join("")}static hex_to_bytes(t){var e=new Uint8Array(t.length/2);for(let a=0;a<e.byteLength;a++)e[a]=parseInt(t.substring(2*a,2*a+2),16);return e}static buff_to_base64(t){for(var e=new Uint8Array(t),a=e.byteLength,r="",s=0;s<a;s++)r+=String.fromCharCode(e[s]);return window.btoa(r)}static base64_to_buff(t){var e=window.atob(t),a=new Uint8Array(e.length);for(let t=0;t<a.byteLength;t++)a[t]=e.charCodeAt(t);return a.buffer}static bytes_to_base64(t){var e=t.byteLength,a="";for(let r=0;r<e;r++)a+=String.fromCharCode(t[r]);return window.btoa(a)}static base64_to_bytes(t){var e=window.atob(t),a=new Uint8Array(e.length);for(let t=0;t<a.byteLength;t++)a[t]=e.charCodeAt(t);return a}static base64_to_hex(t){return y.bytes_to_hex(y.base64_to_bytes(t))}static hex_to_base64(t){return y.bytes_to_base64(y.hex_to_bytes(t))}static base64url_to_hex(t){return t=y.base64url_to_base64(t),y.bytes_to_hex(y.base64_to_bytes(t))}static hex_to_base64url(t){var e=y.bytes_to_base64(y.hex_to_bytes(t));return y.base64_to_base64url(e)}static SUBTLE(){}static async digest_sha1(t){var e=y.utf8_to_bytes(t),a=await window.crypto.subtle.digest("SHA-1",e);return this.buff_to_hex(a)}static async digest_sha256(t){var e=y.utf8_to_bytes(t),a=await window.crypto.subtle.digest("SHA-256",e);return this.buff_to_hex(a)}static async generate_key_aes(){return await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}static async generate_key_aes_kw(){return await window.crypto.subtle.generateKey({name:"AES-KW",length:256},!0,["wrapKey","unwrapKey"])}static async generate_keys_rsa_ed(){var t={name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"};return await window.crypto.subtle.generateKey(t,!0,["encrypt","decrypt"])}static async generate_keys_rsa_sv(){var t={name:"RSA-PSS",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"};return await window.crypto.subtle.generateKey(t,!0,["sign","verify"])}static async generate_keys_ec_ed(){}static async generate_keys_ec_sv(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"])}static async import_key_pb_raw(t){var e=y.utf8_to_bytes(t);try{var a=await window.crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits","deriveKey"])}catch(t){return u("[EI] wcrypto.import_key_pb_raw: Failed to import, error:",t),null}return a}static async import_key_aes_raw(t){if(64!=t.length)return u("[EI] wcrypto.import_key_raw: Hex of key must be of length 64 chars"),null;var e=y.hex_to_bytes(t);try{var a=await window.crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!0,["encrypt","decrypt"])}catch(t){return u("[EI] wcrypto.import_key_aes_raw: Failed to import, error:",t),null}return a}static async import_key_rsa_jwk(t,e="RSA-PSS"){var a={name:e,hash:"SHA-256"};if("RSA-OAEP"==e)var r=["encrypt","decrypt"];else r=["sign","verify"];try{return await window.crypto.subtle.importKey("jwk",t,a,!0,r)}catch(t){return u("[EI] wcrypto.import_key_rsa_jwk: Failed to import, error:",t),null}}static async import_key_ec_jwk(t,e="ECDSA"){var a={name:e,namedCurve:"P-256"};if(null!=t.d)var r=["sign"];else r=["verify"];try{return await window.crypto.subtle.importKey("jwk",t,a,!0,r)}catch(t){return u("[EI] wcrypto.import_key_ec_jwk: Failed to import, error:",t),null}}static async export_key_hex(t){return y.buff_to_hex(await window.crypto.subtle.exportKey("raw",t))}static async export_key_jwk(t){try{return await window.crypto.subtle.exportKey("jwk",t)}catch(t){return u("[EI] wcrypto.export_key_jwk: Failed to export, error:",t),null}}static async derive_bits_pb(t,e,a,r=256){var s=await y.import_key_pb_raw(t),n={name:"PBKDF2",hash:"SHA-256",salt:y.utf8_to_bytes(e),iterations:a};try{var o=await window.crypto.subtle.deriveBits(n,s,r);return y.buff_to_hex(o)}catch(t){return u("[EI] wcrypto.derive_bits_pb: Failed to derive, error:",t),null}}static async derive_key_pb2aes(t,e,a){var r=await y.import_key_pb_raw(t),s={name:"PBKDF2",hash:"SHA-256",salt:y.utf8_to_bytes(e),iterations:a};try{return await window.crypto.subtle.deriveKey(s,r,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}catch(t){return u("[EI] wcrypto.derive_key_pb2aes: Failed to derive, error:",t),null}}static async derive_keys_pb2rsa(t,e,a){}static async derive_keys_pb2ec(t,e,a){BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff"),BigInt("0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc"),BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"),BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),BigInt("0x01");var r=await y.generate_keys_ec_sv(),s=await y.export_key_jwk(r.privateKey),n=await y.export_key_jwk(r.publicKey),o=t+e;for(let t=0;t<a;t++)o=await y.digest_sha256(o);var[i,_]=await y.get_pubkey_point(o);return o=y.hex_to_base64url(o),i=y.hex_to_base64url(i),_=y.hex_to_base64url(_),s.d=o,s.x=i,s.y=_,n.x=i,n.y=_,{privateKey:await y.import_key_ec_jwk(s,"ECDSA"),publicKey:await y.import_key_ec_jwk(n,"ECDSA")}}static async encrypt_aes(t,e,a=null){if(null==a)var r=y.random_iv();else r=y.hex_to_bytes(a);var s=y.utf8_to_bytes(t),n={name:"AES-GCM",iv:r};try{var o=await window.crypto.subtle.encrypt(n,e,s)}catch(t){return u("[EI] wcrypto.encrypt_aes: Failed to encrypt, error:",t),null}return[y.buff_to_base64(o),y.bytes_to_hex(r)]}static async encrypt_aes_fiv(t,e){return await y.encrypt_aes(t,e,p.FIXED_IV)}static async encrypt_rsa(t,e){var a=y.utf8_to_bytes(t);try{var r=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},e,a)}catch(t){return u("[EI] wcrypto.encrypt_rsa: Failed to encrypt, error:",t),null}return y.buff_to_base64(r)}static async encrypt_ec(t,e){}static async decrypt_aes(t,e,a){var r=y.base64_to_bytes(t),s={name:"AES-GCM",iv:y.hex_to_bytes(e)};try{var n=await window.crypto.subtle.decrypt(s,a,r)}catch(t){return u("[EI] wcrypto.decrypt_aes: Failed to decrypt, error:",t),null}return y.bytes_to_utf8(new Uint8Array(n))}static async decrypt_aes_fiv(t,e){return await y.decrypt_aes(t,p.FIXED_IV,e)}static async decrypt_rsa(t,e){var a=y.base64_to_bytes(t);try{var r=await window.crypto.subtle.decrypt({name:"RSA-OAEP"},e,a)}catch(t){return u("[EI] wcrypto.decrypt_rsa: Failed to decrypt, error:",t),null}return y.bytes_to_utf8(new Uint8Array(r))}static async decrypt_ec(t,e){}static async sign(t,e){if("RSA-PSS"==e.algorithm.name)var a={name:"RSA-PSS",saltLength:256};else a={name:"ECDSA",hash:"SHA-256"};var r=y.utf8_to_bytes(t);try{var s=await window.crypto.subtle.sign(a,e,r)}catch(t){return u("[EI] wcrypto.sign: Failed to sign, error:",t),null}return y.buff_to_hex(s)}static async verify(t,e,a){if("RSA-PSS"==a.algorithm.name)var r={name:"RSA-PSS",saltLength:256};else r={name:"ECDSA",hash:"SHA-256"};var s=y.utf8_to_bytes(t),n=y.hex_to_bytes(e);try{return await window.crypto.subtle.verify(r,a,n,s)}catch(t){return u("[EI] wcrypto.verify: Failed to verify, error:",t),null}}static async wrap_key(){}static async unwrap_key(){}static EXTENDED(){}static split_into_2(t){var e=Math.floor(t.length/2);return[t.substring(0,e),t.substring(e)]}static async password2keys(t,e,a){var r=await y.derive_bits_pb(t,e,a,512),[s,n]=y.split_into_2(r);return[await y.derive_key_pb2aes(s,e,a),await y.derive_keys_pb2ec(n,e,a)]}static async make_static_key(t,e){var a=y.random_uuidx();return await y.derive_key_pb2aes(a,t,e)}static init(){}}const p=y,b=p,w=(console.log,console.warn,console.error),h=a.new_lock,g=class{static async insert_one(t,e){if(null!=A.Skey){t="#"+t;var a=await A.obj_to_sobj(t,e);return await W.insert_one(t,a,!0,e)}w("[EI] cruds.insert_one: Static key not set")}static async insert_many(t,e){if(null!=A.Skey){t="#"+t;var a=[];for(let r of e)a.push(await A.obj_to_sobj(t,r));return await W.insert_many(t,a,!0,e)}w("[EI] cruds.insert_many: Static key not set")}static async get_1stcond_obj(t,e){}static async get_1stcond_objs(t,e){}static async intersect_cond(t,e){}static async intersect_cond_getobjs(t,e){}static async exists(t,e){if(null!=A.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await A.array_to_sarray(e[t]):a[t]=await A.value_to_svalue(e[t]);return await W.exists(t,a,!0)}w("[EI] cruds.exists: Static key not set")}static async count(t,e){if(null!=A.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await A.array_to_sarray(e[t]):a[t]=await A.value_to_svalue(e[t]);return await W.count(t,a,!0)}w("[EI] cruds.count: Static key not set")}static async count_all(t){if(null!=A.Skey)return t="#"+t,await W.count_all(t,!0);w("[EI] cruds.count_all: Static key not set")}static async find_one(t,e){if(null!=A.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await A.array_to_sarray(e[t]):a[t]=await A.value_to_svalue(e[t]);var r=await W.find_one(t,a,!0);if(null==r)return null;var s=await b.decrypt_aes_fiv(r.Etds_Obj,A.Skey),n=o.json_to_obj_bd(s);return n.id=r.id,n}w("[EI] cruds.find_one: Static key not set")}static async find_many(t,e,a=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){t="#"+t;var r={};for(let t in e)"id"==t?r[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?r[t]=await A.array_to_sarray(e[t]):r[t]=await A.value_to_svalue(e[t]);var s=await W.find_many(t,r,a,!0),n=[];for(let t of s){var i=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_.id=t.id,n.push(_)}return n}w("[EI] cruds.find_many: Static key not set")}static async find_all(t){if(null!=A.Skey){t="#"+t;var e=await W.find_all(t,!0),a=[];for(let t of e){var r=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey);if(null!=r){var s=o.json_to_obj_bd(r);s.id=t.id,a.push(s)}}return a}w("[EI] cruds.find_all: Static key not set")}static get_proppath_value(t,e){}static obj_matches_cond(t,e){}static async filter(t,e,a=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){t="#"+t;var r={};for(let t in e)r[t]="id"==t?e[t]:await A.value_to_svalue(e[t]);var s=await W.filter(t,r,a,!0),n=[];for(let t of s){var i=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_.id=t.id,n.push(_)}return n}w("[EI] cruds.filter: Static key not set")}static async update_one(t,e,a){if(null!=A.Skey){t="#"+t;var r=await A.obj_to_sobj_arb(a),s={};for(let t in e)"id"==t?s[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?s[t]=await A.array_to_sarray(e[t]):s[t]=await A.value_to_svalue(e[t]);var n=await W.find_one(t,s,!0),i=await b.decrypt_aes_fiv(n.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_={..._,...a},i=o.obj_to_json(_),r.Etds_Obj=(await b.encrypt_aes_fiv(i,A.Skey))[0];var l=await W.update_one(t,s,r,!0,_);return i=await b.decrypt_aes_fiv(l.Etds_Obj,A.Skey),(_=o.json_to_obj_bd(i)).id=l.id,_}w("[EI] cruds.update_one: Static key not set")}static async update_many(t,e,a,r=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){t="#"+t;var s=o.deepcopy(a);delete s.id,a=s;var n=await A.obj_to_sobj_arb(a),i=[],_={};for(let t in e)"id"==t?_[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?_[t]=await A.array_to_sarray(e[t]):_[t]=await A.value_to_svalue(e[t]);var l=await W.find_many(t,_,!0),c=[];for(let t of l){let e=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),r=o.json_to_obj_bd(e);r={...r,...a,id:t.id},e=o.obj_to_json(r),c.push(r);let s=o.deepcopy(n);s.Etds_Obj=(await b.encrypt_aes_fiv(e,A.Skey))[0],i.push(s)}var u=await bt.reopen(),d=u.transaction(t,bt.RW).store1(),f=0,y=[],[p,g]=h();for(let e=0;e<l.length;e++){let a,r={...l[e],...i[e]};d.put(r,null,a=!1,(a=>{a instanceof Error?(w("[EI] cruds.update_many: Error:",a),y.push(null)):y.push(r),D.update_fts_u(t,c[e].id,c[e]),++f==l.length&&g()}))}await p;var v=[];for(let t of y){let e=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),a=o.json_to_obj_bd(e);a.id=t.id,v.push(a)}return u.close(),v}w("[EI] cruds.update_many: Static key not set")}static async upsert_one(t,e,a){if(null!=A.Skey){t="#"+t;var r=await A.obj_to_sobj_arb(a),s={};for(let t in e)"id"==t?s[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?s[t]=await A.array_to_sarray(e[t]):s[t]=await A.value_to_svalue(e[t]);var n=await W.find_one(t,s,!0),i=await b.decrypt_aes_fiv(n.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);return _={..._,...a},i=o.obj_to_json(_),r.Etds_Obj=(await b.encrypt_aes_fiv(i,A.Skey))[0],await W.upsert_one(t,s,r,!0,_)}w("[EI] cruds.upsert_one: Static key not set")}static async remove_one(t,e){if(null!=A.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await A.array_to_sarray(e[t]):a[t]=await A.value_to_svalue(e[t]);var r=await W.find_one(t,a,!0);if(null==r)return null;var s=await b.decrypt_aes_fiv(r.Etds_Obj,A.Skey),n=o.json_to_obj_bd(s);n.id=r.id,await W.remove_one(t,a,!0,n)}else w("[EI] cruds.remove_one: Static key not set")}static async remove_many(t,e){if(null!=A.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await A.array_to_sarray(e[t]):a[t]=await A.value_to_svalue(e[t]);var r=[],s=await W.find_many(t,a,!0);if(null==s||0==s.length)return null;for(let t of s){var n=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),i=o.json_to_obj_bd(n);i.id=t.id,r.push(i)}await W.remove_many(t,a,!0,r)}else w("[EI] cruds.remove_many: Static key not set")}static init(){}};console.log,console.warn,console.error;const v=class{static set_max_history(t){c.set_max_history(t)}static get_op_hist_status(){return c.get_op_hist_status()}static async enable_op_hist(){c.enable_op_hist()}static disable_op_hist(){c.disable_op_hist()}static sort_docmetas_des(t){}static async#t(t,e,a){}static update_op_hist_c(t,e){t="#"+t,c.update_op_hist_c(t,e)}static update_op_hist_r(t,e){t="#"+t,c.update_op_hist_r(t,e)}static update_op_hist_u(t,e){t="#"+t,c.update_op_hist_u(t,e)}static update_op_hist_d(t,e){t="#"+t,c.update_op_hist_d(t,e)}static async get_op_hist(t,e){return t="#"+t,await c.get_op_hist(t,e)}static async clear_op_hist(){await c.clear_op_hist()}static init(){}},m=(console.log,console.warn,console.error),E=class{static enable_fts(){D.enable_fts()}static disable_fts(){D.disable_fts()}static str_to_unique_words(t){}static obj_to_unique_words(t){}static async obj_exists(t,e,a){}static async increase_num_objs(t,e,a){}static async decrease_num_objs(t,e,a){}static async update_fts(t,e,a,r){}static update_fts_c(t,e,a){D.update_fts_c(t,e,a,!0)}static update_fts_r(t,e,a){}static update_fts_u(t,e,a){D.update_fts_u(t,e,a,!0)}static update_fts_d(t,e,a){D.update_fts_d(t,e,a,!0)}static async#t(t,e,a,r){}static#e(t,e){}static async find_many_by_terms(t,e,a=1e3){if(null!=A.Skey){t="#"+t;var r=await D.find_many_by_terms(t,e,a,!0);for(let t=0;t<r.Items.length;t++){let e=r.Items[t].Object,a=await b.decrypt_aes_fiv(e.Etds_Obj,A.Skey),s=o.json_to_obj_bd(a);s.id=e.id,r.Items[t]=s}for(let t=0;t<r.Search_Terms.length;t++)r.Search_Terms[t]=await b.decrypt_aes_fiv(r.Search_Terms[t],A.Skey);for(let t=0;t<r.Excluded_Terms.length;t++)r.Excluded_Terms[t]=await b.decrypt_aes_fiv(r.Excluded_Terms[t],A.Skey);return r}m("[EI] ftss.find_many_by_terms: Static key not set")}static init(){}},S=console.log,k=console.warn,x=console.error;var j={Store:"_global",Etde_Skey:null,Etde_Skey_Iv:null,Etdr_Recovery:null,Etdr_Recovery_Iv:null};class I{SUB_NAMESPACES;static cruds;static op_hists;static ftss;CONSTANTS;static ITERATIONS=1e5;PROPERTIES;static Ekey=null;static Akeypair=null;static Skey=null;static Rkey=null;METHODS;static async open_av(t,e){var a=Object.keys(e);for(let t of a)null!=e[t]._secure&&(delete e[t]._secure,e["#"+t]={...e[t]},delete e[t]);return await V.open_av(t,e)}static async value_to_svalue(t){var e;return e=t instanceof Object&&!(t instanceof Date)?o.obj_to_json(t):t instanceof Date?t.toISOString():t.toString(),(await b.encrypt_aes_fiv(e,I.Skey))[0]}static async array_to_sarray(t){var e=[];for(let a of t)e.push(await O.value_to_svalue(a));return e}static async obj_to_sobj(t,e){if(null==I.Skey)return void x("[EI] idbxs.obj_to_sobj: Static key not set");var a=Object.keys(V.Indices[t]);a=a.filter((t=>"id"!=t));let r=[];if(null!=e.id)var s={id:e.id};else s={};for(let t of a){if(t.indexOf(",")>=0){let a=t.split(",");for(let t of a)r.push({Path:t,Value:o.prop_get(e,t)})}else r.push({Path:t,Value:o.prop_get(e,t)});for(let t=0;t<r.length;t++){let e;e=r[t].Value instanceof Object&&!(r[t].Value instanceof Date)?o.obj_to_json(r[t].Value):r[t].Value instanceof Date?r[t].Value.toISOString():r[t].Value.toString();let a=await b.encrypt_aes_fiv(e,I.Skey);r[t].Svalue=a[0]}}for(let t of r){let e=t.Path,a=t.Svalue;s=o.prop_set(s,e,a)}var n=o.obj_to_json(e),i=await b.encrypt_aes_fiv(n,I.Skey);return s.Etds_Obj=i[0],s}static async obj_to_sobj_arb(t){var e={};for(let a in t){let r;r=t[a]instanceof Object&&!(t[a]instanceof Date)?o.obj_to_json(t[a]):t[a]instanceof Date?t[a].toISOString():t[a].toString(),e[a]=(await b.encrypt_aes_fiv(r,I.Skey))[0]}return e}static async#t(t){if(null==t)return null;if(!(t instanceof Object))return(await b.encrypt_aes_fiv(t,I.Skey))[0];if(t instanceof Date)return(await b.encrypt_aes_fiv(t.toISOString(),I.Skey))[0];for(let e in t)t[e]=await I.#t(t[e]);return t}static async obj_to_sobj_arb_rec(t){var e=JSON.parse(JSON.stringify(t));return await I.#t(e)}static set_ea_keys(t,e){I.Ekey=t,I.Akeypair=e}static set_static_key(t){I.Skey=t}static async ensure_global_meta(t){null==await I.load_global_meta(t)&&await t.add(j)}static async load_global_meta(t){var e=t;if(null==t){var a=await bt.reopen();t=a.transaction("_meta",bt.RO).store1()}var r=await t.index("Store").get(bt.value_is("_global"));return null==e&&a.close(),r}static async update_global_meta(t,e){var a=t;if(null==t){var r=await bt.reopen();t=r.transaction("_meta",bt.RW).store1()}var s=await I.load_global_meta(t);s={...s,...e},await t.put(s),null==a&&r.close()}static async save_static_key(t,e=!1){if(null!=I.Ekey&&null!=I.Akeypair){var a=await b.export_key_hex(t),r=await b.encrypt_aes(a,I.Ekey),[s,n]=r,o=await bt.reopen(),i=o.transaction("_meta",bt.RW).store1(),_=await i.index("Store").get(bt.value_is("_global"));if(null==_&&(I.ensure_global_meta(i),_=await i.index("Store").get(bt.value_is("_global"))),null!=_.Etde_Skey&&0==e)return k("[EI] idbxs.save_static_key: Static key exists, no enforcing"),void o.close();_.Etde_Skey=s,_.Etde_Skey_Iv=n,i.put(_),o.close()}else x("[EI] idbxs.save_static_key: Encryption key and auth key pair must exist first, call set_ea_keys")}static async load_static_key(){if(null!=I.Ekey&&null!=I.Akeypair){var t=await bt.reopen(),e=t.transaction("_meta",bt.RW).store1(),a=await e.index("Store").get(bt.value_is("_global"));if(null==a)return k("[EI] idbxs.load_static_key: Global metadata not set"),await I.ensure_global_meta(e),void t.close();if(null==a.Etde_Skey)return k("[EI] idbxs.load_static_key: No static key in global metadata"),void t.close();var r=a.Etde_Skey,s=a.Etde_Skey_Iv,n=await b.decrypt_aes(r,s,I.Ekey),o=await b.import_key_aes_raw(n);return t.close(),o}x("[EI] idbxs.load_static_key: Encryption key and auth key pair must exist first, call set_ea_keys")}static async save_data_iv(t){await bt.update_one("_meta",{Store:"_global"},{Etds_Data_Iv:t})}static async load_data_iv(){var t=await bt.find_one("_meta",{Store:"_global"});return null==t?null:t.Etds_Data_Iv}static async prepare_keys(t,e){var a=bt.slocal.get("Ekey_Hex"),r=bt.slocal.get("Akeypriv_Jwk"),s=bt.slocal.get("Akeypub_Jwk"),n=!1;if(null!=a&&null!=r&&null!=s){var o=await b.import_key_aes_raw(a),i={privateKey:_=await b.import_key_ec_jwk(r),publicKey:l=await b.import_key_ec_jwk(s)};I.set_ea_keys(o,i);try{S("[EI] Trying stored keys..."),n=null!=(c=await I.load_static_key())}catch(t){}}if(!n){var[o,i]=await I.get_key_chain(t,e);I.set_ea_keys(o,i);var _=i.privateKey,l=i.publicKey;S("[EI] Trying keys from username and password...");var c=await I.load_static_key()}var u=null;if(null==c){let e;k("[EI] idbxs.prepare_keys: No static key, creating one..."),c=await I.get_new_static_key(t),u=await b.bytes_to_hex(await b.random_iv()),await I.save_static_key(c,e=!0),await I.save_data_iv(u)}I.set_static_key(c),O.FIXED_IV=null!=u?u:await O.load_data_iv(),bt.slocal.set("Ekey_Hex",await b.export_key_hex(o)),bt.slocal.set("Akeypriv_Jwk",await b.export_key_jwk(_)),bt.slocal.set("Akeypub_Jwk",await b.export_key_jwk(l))}static clear_keys(){bt.slocal.clear("Ekey_Hex"),bt.slocal.clear("Akeypriv_Jwk"),bt.slocal.clear("Akeypub_Jwk")}static async set_user_and_pw(t,e){var a=await I.load_static_key();if(null==a)return new Error("failed-to-load-static-key");I.set_static_key(a);var[r,s]=await I.get_key_chain(t,e);let n;I.set_ea_keys(r,s),await I.save_static_key(a,n=!0)}static async get_key_chain(t,e){t=t.trim(),e=e.trim(),S(`[EI] Creating key chain, ${I.ITERATIONS} iterations`);var a=performance.now(),r=await b.digest_sha256(t),[s,n]=await b.password2keys(e,r,I.ITERATIONS),o=performance.now();return S(`[EI] Key chain made in ${(o-a)/1e3} seconds`),[s,n]}static async get_new_static_key(t){t=t.trim();var e=await b.digest_sha256(t);return await b.make_static_key(e,1e3)}static async gen_recovery_info(t,e){var a=await b.generate_key_aes(),r=await b.export_key_hex(t),s=await b.export_key_jwk(e.privateKey),n=`${r}::${b.base64url_to_hex(s.d)}::${b.base64url_to_hex(s.x)}::${b.base64url_to_hex(s.y)}`,[o,i]=await b.encrypt_aes(n,a);return{Ciphertext:o,Iv:i,Recovery_Key:a}}static async save_recovery_info(t,e){var a=await bt.reopen(),r=a.transaction("_meta",bt.RW).store1(),s={Etdr_Recovery:t,Etdr_Recovery_Iv:e};await I.update_global_meta(r,s),a.close()}static async recover_key_chain(t,e,a){var r=await b.decrypt_aes(t,e,a);if(null==r)return null;var[s,n,o,i]=r.split("::"),_=await b.import_key_aes_raw(s),l=await b.generate_keys_ec_sv(),c=await b.export_key_jwk(l.privateKey),u=await b.export_key_jwk(l.publicKey);c.d=b.hex_to_base64url(n),c.x=b.hex_to_base64url(o),c.y=b.hex_to_base64url(i),u.x=b.hex_to_base64url(o),u.y=b.hex_to_base64url(i);var d={};return d.privateKey=await b.import_key_ec_jwk(c),d.publicKey=await b.import_key_ec_jwk(u),[_,d]}static async recover_and_set_keys(t){if(t instanceof CryptoKey){var e=await bt.reopen(),a=e.transaction("_meta",bt.RO).store1(),r=await I.load_global_meta(a);if(null==r)return x("[EI] idbxs.recover_and_set_keys: Bad global metadata:",r),void e.close();var s=r.Etdr_Recovery,n=r.Etdr_Recovery_Iv;if(null==s||null==n)return x("[EI] idbxs.recovery_and_set_keys: No or bad recovery data in global metadata"),void e.close();var[o,i]=await I.recover_key_chain(s,n,t);if(!(null!=o&&null!=i&&o instanceof CryptoKey&&i.privateKey instanceof CryptoKey&&i.publicKey instanceof CryptoKey))return x("[EI] idbxs.recovery_and_set_keys: Failed to recover keys, found:",o,i),void e.close();var _=r.Etde_Skey,l=r.Etde_Skey_Iv,c=await b.decrypt_aes(_,l,o);if(null==c)return x("[EI] idbxs.recovery_and_set_keys: Failed to decrypt for static key"),void e.close();var u=await b.import_key_aes_raw(c);return I.set_ea_keys(o,i),I.set_static_key(u),e.close(),[o,i]}x("[EI] idbxs.recover_and_set_keys: First param is not CryptoKey")}static get_micro_dict(){var t=["a","e","i","o","u","y"],e=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","z"],a=[],r=[];for(let r of e)for(let e of t)a.push(r+e);for(let a of t)for(let t of e)r.push(a+t);var s=[],n=a.length-1;for(let t=0;t<120;t++)t%8==0?s.push(a[t]):t%8==1?s.push(r[t]):t%8==2?s.push(a[t]+a[n-t]):t%8==3?s.push(a[t]+r[t]):t%8==4?s.push(r[t]+a[t]):t%8==5?s.push(r[t]+r[n-t]):t%8==6?s.push(a[t]+r[t]+r[n-t]):t%8==7&&s.push(r[t]+a[t]+a[n-t]);s=Array.from(new Set(s)).sort();var o=[];for(let t of s)o.push(t),o.push(t.split("").reverse().join(""));o=Array.from(new Set(o)).sort();var i=[...o],_=256-o.length;for(let t=0;t<_;t++){let e=Math.floor(o.length/_*t);i.push(o[e]+o[e+1])}return Array.from(new Set(i)).sort()}static#a(t,e){for(let a=0;a<e;a++){let e=[...t.matchAll(/[\s]+/g)].map((t=>t.index)),a=e[Math.floor(Math.random()*e.length)],r=t.split("");r[a]=".",t=r.join("")}return t}static#r(t,e){for(let a=0;a<e;a++){let e=[...t.matchAll(/[\s]+/g)].map((t=>t.index)),a=e[Math.floor(Math.random()*e.length)],r=t.split("");r[a]=",",t=r.join("")}return t}static#s(t){var e=(t=t.replaceAll(",",", ")).split(".");for(let t=0;t<e.length;t++)e[t]=e[t].charAt(0).toUpperCase()+e[t].substring(1);return(t=e.join(". "))+"."}static async key_to_text(t){var e=await b.export_key_hex(t),a=I.get_micro_dict(),r=b.hex_to_bytes(e),s=[];for(let t=0;t<r.byteLength;t++)s.push(a[r[t]]);var n=s.join(" ");return n=I.#a(n,4),n=I.#r(n,8),I.#s(n)}static async text_to_key(t){var e=(t=(t=(t=t.toLowerCase().replaceAll(/[^a-z]+/g," ")).trim()).replaceAll(/[\s]{2,}/g," ")).split(" "),a=I.get_micro_dict(),r=new Uint8Array(32);for(let t of e)if(-1==a.indexOf(t))return void x("[EI] idbxs.text_to_key: Invalid word:",t);for(let t=0;t<e.length;t++){let s=e[t],n=a.indexOf(s);r[t]=n}var s=b.bytes_to_hex(r);return await b.import_key_aes_raw(s)}static init(){I.cruds=g,I.op_hists=v,I.ftss=E,I.cruds.init(),I.op_hists.init(),I.ftss.init()}}const O=I,A=O,N=(console.log,console.warn),T=console.error;class R{static enabled=!1;static score_rate=2;static enable_fts(){R.enabled=!0}static disable_fts(){R.enabled=!1}static str_to_unique_words(t){var e=(t=(t=(t=t.toLowerCase()).replace(/[^0-9A-Za-z_\-]/g," ")).replace(/[\s]{2,}/g," ").trim()).split(" ");return Array.from(new Set(e))}static obj_to_unique_words(t){var e=o.obj_to_valuestr(t);return R.str_to_unique_words(e)}static async obj_exists(t,e,a){var r=t.index(e);return null!=await r.get_key(bt.value_is(a))}static async increase_num_objs(t,e,a){var r=await t.index("Store,Word").get(bt.value_is([e,a]));r.num_obj_ids++,await t.put(r)}static async decrease_num_objs(t,e,a){var r=await t.index("Store,Word").get(bt.value_is([e,a]));r.num_obj_ids>0&&r.num_obj_ids--,r.num_obj_ids>0?await t.put(r):await t.delete(bt.value_is(r.id))}static async update_fts(t,e,a,r,s=!1){if(-1!=["create","update","delete"].indexOf(t)){if(s)var n="#fts_words",o="#fts_ids";else n="fts_words",o="fts_ids";var i=R.obj_to_unique_words(r);if(s)for(let t=0;t<i.length;t++){let e=(await b.encrypt_aes_fiv(i[t],A.Skey))[0];i[t]=e}var _=await V.reopen(),l=_.transaction([n,o],bt.RW),c=l.object_store(n),u=l.object_store(o);for(let r of i)await R.obj_exists(c,"Store,Word",[e,r])||await c.add({Store:e,Word:r,num_obj_ids:0}),"create"==t?(await u.add({Store:e,Word:r,obj_id:a}),await R.increase_num_objs(c,e,r)):"update"==t?await R.obj_exists(u,"Store,Word,obj_id",[e,r,a])||(await u.add({Store:e,Word:r,obj_id:a}),await R.increase_num_objs(c,e,r)):(await u.index("Store,Word,obj_id").delete(bt.value_is([e,r,a])),await R.decrease_num_objs(c,e,r));var d=await u.index("Store,obj_id").get_all(bt.value_is([e,a])),f=(d=d.map((t=>t.Word))).filter((t=>-1==i.indexOf(t)));for(let t of f)await u.index("Store,Word,obj_id").delete(bt.value_is([e,t,a])),await R.decrease_num_objs(c,e,t);_.close()}else T("[EI] fts.update_fts: Bad operation:",t)}static update_fts_c(t,e,a,r=!1){R.enabled&&R.update_fts("create",t,e,a,r)}static update_fts_r(t,e,a,r=!1){}static update_fts_u(t,e,a,r=!1){R.enabled&&R.update_fts("update",t,e,a,r)}static update_fts_d(t,e,a,r=!1){R.enabled&&R.update_fts("delete",t,e,a,r)}static async#a(t,e,a,r){var s=e.Name,n=[];await t.index("Store,Word").open_cursor(bt.value_is([s,a]),"next",(t=>{if(n.push(t.value.obj_id),n.length>=r)return bt._stop}));var o=[];for(let t of n){let a=await e.get(bt.value_is(t));null!=a?o.push(a):N("[EI] fts.#term_to_objs: Found bad id:",t)}return o}static#t(t,e){var a=[],r={},s=1;for(let t=e.length-1;t>=0;t--)r[e[t]]=s,s<Number.MAX_SAFE_INTEGER/R.score_rate&&(s*=R.score_rate);for(let s of t){let t={Object:s,score:0},n=o.obj_to_valuestr(s).toLowerCase(),i=0;for(let t of e){let e=o.escape_for_regex(t);i+=r[t]*(n.match(new RegExp(e,"g"))||[]).length}t.score=i,a.push(t)}return a.sort(((t,e)=>e.score-t.score))}static async find_many_by_terms(t,e,a=1e3,r=!1){if(0==R.enabled&&N("[EI] fts.find_many_by_terms: FTS is disabled, there might be results but no changes."),r)var s="#fts_words",n="#fts_ids";else s="fts_words",n="fts_ids";var o=R.str_to_unique_words(e);if(r)for(let t=0;t<o.length;t++)o[t]=(await b.encrypt_aes_fiv(o[t],A.Skey))[0];var i=await bt.reopen(),_=i.transaction([s,n,t],bt.RO),l=_.object_store(s),c=_.object_store(n),u=_.object_store(t),d=[],f=[];for(let e of o){let a=await l.index("Store,Word").get(bt.value_is([t,e]));if(null==a){d.push(e);continue}let r={Term:e,exists:!0,size:a.num_obj_ids};f.push(r)}var y="More specific terms are listed first in Search_Terms; higher score items are listed first.";if(0==f.length)return{Items:[],Search_Terms:[],Excluded_Terms:d,Note:y};if(1==f.length){let t=f[0].Term,e=await R.#a(c,u,t,a);return{Items:R.#t(e,[t]),Search_Terms:[t],Excluded_Terms:d,Note:y}}var p=(f=f.sort(((t,e)=>t.size-e.size))).map((t=>t.Term)),w=f[0].Term,h=f.slice(1).map((t=>t.Term)),g=[];await c.index("Store,Word").open_cursor(bt.value_is([t,w]),"next",(async e=>{var a=e.value.obj_id,r=!0;for(let e of h)if(0==await c.index("Store,Word,obj_id").count(bt.value_is([t,e,a]))){r=!1;break}r&&g.push(a)}));var v=[];for(let t of g){let e=await u.get(bt.value_is(t));null!=e?v.push(e):N("[EI] fts.find_many_by_terms: Found bad id:",t)}var m=R.#t(v,p);return i.close(),{Items:m,Search_Terms:p,Excluded_Terms:d,Note:y}}static init(){}}const D=R;console.log,console.warn;var K=console.error,F=a.new_lock,C=(JSON.parse,JSON.stringify);class U{static async insert_one(t,e,a=!1,r=null){var s=await bt.reopen(),n=s.transaction(t,bt.RW).store1(),o={...e};delete o.id;var i=await n.add(o);return i instanceof Error?(K("[EI] crud.insert_one: Failed, error:",i),null==n&&s.close(),null):(c.update_op_hist_c(n.Name,[i]),a?E.update_fts_c(n.Name,i,r):D.update_fts_c(n.Name,i,e),null==n&&s.close(),i)}static async insert_many(t,e,a=!1,r=null){var s=await bt.reopen(),n=s.transaction(t,bt.RW).store1(),o=[],[i,_]=F();if(null==e||0==e.length)return s.close(),[];for(let t of e){let a={...t};delete a.id;let r=n.self.add(a);r.onerror=t=>{K("[EI] crud.insert_many: Failed to add object, error:",t.target.error),o.push(null),o.length==e.length&&_()},r.onsuccess=t=>{o.push(t.target.result),o.length==e.length&&_()}}await i;for(let t=0;t<o.length;t++)a?E.update_fts_c(n.Name,o[t],r[t]):D.update_fts_c(n.Name,o[t],e[t]);return s.close(),o}static async get_1stcond_obj(t,e){var a=Object.keys(e),r=t.index(a[0]);if(r instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",a[0]),null;var s=e[a[0]];return await r.get(s)}static async get_1stcond_objs(t,e){var a=Object.keys(e),r=t.index(a[0]);if(r instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",a[0]),null;var s=e[a[0]];return await r.get_all(s)}static async intersect_cond(t,e){var a=Object.keys(e);if(0==a.length)return[];var r=[];for(let s of a){let a=t.index(s);if(a instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",s),null;let n=e[s],o=(await a.get_all(n)).map((t=>t.id));r.push(o)}return o.intersect_arrs(r)}static async intersect_cond_getobjs(t,e){var a=Object.keys(e);if(0==a.length)return[];var r=[],s={};for(let n of a){let a=t.index(n);if(a instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",n),null;let o=e[n],i=(await a.get_all(o)).map((t=>(s[t.id]=t,t.id)));r.push(i)}return o.intersect_arrs(r).map((t=>s[t]))}static async exists(t,e,a=!1){var r=await bt.reopen(),s=r.transaction(t,bt.RO).store1(),n=Object.keys(e);if(0==n.length)return r.close(),[];if(1==n.length){let t=await U.get_1stcond_obj(s,e);return r.close(),null!=t}var o=await U.intersect_cond(s,e);return r.close(),o.length>0}static async count(t,e,a=!1){var r=await bt.reopen(),s=r.transaction(t,bt.RO).store1(),n=Object.keys(e);if(0==n.length)return r.close(),null;if(1==n.length){let t=await U.get_1stcond_objs(s,e);return r.close(),t.length}var o=await U.intersect_cond(s,e);return r.close(),o.length}static async count_all(t,e=!1){var a=await bt.reopen(),r=a.transaction(t,bt.RO).store1(),s=await r.count();return a.close(),s}static async find_one(t,e,a=!1){var r=await bt.reopen(),s=r.transaction(t,bt.RO).store1(),n=Object.keys(e);if(0==n.length)return r.close(),null;if(1==n.length){let t=await U.get_1stcond_obj(s,e);return null==t?(r.close(),null):(c.update_op_hist_r(s.Name,[t.id]),r.close(),t)}var o=await U.intersect_cond(s,e);if(0==o.length)return r.close(),null;var i=await s.get(bt.value_is(o[0]));return c.update_op_hist_r(s.Name,o),r.close(),i}static async find_many(t,e,a=Number.MAX_SAFE_INTEGER,r=!1){var s=await bt.reopen(),n=s.transaction(t,bt.RO).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;if(1==o.length){let t=await U.get_1stcond_objs(n,e);return s.close(),t}var i=await U.intersect_cond(n,e);if(null==i||0==i.length)return s.close(),[];var _=[],[l,c]=F();for(let t of i){let e=n.self.get(bt.value_is(t).self);e.onerror=t=>{_.push(null),_.length==i.length&&c(),_.length>=a&&c()},e.onsuccess=t=>{_.push(t.target.result),_.length==i.length&&c(),_.length>=a&&c()}}return await l,s.close(),_}static async find_all(t,e=!1){var a=await bt.reopen(),r=a.transaction(t,bt.RO).store1(),s=await r.get_all();return a.close(),s}static get_proppath_value(t,e){var a=e.split("."),r=t;for(let t of a){if(null==r[t])return null;r=r[t]}return r}static obj_matches_cond(t,e){for(let a in e){let r=e[a],s=U.get_proppath_value(t,a);if(null==s)return!1;if(-1==C(s).indexOf(r))return!1}return!0}static async filter(t,e,a=Number.MAX_SAFE_INTEGER,r=!1){var s=await bt.reopen(),n=s.transaction(t,bt.RO).store1(),o=[];return await n.open_cursor(bt.range_gte(0),"next",(t=>{var r=t.value;if(U.obj_matches_cond(r,e)&&o.push(r),o.length>=a)return bt._stop})),s.close(),o}static async update_one(t,e,a,r=!1,s=null){var n=await bt.reopen(),o=n.transaction(t,bt.RW).store1(),i=Object.keys(e);if(0==i.length)return n.close(),null;let _={...a};if(delete _.id,1==i.length){let t=await U.get_1stcond_obj(o,e);return null==t?(n.close(),null):(t={...t,..._},o.put(t),c.update_op_hist_u(o.Name,[t.id]),r?E.update_fts_u(o.Name,t.id,s):D.update_fts_u(o.Name,t.id,t),n.close(),t)}var l=await U.intersect_cond(o,e);if(null==l||0==l.length)return n.close(),null;var u=await o.get(bt.value_is(l[0]));return null==u?(n.close(),null):(u={...u,..._},await o.put(u),c.update_op_hist_u(o.Name,[u.id]),r?E.update_fts_u(o.Name,u.id,u):D.update_fts_u(o.Name,u.id,u),n.close(),u)}static async update_many(t,e,a,r=Number.MAX_SAFE_INTEGER,s=!1){var n=await bt.reopen(),o=n.transaction(t,bt.RW).store1(),i=Object.keys(e);if(0==i.length)return n.close(),null;let _={...a};if(delete _.id,1==i.length){if(null==(l=await U.get_1stcond_objs(o,e)))return n.close(),null;if(0==l.length)return n.close(),[]}else{var l;if(null==(l=await U.intersect_cond_getobjs(o,e)))return n.close(),null;if(0==l.length)return n.close(),[]}let c=[],[u,d]=F();for(let t of l){let e={...t,..._},a=o.self.put(e);a.onerror=e=>{K("[EI] crud.update_many: Failed to update object:",t),c.push(null),c.length==l.length&&d(),c.length>=r&&d()},a.onsuccess=t=>{c.push({...e,id:t.target.result}),c.length==l.length&&d(),c.length>=r&&d()}}await u;for(let t=0;t<c.length;t++)s||D.update_fts_u(o.Name,c[t].id,c[t]);return n.close(),c}static async upsert_one(t,e,a,r=!1,s=null){var n=await bt.reopen(),o=n.transaction(t,bt.RW).store1(),i=Object.keys(e);if(0==i.length)return n.close(),null;let _={...a};if(delete _.id,1==i.length){let t=await U.get_1stcond_obj(o,e);if(null==t){let t=await o.add(_);return c.update_op_hist_c(o.Name,[t]),r?E.update_fts_c(o.Name,t,s):D.update_fts_c(o.Name,t,a),n.close(),t}return t={...t,..._},o.put(t),c.update_op_hist_u(o.Name,[t.id]),r?E.update_fts_u(o.Name,t.id,s):D.update_fts_u(o.Name,t.id,t),n.close(),t.id}var l=await U.intersect_cond(o,e);if(null==l||0==l.length)return n.close(),null;var u=await o.get(bt.value_is(l[0]));if(null==u){let t=await o.add(_);return c.update_op_hist_c(o.Name,[t]),r?E.update_fts_c(o.Name,t,s):D.update_fts_c(o.Name,t,a),n.close(),t}return u={...u,..._},o.put(u),c.update_op_hist_u(o.Name,[u.id]),r?E.update_fts_u(o.Name,u.id,s):D.update_fts_u(o.Name,u.id,u),n.close(),u.id}static async remove_one(t,e,a=!1,r=null){var s=await bt.reopen(),n=s.transaction(t,bt.RW).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;if(1==o.length){let t=await U.get_1stcond_obj(n,e);if(null==t)return s.close(),null;let o=await n.delete(bt.value_is(t.id));return c.update_op_hist_d(n.Name,[t.id]),a?E.update_fts_d(n.Name,t.id,r):D.update_fts_d(n.Name,t.id,t),s.close(),o}var i=await U.intersect_cond_getobjs(n,e),_=i.map((t=>t.id));if(null==_||0==_.length)return s.close(),null;var l=await n.delete(bt.value_is(_[0]));return c.update_op_hist_d(n.Name,[_[0]]),a?E.update_fts_d(n.Name,_[0],r):D.update_fts_d(n.Name,_[0],i[0]),s.close(),l}static async remove_many(t,e,a=!1,r=null){var s=await bt.reopen(),n=s.transaction(t,bt.RW).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;var i=[],_=[];if(1==o.length){if(i=await U.get_1stcond_objs(n,e),_=i.map((t=>t.id)),null==i||0==i.length)return s.close(),null}else if(i=await U.intersect_cond_getobjs(n,e),null==(_=i.map((t=>t.id)))||0==_.length)return s.close(),null;var[l,c]=F(),u=0;for(let t of _){let e=n.self.delete(bt.value_is(t).self);e.onerror=t=>{++u==_.length&&c()},e.onsuccess=t=>{++u==_.length&&c()}}await l;for(let t=0;t<_.length;t++)a?E.update_fts_d(n.Name,_[t],r[t]):D.update_fts_d(n.Name,_[t],i[t]);return s.close(),null}static async remove_all(t){var e=await bt.reopen(),a=e.transaction(t,bt.RW).store1(),[r,s]=F(),n=a.self.delete(bt.range_gte(0).self);return n.onerror=t=>{K("[EI] crud.remove_all: Failed to delete, event:",t),s()},n.onsuccess=t=>{s()},await r,e.close(),null}static init(){}}const W=U;var P=console.log,B=(console.warn,console.error),M=JSON.stringify,H=JSON.parse,L={_meta:{Store:3},op_hist:{Store_Name:1},"#op_hist":{},fts_words:{Store:1,Word:1,"Store,Word":3,num_obj_ids:1},fts_ids:{Store:1,Word:1,"Store,Word":1,obj_id:1,"Store,obj_id":1,"Store,Word,obj_id":3},"#fts_words":{Store:1,Word:1,"Store,Word":3,num_obj_ids:1},"#fts_ids":{Store:1,Word:1,"Store,Word":1,obj_id:1,"Store,obj_id":1,"Store,Word,obj_id":3}};class G{SUB_NAMESPACES;static crud;static op_hist;static fts;PROPERTIES;static Indices={};METHODS;static#a(t,e){return null!=localStorage.Unused_Stores&&0!=localStorage.Unused_Stores.trim().length&&-1!=t.Object_Store_Names.indexOf(e)&&H(localStorage.Unused_Stores).indexOf(e)>=0}static#t(t){if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)return!1;var e=t.Object_Store_Names,a=H(localStorage.Unused_Stores),r=[];for(let t of a)e.indexOf(t)>=0&&r.push(t);localStorage.Unused_Stores=M(r)}static#n(t,e){if("add"==t)if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)localStorage.Unused_Stores=M([e]);else{let t=H(localStorage.Unused_Stores);t=Array.from(new Set([...t,e])),localStorage.Unused_Stores=M(t)}else if("remove"==t)if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)localStorage.Unused_Stores=M([]);else{let t=H(localStorage.Unused_Stores),a=t.indexOf(e);a>=0&&t.splice(a,1),localStorage.Unused_Stores=M(t)}}static indexname_to_keypath(t){return t.indexOf(",")>=0?t.split(","):t}static keypath_to_indexname(t){return t.constructor===Array?t.join(","):t}static async db_exists(t){return-1!=(await r.databases()).map((t=>t.name)).indexOf(t)}static async get_cur_indices(t){if(!await $.db_exists(t))return{};var e=await r.open(t),a={},s=e.transaction(e.Object_Store_Names,bt.RO);for(let t of e.Object_Store_Names){if(G.#a(e,t))continue;let r=s.object_store(t);a[t]={};for(let e of r.Index_Names){let s=r.index(e),o=s.Key_Path;var n=G.keypath_to_indexname(o);let i,_=s.unique,l=s.multientry;0==_&&0==l?i=1:0==_&&1==l?i=2:1==_&&0==l?i=3:1==_&&1==l&&(i=4),a[t][n]=i}}return e.close(),a}static add_more_indices(t){return{...t,...L}}static indices2str(t){var e=[];for(let a in t)for(let r in t[a]){let s=t[a][r];e.push(`${a}/${r}:${s};`)}return e.sort(),e.join("")}static async get_cur_db_ver(t){var e=await r.open(t),a=e.version;return e.close(),a}static async upgrade_db(t,e,a){if(await $.db_exists(t))var s=await G.get_cur_db_ver(t)+1;else s=1;P("[EI] idbx.upgrade_db: Upgrading to version",s);var n=await r.open(t,s),o=Object.keys(e),i=Object.keys(a),_=[];for(let t of o)-1==i.indexOf(t)&&_.push(t);for(let t of _)P("[EI] idbx.upgrade_db: Found unused store:",t),G.#n("add",t);var l=[];for(let t of i)-1==o.indexOf(t)&&(G.#a(n,t)?(e[t]={},G.#n("remove",t)):l.push(t));for(let t of l){P("[EI] idbx.upgrade_db: Creating new store:",t);let e=n.create_object_store(t);for(let r in a[t]){let s=a[t][r],n=G.indexname_to_keypath(r);P("[EI] idbx.upgrade_db: Creating new index:",t,"/",r),e.create_index(r,n,s)}}var c=[],u=Array.from(new Set([...o,...i]));for(let t of u)-1==_.indexOf(t)&&-1==l.indexOf(t)&&c.push(t);var d=n.Transaction;for(let t of c){let r=d.object_store(t),s=Object.keys(e[t]),n=Object.keys(a[t]),o=[],i=[];for(let e of s)-1==n.indexOf(e)&&(P("[EI] idbx.upgrade_db: Deleting unused index:",t,"/",e),r.delete_index(e),o.push(e));for(let e of n)if(-1==s.indexOf(e)){let s=a[t][e],n=G.indexname_to_keypath(e);P("[EI] idbx.upgrade_db: Creating new index:",t,"/",e),r.create_index(e,n,s),i.push(e)}let _=[],l=Array.from(new Set([...s,...n]));for(let t of l)-1==o.indexOf(t)&&-1==i.indexOf(t)&&_.push(t);for(let s of _)if(a[t][s]!=e[t][s]){let e=a[t][s],n=G.indexname_to_keypath(s);P("[EI] idbx.upgrade_db: Updating index to new type:",t,"/",s+":"+e),r.delete_index(s),r.create_index(s,n,e)}}n.close()}static async open_av(t,e){if(null!=t){if(null!=e){e=G.add_more_indices(e);for(let t in e)e[t].id=3;G.Indices=e;var a=(await r.databases()).map((t=>t.name));bt._Db_Name=t;var s=e;if(a.indexOf(t)>=0)var n=await G.get_cur_indices(t);else n={};var o=G.indices2str(n);if(G.indices2str(s)==o)return await r.open(t);await G.upgrade_db(t,n,s);var i=await r.open(t);return G.#t(i),i}B("[EI] idbx.open_av: Indices name cannot be null")}else B("[EI] idbx.open_av: Db name cannot be null")}static async reopen(t=null){return null==t?await r.open(bt._Db_Name):await r.open(t)}static num_db_cons(){return bt._num_db_cons}static set_db(t){bt._Db_Name=t}static async get_prop(t,e){if(null!=bt._Db_Name&&0!=bt._Db_Name.trim().length)return(await r.open(bt._Db_Name)).transaction(t,bt.RW).store1()[e];B("[EI] idbx.get_prop: Call 'idb.open', 'idbx.open_av', or 'idbx.set_db' first")}static async do_op(t,e,...a){if(null!=bt._Db_Name&&0!=bt._Db_Name.trim().length){var s=(await r.open(bt._Db_Name)).transaction(t,bt.RW).store1();return await s[e](...a)}B("[EI] idbx.do_op: Call 'idb.open', 'idbx.open_av', or 'idbx.set_db' first")}static async del_obj_store(t,e){var a=await G.get_cur_db_ver(t)+1,s=await r.open(t,a);s instanceof Error?B(`[EI] idbx.del_obj_store: Failed to delete object store '${e}' in db '${t}', error:`,s):(await s.delete_object_store(e),G.#n("remove",e),s.close())}static init(){G.crud=W,G.op_hist=c,G.fts=D,G.crud.init(),G.op_hist.init(),G.fts.init()}}const $=G,V=$;console.log,console.warn;var q=console.error;const X=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get Lower(){return this.self.lower}get Lower_Open(){return this.self.lowerOpen}get Upper(){return this.self.upper}get Upper_Open(){return this.self.upperOpen}METHODS;includes(t){try{return this.self.includes(t.self)}catch(t){return q("[EI] key_range.includes: Error:",t),t}}};console.log,console.warn,console.error,console.log,console.warn;var J=console.error;const z=a.new_lock,Z=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get Key_Path(){return this.self.keyPath}get multientry(){return this.self.multiEntry}get Name(){return this.self.name}get Object_Store(){return new et(this.self.objectStore)}get unique(){return this.self.unique}METHODS;async count(t){try{if(null==t)var e=this.self.count();else e=t.constructor==X?this.self.count(t.self):this.self.count(t);var[a,r]=z();return e.onerror=t=>{r(t.target.error)},e.onsuccess=t=>{r(t.target.result)},await a}catch(t){return J("[EI] index.count: Error:",t),t}}async get(t){try{if(null==t)var e=this.self.get();else e=t.constructor==X?this.self.get(t.self):this.self.get(t);var[a,r]=z();return e.onerror=t=>{r(t.target.error)},e.onsuccess=t=>{r(t.target.result)},await a}catch(t){return J("[EI] index.get: Error:",t),t}}async get_all(t,e){try{if(null==t)var a=this.self.getAll();else a=t.constructor==X?this.self.getAll(t.self,e):this.self.getAll(t,e);var[r,s]=z();return a.onerror=t=>{s(t.target.error)},a.onsuccess=t=>{s(t.target.result)},await r}catch(t){return J("[EI] index.get_all: Error:",t),t}}async get_all_keys(t,e){try{if(null==t)var a=this.self.getAllKeys();else a=t.constructor==X?this.self.getAllKeys(t.self,e):this.self.getAllKeys(t,e);var[r,s]=z();return a.onerror=t=>{s(t.target.error)},a.onsuccess=t=>{s(t.target.result)},await r}catch(t){return J("[EI] index.get_all_keys: Error:",t),t}}async get_key(t){try{if(null==t)var e=this.self.getKey();else e=t.constructor==X?this.self.getKey(t.self):this.self.getKey(t);var[a,r]=z();return e.onerror=t=>{r(t.target.error)},e.onsuccess=t=>{r(t.target.result)},await a}catch(t){return J("[EI] index.get_key: Error:",t),t}}async open_cursor(t,e="next",a){try{if(null==t)var r=this.self.openCursor();else r=t.constructor==X?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[s,n]=z();return r.onerror=function(t){n(t.target.error)},r.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await a(e)?n():e.continue():n(null)},await s}catch(t){return J("[EI] index.open_cursor: Error:",t),t}}async open_key_cursor(t,e="next",a){try{if(null==t)var r=this.self.openCursor();else r=t.constructor==X?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[s,n]=z();return r.onerror=function(t){n(t.target.error)},r.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await a(e)?n():e.continue():n(null)},await s}catch(t){return J("[EI] index.open_key_cursor: Error:",t),t}}EXTENDED_METHODS(){}async delete(t){var e=0;return await this.open_cursor(t,"next",(t=>{t.delete(),e++})),e}};var Y=console.log,Q=(console.warn,console.error),tt=a.new_lock;const et=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get auto_increment(){return this.self.autoIncrement}get Index_Names(){return[...this.self.indexNames]}get Key_Path(){return this.self.keyPath}get Name(){return this.self.name}get Transaction(){return new rt(this.self.transaction)}METHODS;async add(t){try{var e=this.self.add(t),[a,r]=tt();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return Q("[EI] object_store.add: Error:",t),t}}async clear(){try{var t=this.self.clear(),[e,a]=tt();return t.onerror=function(t){a(t.target.error)},t.onsuccess=function(t){a(t.target.result)},await e}catch(t){return Q("[EI] object_store.clear: Error:",t),t}}async count(t){try{if(null==t)var e=this.self.count();else e=t.constructor==X?this.self.count(t.self):this.self.count(t);var[a,r]=tt();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return Q("[EI] object_store.count: Error:",t),t}}create_index(t,e,a){try{if(a==bt.n1)var r={unique:!1,multiEntry:!1};else a==bt.n2?r={unique:!1,multiEntry:!0}:a==bt.u1?r={unique:!0,multiEntry:!1}:a==bt.u2&&(r={unique:!0,multiEntry:!0});return new Z(this.self.createIndex(t,e,r))}catch(t){return Q("[EI] object_store.create_index: Error:",t),t}}async delete(t){try{if(t.constructor==X)var e=this.self.delete(t.self);else e=this.self.delete(t);var[a,r]=tt();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return Q("[EI] object_store.delete: Error:",t),t}}delete_index(t){try{this.self.deleteIndex(t)}catch(t){return Q("[EI] object_store.delete_index: Error:",t),t}}async get(t){try{if(null==t)var e=this.self.get();else e=t.constructor==X?this.self.get(t.self):this.self.get(t);var[a,r]=tt();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return Q("[EI] object_store.get: Error:",t),t}}async get_all(t){try{if(null==t)var e=this.self.getAll();else e=t.constructor==X?this.self.getAll(t.self):this.self.getAll(t);var[a,r]=tt();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return Q("[EI] object_store.get_all: Error:",t),t}}async get_all_keys(t,e){try{if(null==t)var a=this.self.getAllKeys();else a=t.constructor==X?this.self.getAllKeys(t.self,e):this.self.getAllKeys(t,e);var[r,s]=tt();return a.onerror=function(t){s(t.target.error)},a.onsuccess=function(t){s(t.target.result)},await r}catch(t){return Q("[EI] object_store.get_all_keys: Error:",t),t}}async get_key(t){try{if(null==t)var e=this.self.getKey();else e=t.constructor==X?this.self.getKey(t.self):this.self.getKey(t);var[a,r]=tt();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(t.target.result)},await a}catch(t){return Q("[EI] object_store.get_key: Error:",t),t}}index(t){try{return new Z(this.self.index(t))}catch(t){return Q("[EI] object_store.index: Error:",t),t}}async open_cursor(t,e="next",a){try{if(null==t)var r=this.self.openCursor();else r=t.constructor==X?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[s,n]=tt();return r.onerror=function(t){n(t.target.error)},r.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await a(e)?n():e.continue():n(null)},await s}catch(t){return Q("[EI] object_store.open_cursor: Error:",t),t}}async open_key_cursor(t,e="next",a){try{if(null==t)var r=this.self.openKeyCursor();else r=t.constructor==X?this.self.openKeyCursor(t.self,e):this.self.openKeyCursor(t,e);var[s,n]=tt();return r.onerror=function(t){n(t.target.error)},r.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await a(e)?n():e.continue():n(null)},await s}catch(t){return Q("[EI] object_store.open_key_cursor: Error:",t),t}}async put(t,e,a=!0,r){try{if(null==e)var s=this.self.put(t);else e.constructor==X?s=this.self.put(t,e.self):(Y(t,e),s=this.self.put(t,e));var[n,o]=tt();return s.onerror=function(t){0==a&&r(t.target.error),o(t.target.error)},s.onsuccess=function(t){0==a&&r(t.target.result),o(t.target.result)},a?await n:void 0}catch(t){return Q("[EI] object_store.put: Error:",t),t}}};console.log,console.warn;var at=console.error;const rt=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get Db(){return new nt(this.self.db)}get Durability(){return this.self.durability}get Error(){return this.self.error}get Mode(){return this.self.mode}get Object_Store_Names(){return[...this.self.objectStoreNames]}EVENTS;set on_abort(t){this.self.onabort=t}set on_complete(t){this.self.oncomplete=t}set on_error(t){this.self.onerror=t}METHODS;abort(){try{this.self.abort()}catch(t){return at("[EI] transaction.abort: Error:",t),t}}commit(){try{this.self.commit()}catch(t){return at("[EI] transaction.commit: Error:",t),t}}object_store(t){try{var e=this.self.objectStore(t);return new et(e)}catch(t){return at("[EI] transaction.object_store: Error:",t),t}}ADDITIONAL_METHODS;store1(){return this.object_store([...this.self.objectStoreNames][0])}};console.log,console.warn;var st=console.error;const nt=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get Name(){return this.self.name}get Object_Store_Names(){return[...this.self.objectStoreNames]}get version(){return this.self.version}EVENTS;set on_close(t){this.self.onclose=t}set on_version_change(t){this.self.onversionchange=t}METHODS;close(){return bt._num_db_cons-=1,this.self.close()}create_object_store(t){try{return new et(this.self.createObjectStore(t,{keyPath:"id",autoIncrement:!0}))}catch(t){return st("[EI] database.create_object_store: Error:",t),t}}delete_object_store(t){try{return this.self.deleteObjectStore(t)}catch(t){return st("[EI] database.delete_object_store: Error:",t),t}}transaction(t,e,a){try{return new rt(this.self.transaction(t,e,a))}catch(t){return st("[EI] database.transaction: Error:",t),t}}};var ot=console.log,it=console.warn,_t=console.error,lt=a.new_lock;console.log,console.warn,console.error;const ct=class{static keys(){return Object.keys(localStorage)}static set(t,e){try{var a=o.obj_to_json(e);localStorage[t]=a}catch(t){return null}}static get(t){try{var e=localStorage[t];return o.json_to_obj_bd(e)}catch(t){return null}}static clear(t){delete localStorage[t]}};console.log,console.warn,console.error;const ut=class{static keys(){return Object.keys(sessionStorage)}static set(t,e){try{var a=o.obj_to_json(e);sessionStorage[t]=a}catch(t){return null}}static get(t){try{var e=sessionStorage[t];return o.json_to_obj_bd(e)}catch(t){return null}}static clear(t){delete sessionStorage[t]}};var dt=console.log;console.warn,console.error;class ft{SUB_NAMESPACES;static idb;static idbx;static idbxs;static sec;static wcrypto;static utils;LITERALS;static n1=1;static n2=2;static u1=3;static u2=4;CONSTANTS;static RO="readonly";static RW="readwrite";PROPERTIES;static Factory;METHODS;static databases;static open;static delete_database;static open_av;static reopen;static num_db_cons;static set_db;static get_prop;static do_op;static del_obj_store;static insert_one;static insert_many;static exists;static count;static count_all;static find_one;static find_many;static find_all;static filter;static update_one;static update_many;static upsert_one;static remove_one;static remove_many;static remove_all;static set_max_history;static get_op_hist_status;static enable_op_hist;static disable_op_hist;static get_op_hist;static clear_op_hist;static enable_fts;static disable_fts;static find_many_by_terms;static s_open_av;static s_insert_one;static s_insert_many;static s_exists;static s_count;static s_count_all;static s_find_one;static s_find_many;static s_find_all;static s_filter;static s_update_one;static s_update_many;static s_upsert_one;static s_remove_one;static s_remove_many;static s_set_max_history;static s_get_op_hist_status;static s_enable_op_hist;static s_disable_op_hist;static s_get_op_hist;static s_clear_op_hist;static s_enable_fts;static s_disable_fts;static s_find_many_by_terms;METHODS(){}static init_essential_globals(t){t&&(window.n1=ft.n1),t&&(window.n2=ft.n2),t&&(window.u1=ft.u1),t&&(window.u2=ft.u2),ft._secure=!0,t&&(window._secure=!0),ft._stop="stop",t&&(window._stop="stop");const e=ft.RO;t&&(window.RO=e);const r=ft.RW;t&&(window.RW=r),ft.WITH_LEFT=!1,t&&(window.WITH_LEFT=!1),ft.WITH_RIGHT=!1,t&&(window.WITH_RIGHT=!1),ft.NO_LEFT=!0,t&&(window.NO_LEFT=!0),ft.NO_RIGHT=!0,t&&(window.NO_RIGHT=!0);const s=t=>new X(IDBKeyRange.lowerBound(t));ft.range_gte=s,t&&(window.range_gte=s);const n=t=>new X(IDBKeyRange.lowerBound(t,!0));ft.range_gt=n,t&&(window.range_gt=n);const o=t=>new X(IDBKeyRange.upperBound(t));ft.range_lte=o,t&&(window.range_lte=o);const i=t=>new X(IDBKeyRange.upperBound(t,!0));ft.range_lt=i,t&&(window.range_lt=i);const _=(t,e,a,r)=>new X(IDBKeyRange.bound(t,e,a,r));ft.range_between=_,t&&(window.range_between=_);const l=t=>new X(IDBKeyRange.only(t));ft.value_is=l,t&&(window.value_is=l);const c=a.new_lock;ft.new_lock=c,t&&(window.new_lock=c);const u=a.stay_idle;ft.stay_idle=u,t&&(window.stay_idle=u),t&&(window.eidb=ft),ft.slocal=ct,ft.ssession=ut,t&&(window.slocal=ct),t&&(window.ssession=ut)}static init_more_globals(t){ft._add="add",t&&(window._add="add");const e="clear";ft._clear=e,t&&(window._clear=e);const a="count";ft._count=a,t&&(window._count=a);const r="create_index";ft._create_index=r,t&&(window._create_index=r);const s="delete";ft._delete=s,t&&(window._delete=s);const n="delete_index";ft._delete_index=n,t&&(window._delete_index=n),ft._get="get",t&&(window._get="get");const o="get_all";ft._get_all=o,t&&(window._get_all=o);const i="get_all_keys";ft._get_all_keys=i,t&&(window._get_all_keys=i);const _="get_key";ft._get_key=_,t&&(window._get_key=_);const l="index";ft._index=l,t&&(window._index=l);const c="open_cursor";ft._open_cursor=c,t&&(window._open_cursor=c);const u="open_key_cursor";ft._open_key_cursor=u,t&&(window._open_key_cursor=u),ft._put="put",t&&(window._put="put")}static init(t=!0){ft.idb=r,ft.idbx=V,ft.idbxs=A,ft.sec=A,ft.wcrypto=b,ft.utils=o,ft.idb.init(),ft.idbx.init(),ft.idbxs.init(),ft.wcrypto.init(),ft.utils.init(),pt.init_essential_globals(t),pt.init_more_globals(t),ft.Factory=new class{self=null;constructor(t){this.self=t}async databases(){try{return await this.self.databases()}catch(t){return _t("[EI] factory.databases: Error:",t),t}}async delete_database(t){var e=this.self.deleteDatabase(t),[a,r]=lt();return e.onerror=function(t){r(t.target.error)},e.onsuccess=function(t){r(null)},await a}async open(t,e){try{var a=this.self.open(t,e)}catch(t){return _t("[EI] idb.open: Error caught:",t),t.Status="errored",t}var[r,s]=lt(),n=null,o=null,i=null;a.onerror=function(t){n=t.target.error,s("errored")},a.onblocked=function(t){it(`[EI] idb.open: Upgrade blocked, requested to change to version ${e}`),it("[EI] Check source code, shouldn't be blocked by connections in current tab or other tabs."),it("[EI] Tip: Avoid being blocked by using temporary connections in all tabs together with IDBDatabase.versionchange event."),o=t,s("blocked"),i="blocked"},a.onupgradeneeded=function(t){if(null!=i)return it(`[EI] idb.open: Upgrade cancelled due to '${i}' event fired right previously`),void s();ot(`[EI] idb.open: Upgrade needed, to version ${e}`),s("to-upgrade"),i="to-upgrade"},a.onsuccess=function(t){if(null!=i)return it(`[EI] idb.open: Open cancelled due to '${i}' event fired right previously`),void s();s("opened")};var _=await r;if("errored"==_)return n.Status="errored",n;if("blocked"==_){let t=new Error("Upgrade is blocked by other connections, close them all first.");return t.Status="blocked",t.Event=o,t}if("to-upgrade"==_){let t=new nt(a.result);return t.to_upgrade=!0,t.Transaction=new rt(a.transaction),null==bt._num_db_cons?bt._num_db_cons=1:bt._num_db_cons+=1,t}if("opened"==_){let t=new nt(a.result);return t.to_upgrade=!1,null==bt._num_db_cons?bt._num_db_cons=1:bt._num_db_cons+=1,t}}}(window.indexedDB),ft.databases=r.databases,ft.open=r.open,ft.delete_database=r.delete_database,ft.open_av=V.open_av,ft.reopen=V.reopen,ft.num_db_cons=V.num_db_cons,ft.set_db=V.set_db,ft.get_prop=V.get_prop,ft.do_op=V.do_op,ft.del_obj_store=V.del_obj_store,ft.insert_one=V.crud.insert_one,ft.insert_many=V.crud.insert_many,ft.exists=V.crud.exists,ft.count=V.crud.count,ft.count_all=V.crud.count_all,ft.find_one=V.crud.find_one,ft.find_many=V.crud.find_many,ft.find_all=V.crud.find_all,ft.filter=V.crud.filter,ft.update_one=V.crud.update_one,ft.update_many=V.crud.update_many,ft.upsert_one=V.crud.upsert_one,ft.remove_one=V.crud.remove_one,ft.remove_many=V.crud.remove_many,ft.remove_all=V.crud.remove_all,ft.set_max_history=V.op_hist.set_max_history,ft.get_op_hist_status=V.op_hist.get_op_hist_status,ft.enable_op_hist=V.op_hist.enable_op_hist,ft.disable_op_hist=V.op_hist.disable_op_hist,ft.get_op_hist=V.op_hist.get_op_hist,ft.clear_op_hist=V.op_hist.clear_op_hist,ft.enable_fts=V.fts.enable_fts,ft.disable_fts=V.fts.disable_fts,ft.find_many_by_terms=V.fts.find_many_by_terms,ft.s_open_av=A.open_av,ft.s_insert_one=A.cruds.insert_one,ft.s_insert_many=A.cruds.insert_many,ft.s_exists=A.cruds.exists,ft.s_count=A.cruds.count,ft.s_count_all=A.cruds.count_all,ft.s_find_one=A.cruds.find_one,ft.s_find_many=A.cruds.find_many,ft.s_find_all=A.cruds.find_all,ft.s_filter=A.cruds.filter,ft.s_update_one=A.cruds.update_one,ft.s_update_many=A.cruds.update_many,ft.s_upsert_one=A.cruds.upsert_one,ft.s_remove_one=A.cruds.remove_one,ft.s_remove_many=A.cruds.remove_many,ft.s_set_max_history=A.op_hists.set_max_history,ft.s_get_op_hist_status=A.op_hists.get_op_hist_status,ft.s_enable_op_hist=A.op_hists.enable_op_hist,ft.s_disable_op_hist=A.op_hists.disable_op_hist,ft.s_get_op_hist=A.op_hists.get_op_hist,ft.s_clear_op_hist=A.op_hists.clear_op_hist,ft.s_enable_fts=A.ftss.enable_fts,ft.s_disable_fts=A.ftss.disable_fts,ft.s_find_many_by_terms=A.ftss.find_many_by_terms}}var yt=window.location;dt("[EI] EnIndex loaded"),dt("     In web page:",`${yt.protocol}//${yt.host}${yt.pathname}`),dt("     Imported as:",import.meta.url);const pt=ft,bt=pt;var wt=e.Z;export{wt as default};