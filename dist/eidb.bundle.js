var t={d:(e,r)=>{for(var a in r)t.o(r,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:r[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{Z:()=>bt}),console.log,console.warn,console.error;const r=class{static new_lock(){var t;return[new Promise(((e,r)=>{t=e})),t]}static async stay_idle(t){var e=new Promise(((e,r)=>{setTimeout((()=>{e()}),t)}));await e}};console.log,console.warn,console.error;const a=class{static async databases(){return await bt.Factory.databases()}static async open(t,e){return bt._Db_Name=t,await bt.Factory.open(t,e)}static async delete_database(t){return await bt.Factory.delete_database(t)}static init(){}},s=(console.log,console.warn,console.error);class n{static intersect_arrs(t){return t.reduce(((t,e)=>t.filter((t=>e.includes(t)))))}static#t(t){if(t.constructor!=Object)return"";var e="";for(let r in t){let a=t[r];null!=a&&(a.constructor==Object?e+=n.obj_to_valuestr(a):"string"==typeof a&&(e+=a+" "))}return e}static obj_to_valuestr(t){return n.#t(t).trim()}static obj_to_json(t){return JSON.stringify(t)}static json_to_obj_sd(t){return JSON.parse(t)}static json_to_obj_bd(t){return JSON.parse(t,((t,e)=>e.constructor!=String||null==e.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/)?e:new Date(e)))}static prop_set(t,e,r){var a=e.split("."),n=t;if(0!=a.length){if(1==a.length)return t[e]=r,t;for(let e=0;e<a.length;e++){let s=a[e];if(!(e<a.length-1))return n[s]=r,t;null==n[s]&&(n[s]={}),n=n[s]}}else s("[EI] utils.prop_set: Invalid path")}static prop_get(t,e){var r=e.split("."),a=t;if(0!=r.length){if(1==r.length)return t[e];for(let t=0;t<r.length;t++){let e=r[t];if(null==a[e])return null;a=a[e]}return a}s("[EI] utils.prop_get: Invalid path")}static deepcopy(t){return n.json_to_obj_bd(n.obj_to_json(t))}static escape_for_regex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}static init(){}}const o=n;console.log,console.warn;var i=console.error;const _={create:"Recent_Creates",read:"Recent_Reads",update:"Recent_Updates",delete:"Recent_Deletes"};class c{static max_history=1e3;static enabled=!1;static set_max_history(t){history.max_history=t}static get_op_hist_status(){return c.enabled?"enabled":"disabled"}static async enable_op_hist(){c.enabled=!0}static disable_op_hist(){c.enabled=!1}static sort_docmetas_des(t){return t.sort(((t,e)=>t.Timestamp<e.Timestamp?1:t.Timestamp>e.Timestamp?-1:0)),t}static async#t(t,e,r){if(c.enabled&&null!=r&&0!=r.length)if(-1!=["create","read","update","delete"].indexOf(e)){var a=await q.reopen();if(-1!=a.Object_Store_Names.indexOf("op_hist")){var s=a.transaction("op_hist",bt.RW).store1(),n=await s.index("Store_Name").get(bt.value_is(t));if(null==n){let n={Store_Name:t},o=[],i=new Date;for(let t of r)o.length<c.max_history&&o.push({id:t,Timestamp:i});for(let t in _)n[_[t]]=[];return n[_[e]]=o,await s.add(n),void a.close()}var o=n[_[e]],l=o.map((t=>t.id)),u=new Date;for(let t of r)-1==l.indexOf(t)&&o.push({id:t,Timestamp:u});o=(o=c.sort_docmetas_des(o)).slice(0,c.max_history),n[_[e]]=o,await s.put(n),a.close()}else a.close()}else i("[EI] op_hist.update_op_hist: No such operation type:",e)}static update_op_hist_c(t,e){c.#t(t,"create",e)}static update_op_hist_r(t,e){c.#t(t,"read",e)}static update_op_hist_u(t,e){c.#t(t,"update",e)}static update_op_hist_d(t,e){c.#t(t,"delete",e)}static async get_op_hist(t,e){var r=await q.reopen(),a=r.transaction("op_hist",bt.RO).store1(),s=await a.index("Store_Name").get(bt.value_is(t));return r.close(),s}static async clear_op_hist(){var t=await q.reopen();if(t instanceof Error)i("[EI] op_hist.clear_op_hist: Failed to open db, error:",t);else{var e=t.transaction("op_hist",bt.RW).store1();await e.delete(bt.range_gte(0)),t.close()}}static init(){}}const l=c;console.log,console.warn;var u=console.error,d=r.new_lock;const f=new Uint8Array([0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45]),y="000306090c0f1215181b1e2124272a2d";class p{static BIT_LEN=256;static FIXED_IV_BYTES=f;static FIXED_IV=y;static EXTERNAL_LIBS(){}static async get_pubkey_point(t){var[e,r]=d();return setTimeout((()=>{null==window.elliptic&&u("[EI] wcrypto.get_pubkey_point: No Elliptic lib found.")}),3e4),setTimeout((function e(){if(null!=window.elliptic){for(var a=elliptic.ec("p256").keyFromPrivate(t).getPublic(),s=a.getX().toString(16),n=a.getY().toString(16);s.length<64;)s="0"+s;for(;n.length<64;)n="0"+n;r([s,n])}else setTimeout(e,0)}),0),await e}static BASE_FUNCS(){}static get_random_values_unsigned(t,e){if(8==t||16==t||32==t||64==t){if(8==t)var r=new Uint8Array(e);return 16==t&&(r=new Uint16Array(e)),32==t&&(r=new Uint32Array(e)),64==t&&(r=new BigUint64Array(e)),window.crypto.getRandomValues(r),r}u("[EI] wcrypto.get_random_values_unsigned: Bits must be 8, 16, 32, or 64")}static get_random_values_signed(t,e){if(8==t||16==t||32==t||64==t){if(8==t)var r=new Int8Array(e);return 16==t&&(r=new Int16Array(e)),32==t&&(r=new Int32Array(e)),64==t&&(r=new BigInt64Array(e)),window.crypto.getRandomValues(r),r}u("[EI] wcrypto.get_random_values_signed: Bits must be 8, 16, 32, or 64")}static random_iv(){return p.get_random_values_unsigned(8,16)}static random_uuid(){return window.crypto.randomUUID()}static random_uuidx(){return(window.crypto.randomUUID()+window.crypto.randomUUID()).replaceAll("-","")}static UTILS(){}static base64url_to_base64(t){return t.replaceAll("-","+").replaceAll("_","/")}static base64_to_base64url(t){return t.replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}static utf8_to_bytes(t){return(new TextEncoder).encode(t)}static bytes_to_utf8(t){return new TextDecoder("utf-8").decode(t)}static buff_to_bytes(t){return new Uint8Array(t)}static bytes_to_buff(t){return t.buffer}static buff_to_hex(t){return[...new Uint8Array(t)].map((t=>t.toString(16).padStart(2,"0"))).join("")}static hex_to_buff(t){return p.hex_to_bytes(t).buffer}static bytes_to_hex(t){return[...t].map((t=>t.toString(16).padStart(2,"0"))).join("")}static hex_to_bytes(t){var e=new Uint8Array(t.length/2);for(let r=0;r<e.byteLength;r++)e[r]=parseInt(t.substring(2*r,2*r+2),16);return e}static buff_to_base64(t){for(var e=new Uint8Array(t),r=e.byteLength,a="",s=0;s<r;s++)a+=String.fromCharCode(e[s]);return window.btoa(a)}static base64_to_buff(t){var e=window.atob(t),r=new Uint8Array(e.length);for(let t=0;t<r.byteLength;t++)r[t]=e.charCodeAt(t);return r.buffer}static bytes_to_base64(t){var e=t.byteLength,r="";for(let a=0;a<e;a++)r+=String.fromCharCode(t[a]);return window.btoa(r)}static base64_to_bytes(t){var e=window.atob(t),r=new Uint8Array(e.length);for(let t=0;t<r.byteLength;t++)r[t]=e.charCodeAt(t);return r}static base64_to_hex(t){return p.bytes_to_hex(p.base64_to_bytes(t))}static hex_to_base64(t){return p.bytes_to_base64(p.hex_to_bytes(t))}static base64url_to_hex(t){return t=p.base64url_to_base64(t),p.bytes_to_hex(p.base64_to_bytes(t))}static hex_to_base64url(t){var e=p.bytes_to_base64(p.hex_to_bytes(t));return p.base64_to_base64url(e)}static SUBTLE(){}static async digest_sha1(t){var e=p.utf8_to_bytes(t),r=await window.crypto.subtle.digest("SHA-1",e);return this.buff_to_hex(r)}static async digest_sha256(t){var e=p.utf8_to_bytes(t),r=await window.crypto.subtle.digest("SHA-256",e);return this.buff_to_hex(r)}static async generate_key_aes(){return await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}static async generate_key_aes_kw(){return await window.crypto.subtle.generateKey({name:"AES-KW",length:256},!0,["wrapKey","unwrapKey"])}static async generate_keys_rsa_ed(){var t={name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"};return await window.crypto.subtle.generateKey(t,!0,["encrypt","decrypt"])}static async generate_keys_rsa_sv(){var t={name:"RSA-PSS",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"};return await window.crypto.subtle.generateKey(t,!0,["sign","verify"])}static async generate_keys_ec_ed(){}static async generate_keys_ec_sv(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"])}static async import_key_pb_raw(t){var e=p.utf8_to_bytes(t);try{var r=await window.crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits","deriveKey"])}catch(t){return u("[EI] wcrypto.import_key_pb_raw: Failed to import, error:",t),null}return r}static async import_key_aes_raw(t){if(64!=t.length)return u("[EI] wcrypto.import_key_raw: Hex of key must be of length 64 chars"),null;var e=p.hex_to_bytes(t);try{var r=await window.crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!0,["encrypt","decrypt"])}catch(t){return u("[EI] wcrypto.import_key_aes_raw: Failed to import, error:",t),null}return r}static async import_key_rsa_jwk(t,e="RSA-PSS"){var r={name:e,hash:"SHA-256"};if("RSA-OAEP"==e)var a=["encrypt","decrypt"];else a=["sign","verify"];try{return await window.crypto.subtle.importKey("jwk",t,r,!0,a)}catch(t){return u("[EI] wcrypto.import_key_rsa_jwk: Failed to import, error:",t),null}}static async import_key_ec_jwk(t,e="ECDSA"){var r={name:e,namedCurve:"P-256"};if(null!=t.d)var a=["sign"];else a=["verify"];try{return await window.crypto.subtle.importKey("jwk",t,r,!0,a)}catch(t){return u("[EI] wcrypto.import_key_ec_jwk: Failed to import, error:",t),null}}static async export_key_hex(t){return p.buff_to_hex(await window.crypto.subtle.exportKey("raw",t))}static async export_key_jwk(t){try{return await window.crypto.subtle.exportKey("jwk",t)}catch(t){return u("[EI] wcrypto.export_key_jwk: Failed to export, error:",t),null}}static async derive_bits_pb(t,e,r,a=256){var s=await p.import_key_pb_raw(t),n={name:"PBKDF2",hash:"SHA-256",salt:p.utf8_to_bytes(e),iterations:r};try{var o=await window.crypto.subtle.deriveBits(n,s,a);return p.buff_to_hex(o)}catch(t){return u("[EI] wcrypto.derive_bits_pb: Failed to derive, error:",t),null}}static async derive_key_pb2aes(t,e,r){var a=await p.import_key_pb_raw(t),s={name:"PBKDF2",hash:"SHA-256",salt:p.utf8_to_bytes(e),iterations:r};try{return await window.crypto.subtle.deriveKey(s,a,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}catch(t){return u("[EI] wcrypto.derive_key_pb2aes: Failed to derive, error:",t),null}}static async derive_keys_pb2rsa(t,e,r){}static async derive_keys_pb2ec(t,e,r){BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff"),BigInt("0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc"),BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"),BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),BigInt("0x01");var a=await p.generate_keys_ec_sv(),s=await p.export_key_jwk(a.privateKey),n=await p.export_key_jwk(a.publicKey),o=t+e;for(let t=0;t<r;t++)o=await p.digest_sha256(o);var[i,_]=await p.get_pubkey_point(o);return o=p.hex_to_base64url(o),i=p.hex_to_base64url(i),_=p.hex_to_base64url(_),s.d=o,s.x=i,s.y=_,n.x=i,n.y=_,{privateKey:await p.import_key_ec_jwk(s,"ECDSA"),publicKey:await p.import_key_ec_jwk(n,"ECDSA")}}static async encrypt_aes(t,e,r=null){if(null==r)var a=p.random_iv();else a=p.hex_to_bytes(r);var s=p.utf8_to_bytes(t),n={name:"AES-GCM",iv:a};try{var o=await window.crypto.subtle.encrypt(n,e,s)}catch(t){return u("[EI] wcrypto.encrypt_aes: Failed to encrypt, error:",t),null}return[p.buff_to_base64(o),p.bytes_to_hex(a)]}static async encrypt_aes_fiv(t,e){return await p.encrypt_aes(t,e,y)}static async encrypt_rsa(t,e){var r=p.utf8_to_bytes(t);try{var a=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},e,r)}catch(t){return u("[EI] wcrypto.encrypt_rsa: Failed to encrypt, error:",t),null}return p.buff_to_base64(a)}static async encrypt_ec(t,e){}static async decrypt_aes(t,e,r){var a=p.base64_to_bytes(t),s={name:"AES-GCM",iv:p.hex_to_bytes(e)};try{var n=await window.crypto.subtle.decrypt(s,r,a)}catch(t){return u("[EI] wcrypto.decrypt_aes: Failed to decrypt, error:",t),null}return p.bytes_to_utf8(new Uint8Array(n))}static async decrypt_aes_fiv(t,e){return await p.decrypt_aes(t,y,e)}static async decrypt_rsa(t,e){var r=p.base64_to_bytes(t);try{var a=await window.crypto.subtle.decrypt({name:"RSA-OAEP"},e,r)}catch(t){return u("[EI] wcrypto.decrypt_rsa: Failed to decrypt, error:",t),null}return p.bytes_to_utf8(new Uint8Array(a))}static async decrypt_ec(t,e){}static async sign(t,e){if("RSA-PSS"==e.algorithm.name)var r={name:"RSA-PSS",saltLength:256};else r={name:"ECDSA",hash:"SHA-256"};var a=p.utf8_to_bytes(t);try{var s=await window.crypto.subtle.sign(r,e,a)}catch(t){return u("[EI] wcrypto.sign: Failed to sign, error:",t),null}return p.buff_to_hex(s)}static async verify(t,e,r){if("RSA-PSS"==r.algorithm.name)var a={name:"RSA-PSS",saltLength:256};else a={name:"ECDSA",hash:"SHA-256"};var s=p.utf8_to_bytes(t),n=p.hex_to_bytes(e);try{return await window.crypto.subtle.verify(a,r,n,s)}catch(t){return u("[EI] wcrypto.verify: Failed to verify, error:",t),null}}static async wrap_key(){}static async unwrap_key(){}static EXTENDED(){}static split_into_2(t){var e=Math.floor(t.length/2);return[t.substring(0,e),t.substring(e)]}static async password2keys(t,e,r){var a=await p.derive_bits_pb(t,e,r,512),[s,n]=p.split_into_2(a);return[await p.derive_key_pb2aes(s,e,r),await p.derive_keys_pb2ec(n,e,r)]}static async make_static_key(t,e){var r=p.random_uuidx();return await p.derive_key_pb2aes(r,t,e)}static init(){}}const b=p,w=(console.log,console.warn,console.error),h=r.new_lock,g=class{static async insert_one(t,e){if(null!=A.Skey){t="#"+t;var r=await A.obj_to_sobj(t,e);return await W.insert_one(t,r,_secure,e)}w("[EI] cruds.insert_one: Static key not set")}static async insert_many(t,e){if(null!=A.Skey){t="#"+t;var r=[];for(let a of e)r.push(await A.obj_to_sobj(t,a));return await W.insert_many(t,r,_secure,e)}w("[EI] cruds.insert_many: Static key not set")}static async get_1stcond_obj(t,e){}static async get_1stcond_objs(t,e){}static async intersect_cond(t,e){}static async intersect_cond_getobjs(t,e){}static async exists(t,e){if(null!=A.Skey){t="#"+t;var r={};for(let t in e)"id"==t?r[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?r[t]=await A.array_to_sarray(e[t]):r[t]=await A.value_to_svalue(e[t]);return await W.exists(t,r,_secure)}w("[EI] cruds.exists: Static key not set")}static async count(t,e){if(null!=A.Skey){t="#"+t;var r={};for(let t in e)"id"==t?r[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?r[t]=await A.array_to_sarray(e[t]):r[t]=await A.value_to_svalue(e[t]);return await W.count(t,r,_secure)}w("[EI] cruds.count: Static key not set")}static async count_all(t){if(null!=A.Skey)return t="#"+t,await W.count_all(t,_secure);w("[EI] cruds.count_all: Static key not set")}static async find_one(t,e){if(null!=A.Skey){t="#"+t;var r={};for(let t in e)"id"==t?r[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?r[t]=await A.array_to_sarray(e[t]):r[t]=await A.value_to_svalue(e[t]);var a=await W.find_one(t,r,_secure);if(null==a)return null;var s=await b.decrypt_aes_fiv(a.Etds_Obj,A.Skey),n=o.json_to_obj_bd(s);return n.id=a.id,n}w("[EI] cruds.find_one: Static key not set")}static async find_many(t,e,r=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){t="#"+t;var a={};for(let t in e)"id"==t?a[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?a[t]=await A.array_to_sarray(e[t]):a[t]=await A.value_to_svalue(e[t]);var s=await W.find_many(t,a,r,_secure),n=[];for(let t of s){var i=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_.id=t.id,n.push(_)}return n}w("[EI] cruds.find_many: Static key not set")}static async find_all(t){if(null!=A.Skey){t="#"+t;var e=await W.find_all(t,_secure),r=[];for(let t of e){var a=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey);if(null!=a){var s=o.json_to_obj_bd(a);s.id=t.id,r.push(s)}}return r}w("[EI] cruds.find_all: Static key not set")}static get_proppath_value(t,e){}static obj_matches_cond(t,e){}static async filter(t,e,r=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){t="#"+t;var a={};for(let t in e)a[t]="id"==t?e[t]:await A.value_to_svalue(e[t]);var s=await W.filter(t,a,r,_secure),n=[];for(let t of s){var i=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_.id=t.id,n.push(_)}return n}w("[EI] cruds.filter: Static key not set")}static async update_one(t,e,r){if(null!=A.Skey){t="#"+t;var a=await A.obj_to_sobj_arb(r),s={};for(let t in e)"id"==t?s[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?s[t]=await A.array_to_sarray(e[t]):s[t]=await A.value_to_svalue(e[t]);var n=await W.find_one(t,s,_secure),i=await b.decrypt_aes_fiv(n.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);_={..._,...r},i=o.obj_to_json(_),a.Etds_Obj=(await b.encrypt_aes_fiv(i,A.Skey))[0];var c=await W.update_one(t,s,a,_secure,_);return i=await b.decrypt_aes_fiv(c.Etds_Obj,A.Skey),(_=o.json_to_obj_bd(i)).id=c.id,_}w("[EI] cruds.update_one: Static key not set")}static async update_many(t,e,r,a=Number.MAX_SAFE_INTEGER){if(null!=A.Skey){t="#"+t;var s=o.deepcopy(r);delete s.id,r=s;var n=await A.obj_to_sobj_arb(r),i=[],_={};for(let t in e)"id"==t?_[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?_[t]=await A.array_to_sarray(e[t]):_[t]=await A.value_to_svalue(e[t]);var c=await W.find_many(t,_,_secure),l=[];for(let t of c){let e=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),a=o.json_to_obj_bd(e);a={...a,...r,id:t.id},e=o.obj_to_json(a),l.push(a);let s=o.deepcopy(n);s.Etds_Obj=(await b.encrypt_aes_fiv(e,A.Skey))[0],i.push(s)}var u=await bt.reopen(),d=u.transaction(t,bt.RW).store1(),f=0,y=[],[p,g]=h();for(let e=0;e<c.length;e++){let r,a={...c[e],...i[e]};d.put(a,null,r=!1,(r=>{r instanceof Error?(w("[EI] cruds.update_many: Error:",r),y.push(null)):y.push(a),D.update_fts_u(t,l[e].id,l[e]),++f==c.length&&g()}))}await p;var v=[];for(let t of y){let e=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),r=o.json_to_obj_bd(e);r.id=t.id,v.push(r)}return u.close(),v}w("[EI] cruds.update_many: Static key not set")}static async upsert_one(t,e,r){if(null!=A.Skey){t="#"+t;var a=await A.obj_to_sobj_arb(r),s={};for(let t in e)"id"==t?s[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?s[t]=await A.array_to_sarray(e[t]):s[t]=await A.value_to_svalue(e[t]);var n=await W.find_one(t,s,_secure),i=await b.decrypt_aes_fiv(n.Etds_Obj,A.Skey),_=o.json_to_obj_bd(i);return _={..._,...r},i=o.obj_to_json(_),a.Etds_Obj=(await b.encrypt_aes_fiv(i,A.Skey))[0],await W.upsert_one(t,s,a,_secure,_)}w("[EI] cruds.upsert_one: Static key not set")}static async remove_one(t,e){if(null!=A.Skey){t="#"+t;var r={};for(let t in e)"id"==t?r[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?r[t]=await A.array_to_sarray(e[t]):r[t]=await A.value_to_svalue(e[t]);var a=await W.find_one(t,r,_secure);if(null==a)return null;var s=await b.decrypt_aes_fiv(a.Etds_Obj,A.Skey),n=o.json_to_obj_bd(s);n.id=a.id,await W.remove_one(t,r,_secure,n)}else w("[EI] cruds.remove_one: Static key not set")}static async remove_many(t,e){if(null!=A.Skey){t="#"+t;var r={};for(let t in e)"id"==t?r[t]=e[t]:e[t]instanceof Array&&t.indexOf(",")>=0?r[t]=await A.array_to_sarray(e[t]):r[t]=await A.value_to_svalue(e[t]);var a=[],s=await W.find_many(t,r,_secure);if(null==s||0==s.length)return null;for(let t of s){var n=await b.decrypt_aes_fiv(t.Etds_Obj,A.Skey),i=o.json_to_obj_bd(n);i.id=t.id,a.push(i)}await W.remove_many(t,r,_secure,a)}else w("[EI] cruds.remove_many: Static key not set")}static init(){}};console.log,console.warn,console.error;const v=class{static set_max_history(t){l.set_max_history(t)}static get_op_hist_status(){return l.get_op_hist_status()}static async enable_op_hist(){l.enable_op_hist()}static disable_op_hist(){l.disable_op_hist()}static sort_docmetas_des(t){}static async#t(t,e,r){}static update_op_hist_c(t,e){t="#"+t,l.update_op_hist_c(t,e)}static update_op_hist_r(t,e){t="#"+t,l.update_op_hist_r(t,e)}static update_op_hist_u(t,e){t="#"+t,l.update_op_hist_u(t,e)}static update_op_hist_d(t,e){t="#"+t,l.update_op_hist_d(t,e)}static async get_op_hist(t,e){return t="#"+t,await l.get_op_hist(t,e)}static async clear_op_hist(){await l.clear_op_hist()}static init(){}},m=(console.log,console.warn,console.error),S=class{static enable_fts(){D.enable_fts()}static disable_fts(){D.disable_fts()}static str_to_unique_words(t){}static obj_to_unique_words(t){}static async obj_exists(t,e,r){}static async increase_num_objs(t,e,r){}static async decrease_num_objs(t,e,r){}static async update_fts(t,e,r,a){}static update_fts_c(t,e,r){D.update_fts_c(t,e,r,_secure)}static update_fts_r(t,e,r){}static update_fts_u(t,e,r){D.update_fts_u(t,e,r,_secure)}static update_fts_d(t,e,r){D.update_fts_d(t,e,r,_secure)}static async#t(t,e,r,a){}static#e(t,e){}static async find_many_by_terms(t,e,r=1e3){if(null!=A.Skey){t="#"+t;var a=await D.find_many_by_terms(t,e,r,_secure);for(let t=0;t<a.Items.length;t++){let e=a.Items[t].Object,r=await b.decrypt_aes_fiv(e.Etds_Obj,A.Skey),s=o.json_to_obj_bd(r);s.id=e.id,a.Items[t]=s}for(let t=0;t<a.Search_Terms.length;t++)a.Search_Terms[t]=await b.decrypt_aes_fiv(a.Search_Terms[t],A.Skey);for(let t=0;t<a.Excluded_Terms.length;t++)a.Excluded_Terms[t]=await b.decrypt_aes_fiv(a.Excluded_Terms[t],A.Skey);return a}m("[EI] ftss.find_many_by_terms: Static key not set")}static init(){}},k=console.log,E=console.warn,x=console.error;var j={Store:"_global",Etde_Skey:null,Etde_Skey_Iv:null,Etdr_Recovery:null,Etdr_Recovery_Iv:null};class I{SUB_NAMESPACES;static cruds;static op_hists;static ftss;CONSTANTS;static ITERATIONS=1e5;PROPERTIES;static Ekey=null;static Akeypair=null;static Skey=null;static Rkey=null;METHODS;static async open_av(t,e){var r=Object.keys(e);for(let t of r)null!=e[t]._secure&&(delete e[t]._secure,e["#"+t]={...e[t]},delete e[t]);return await q.open_av(t,e)}static async value_to_svalue(t){var e;return e=t instanceof Object&&!(t instanceof Date)?o.obj_to_json(t):t instanceof Date?t.toISOString():t.toString(),(await b.encrypt_aes_fiv(e,I.Skey))[0]}static async array_to_sarray(t){var e=[];for(let r of t)e.push(await O.value_to_svalue(r));return e}static async obj_to_sobj(t,e){if(null==I.Skey)return void x("[EI] idbxs.obj_to_sobj: Static key not set");var r=Object.keys(q.Indices[t]);r=r.filter((t=>"id"!=t));let a=[];if(null!=e.id)var s={id:e.id};else s={};for(let t of r){if(t.indexOf(",")>=0){let r=t.split(",");for(let t of r)a.push({Path:t,Value:o.prop_get(e,t)})}else a.push({Path:t,Value:o.prop_get(e,t)});for(let t=0;t<a.length;t++){let e;e=a[t].Value instanceof Object&&!(a[t].Value instanceof Date)?o.obj_to_json(a[t].Value):a[t].Value instanceof Date?a[t].Value.toISOString():a[t].Value.toString();let r=await b.encrypt_aes_fiv(e,I.Skey);a[t].Svalue=r[0]}}for(let t of a){let e=t.Path,r=t.Svalue;s=o.prop_set(s,e,r)}var n=o.obj_to_json(e),i=await b.encrypt_aes_fiv(n,I.Skey);return s.Etds_Obj=i[0],s}static async obj_to_sobj_arb(t){var e={};for(let r in t){let a;a=t[r]instanceof Object&&!(t[r]instanceof Date)?o.obj_to_json(t[r]):t[r]instanceof Date?t[r].toISOString():t[r].toString(),e[r]=(await b.encrypt_aes_fiv(a,I.Skey))[0]}return e}static async#t(t){if(null==t)return null;if(!(t instanceof Object))return(await b.encrypt_aes_fiv(t,I.Skey))[0];if(t instanceof Date)return(await b.encrypt_aes_fiv(t.toISOString(),I.Skey))[0];for(let e in t)t[e]=await I.#t(t[e]);return t}static async obj_to_sobj_arb_rec(t){var e=JSON.parse(JSON.stringify(t));return await I.#t(e)}static set_ea_keys(t,e){I.Ekey=t,I.Akeypair=e}static set_static_key(t){I.Skey=t}static async ensure_global_meta(t){null==await I.load_global_meta(t)&&await t.add(j)}static async load_global_meta(t){var e=t;if(null==t){var r=await bt.reopen();t=r.transaction("_meta",bt.RO).store1()}var a=await t.index("Store").get(bt.value_is("_global"));return null==e&&r.close(),a}static async update_global_meta(t,e){var r=t;if(null==t){var a=await bt.reopen();t=a.transaction("_meta",bt.RW).store1()}var s=await I.load_global_meta(t);s={...s,...e},await t.put(s),null==r&&a.close()}static async save_static_key(t,e=!1){if(null!=I.Ekey&&null!=I.Akeypair){var r=await b.export_key_hex(t),a=await b.encrypt_aes(r,I.Ekey),[s,n]=a,o=await bt.reopen(),i=o.transaction("_meta",bt.RW).store1(),_=await i.index("Store").get(bt.value_is("_global"));if(null==_&&(I.ensure_global_meta(i),_=await i.index("Store").get(bt.value_is("_global"))),null!=_.Etde_Skey&&0==e)return E("[EI] idbxs.set_static_key: Static key exists, no enforcing"),void o.close();_.Etde_Skey=s,_.Etde_Skey_Iv=n,i.put(_),o.close()}else x("[EI] idbxs.set_static_key: Encryption key and auth key pair must exist first, call set_ea_keys")}static async load_static_key(){if(null!=I.Ekey&&null!=I.Akeypair){var t=await bt.reopen(),e=t.transaction("_meta",bt.RW).store1(),r=await e.index("Store").get(bt.value_is("_global"));if(null==r)return E("[EI] idbxs.get_static_key: Global metadata not set"),await I.ensure_global_meta(e),void t.close();if(null==r.Etde_Skey)return E("[EI] idbxs.get_static_key: No static key in global metadata"),void t.close();var a=r.Etde_Skey,s=r.Etde_Skey_Iv,n=await b.decrypt_aes(a,s,I.Ekey),o=await b.import_key_aes_raw(n);return t.close(),o}x("[EI] idbxs.get_static_key: Encryption key and auth key pair must exist first, call set_ea_keys")}static async prepare_keys(t,e){var r=bt.slocal.get("Ekey_Hex"),a=bt.slocal.get("Akeypriv_Jwk"),s=bt.slocal.get("Akeypub_Jwk"),n=!1;if(null!=r&&null!=a&&null!=s){var o=await b.import_key_aes_raw(r),i={privateKey:_=await b.import_key_ec_jwk(a),publicKey:c=await b.import_key_ec_jwk(s)};I.set_ea_keys(o,i);try{k("[EI] Trying stored keys..."),n=null!=(l=await I.load_static_key())}catch(t){}}if(!n){var[o,i]=await I.get_key_chain(t,e);I.set_ea_keys(o,i);var _=i.privateKey,c=i.publicKey;k("[EI] Trying keys from username and password...");var l=await I.load_static_key()}if(null==l){let e;E("[EI] idbxs.prepare_keys: No static key, creating one..."),l=await I.get_new_static_key(t),await I.save_static_key(l,e=!0)}I.set_static_key(l),bt.slocal.set("Ekey_Hex",await b.export_key_hex(o)),bt.slocal.set("Akeypriv_Jwk",await b.export_key_jwk(_)),bt.slocal.set("Akeypub_Jwk",await b.export_key_jwk(c))}static clear_keys(){bt.slocal.clear("Ekey_Hex"),bt.slocal.clear("Akeypriv_Jwk"),bt.slocal.clear("Akeypub_Jwk")}static async set_user_and_pw(t,e){var r=await I.load_static_key();if(null==r)return new Error("failed-to-load-static-key");I.set_static_key(r);var[a,s]=await I.get_key_chain(t,e);let n;I.set_ea_keys(a,s),await I.save_static_key(r,n=!0)}static async get_key_chain(t,e){t=t.trim(),e=e.trim(),k(`[EI] Creating key chain, ${I.ITERATIONS} iterations`);var r=performance.now(),a=await b.digest_sha256(t),[s,n]=await b.password2keys(e,a,I.ITERATIONS),o=performance.now();return k(`[EI] Key chain made in ${(o-r)/1e3} seconds`),[s,n]}static async get_new_static_key(t){t=t.trim();var e=await b.digest_sha256(t);return await b.make_static_key(e,1e3)}static async gen_recovery_info(t,e){var r=await b.generate_key_aes(),a=await b.export_key_hex(t),s=await b.export_key_jwk(e.privateKey),n=`${a}::${b.base64url_to_hex(s.d)}::${b.base64url_to_hex(s.x)}::${b.base64url_to_hex(s.y)}`,[o,i]=await b.encrypt_aes(n,r);return{Ciphertext:o,Iv:i,Recovery_Key:r}}static async save_recovery_info(t,e){var r=await bt.reopen(),a=r.transaction("_meta",bt.RW).store1(),s={Etdr_Recovery:t,Etdr_Recovery_Iv:e};await I.update_global_meta(a,s),r.close()}static async recover_key_chain(t,e,r){var a=await b.decrypt_aes(t,e,r);if(null==a)return null;var[s,n,o,i]=a.split("::"),_=await b.import_key_aes_raw(s),c=await b.generate_keys_ec_sv(),l=await b.export_key_jwk(c.privateKey),u=await b.export_key_jwk(c.publicKey);l.d=b.hex_to_base64url(n),l.x=b.hex_to_base64url(o),l.y=b.hex_to_base64url(i),u.x=b.hex_to_base64url(o),u.y=b.hex_to_base64url(i);var d={};return d.privateKey=await b.import_key_ec_jwk(l),d.publicKey=await b.import_key_ec_jwk(u),[_,d]}static async recover_and_set_keys(t){if(t instanceof CryptoKey){var e=await bt.reopen(),r=e.transaction("_meta",bt.RO).store1(),a=await I.load_global_meta(r);if(null==a)return x("[EI] idbxs.recover_and_set_keys: Bad global metadata:",a),void e.close();var s=a.Etdr_Recovery,n=a.Etdr_Recovery_Iv;if(null==s||null==n)return x("[EI] idbxs.recovery_and_set_keys: No or bad recovery data in global metadata"),void e.close();var[o,i]=await I.recover_key_chain(s,n,t);if(!(null!=o&&null!=i&&o instanceof CryptoKey&&i.privateKey instanceof CryptoKey&&i.publicKey instanceof CryptoKey))return x("[EI] idbxs.recovery_and_set_keys: Failed to recover keys, found:",o,i),void e.close();var _=a.Etde_Skey,c=a.Etde_Skey_Iv,l=await b.decrypt_aes(_,c,o);if(null==l)return x("[EI] idbxs.recovery_and_set_keys: Failed to decrypt for static key"),void e.close();var u=await b.import_key_aes_raw(l);return I.set_ea_keys(o,i),I.set_static_key(u),e.close(),[o,i]}x("[EI] idbxs.recover_and_set_keys: First param is not CryptoKey")}static get_micro_dict(){var t=["a","e","i","o","u","y"],e=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","z"],r=[],a=[];for(let a of e)for(let e of t)r.push(a+e);for(let r of t)for(let t of e)a.push(r+t);var s=[],n=r.length-1;for(let t=0;t<120;t++)t%8==0?s.push(r[t]):t%8==1?s.push(a[t]):t%8==2?s.push(r[t]+r[n-t]):t%8==3?s.push(r[t]+a[t]):t%8==4?s.push(a[t]+r[t]):t%8==5?s.push(a[t]+a[n-t]):t%8==6?s.push(r[t]+a[t]+a[n-t]):t%8==7&&s.push(a[t]+r[t]+r[n-t]);s=Array.from(new Set(s)).sort();var o=[];for(let t of s)o.push(t),o.push(t.split("").reverse().join(""));o=Array.from(new Set(o)).sort();var i=[...o],_=256-o.length;for(let t=0;t<_;t++){let e=Math.floor(o.length/_*t);i.push(o[e]+o[e+1])}return Array.from(new Set(i)).sort()}static#r(t,e){for(let r=0;r<e;r++){let e=[...t.matchAll(/[\s]+/g)].map((t=>t.index)),r=e[Math.floor(Math.random()*e.length)],a=t.split("");a[r]=".",t=a.join("")}return t}static#a(t,e){for(let r=0;r<e;r++){let e=[...t.matchAll(/[\s]+/g)].map((t=>t.index)),r=e[Math.floor(Math.random()*e.length)],a=t.split("");a[r]=",",t=a.join("")}return t}static#e(t){var e=(t=t.replaceAll(",",", ")).split(".");for(let t=0;t<e.length;t++)e[t]=e[t].charAt(0).toUpperCase()+e[t].substring(1);return(t=e.join(". "))+"."}static async key_to_text(t){var e=await b.export_key_hex(t),r=I.get_micro_dict(),a=b.hex_to_bytes(e),s=[];for(let t=0;t<a.byteLength;t++)s.push(r[a[t]]);var n=s.join(" ");return n=I.#r(n,4),n=I.#a(n,8),I.#e(n)}static async text_to_key(t){var e=(t=(t=(t=t.toLowerCase().replaceAll(/[^a-z]+/g," ")).trim()).replaceAll(/[\s]{2,}/g," ")).split(" "),r=I.get_micro_dict(),a=new Uint8Array(32);for(let t of e)if(-1==r.indexOf(t))return void x("[EI] idbxs.text_to_key: Invalid word:",t);for(let t=0;t<e.length;t++){let s=e[t],n=r.indexOf(s);a[t]=n}var s=b.bytes_to_hex(a);return await b.import_key_aes_raw(s)}static init(){I.cruds=g,I.op_hists=v,I.ftss=S,I.cruds.init(),I.op_hists.init(),I.ftss.init()}}const O=I,A=O,N=(console.log,console.warn),T=console.error;class R{static enabled=!1;static score_rate=2;static enable_fts(){R.enabled=!0}static disable_fts(){R.enabled=!1}static str_to_unique_words(t){var e=(t=(t=(t=t.toLowerCase()).replace(/[^0-9A-Za-z_\-]/g," ")).replace(/[\s]{2,}/g," ").trim()).split(" ");return Array.from(new Set(e))}static obj_to_unique_words(t){var e=o.obj_to_valuestr(t);return R.str_to_unique_words(e)}static async obj_exists(t,e,r){var a=t.index(e);return null!=await a.get_key(bt.value_is(r))}static async increase_num_objs(t,e,r){var a=await t.index("Store,Word").get(bt.value_is([e,r]));a.num_obj_ids++,await t.put(a)}static async decrease_num_objs(t,e,r){var a=await t.index("Store,Word").get(bt.value_is([e,r]));a.num_obj_ids>0&&a.num_obj_ids--,a.num_obj_ids>0?await t.put(a):await t.delete(bt.value_is(a.id))}static async update_fts(t,e,r,a,s=!1){if(-1!=["create","update","delete"].indexOf(t)){if(s)var n="#fts_words",o="#fts_ids";else n="fts_words",o="fts_ids";var i=R.obj_to_unique_words(a);if(s)for(let t=0;t<i.length;t++){let e=(await b.encrypt_aes_fiv(i[t],A.Skey))[0];i[t]=e}var _=await q.reopen(),c=_.transaction([n,o],bt.RW),l=c.object_store(n),u=c.object_store(o);for(let a of i)await R.obj_exists(l,"Store,Word",[e,a])||await l.add({Store:e,Word:a,num_obj_ids:0}),"create"==t?(await u.add({Store:e,Word:a,obj_id:r}),await R.increase_num_objs(l,e,a)):"update"==t?await R.obj_exists(u,"Store,Word,obj_id",[e,a,r])||(await u.add({Store:e,Word:a,obj_id:r}),await R.increase_num_objs(l,e,a)):(await u.index("Store,Word,obj_id").delete(bt.value_is([e,a,r])),await R.decrease_num_objs(l,e,a));var d=await u.index("Store,obj_id").get_all(bt.value_is([e,r])),f=(d=d.map((t=>t.Word))).filter((t=>-1==i.indexOf(t)));for(let t of f)await u.index("Store,Word,obj_id").delete(bt.value_is([e,t,r])),await R.decrease_num_objs(l,e,t);_.close()}else T("[EI] fts.update_fts: Bad operation:",t)}static update_fts_c(t,e,r,a=!1){R.enabled&&R.update_fts("create",t,e,r,a)}static update_fts_r(t,e,r,a=!1){}static update_fts_u(t,e,r,a=!1){R.enabled&&R.update_fts("update",t,e,r,a)}static update_fts_d(t,e,r,a=!1){R.enabled&&R.update_fts("delete",t,e,r,a)}static async#r(t,e,r,a){var s=e.Name,n=[];await t.index("Store,Word").open_cursor(bt.value_is([s,r]),"next",(t=>{if(n.push(t.value.obj_id),n.length>=a)return bt._stop}));var o=[];for(let t of n){let r=await e.get(bt.value_is(t));null!=r?o.push(r):N("[EI] fts.#term_to_objs: Found bad id:",t)}return o}static#t(t,e){var r=[],a={},s=1;for(let t=e.length-1;t>=0;t--)a[e[t]]=s,s<Number.MAX_SAFE_INTEGER/R.score_rate&&(s*=R.score_rate);for(let s of t){let t={Object:s,score:0},n=o.obj_to_valuestr(s).toLowerCase(),i=0;for(let t of e){let e=o.escape_for_regex(t);i+=a[t]*(n.match(new RegExp(e,"g"))||[]).length}t.score=i,r.push(t)}return r.sort(((t,e)=>e.score-t.score))}static async find_many_by_terms(t,e,r=1e3,a=!1){if(0==R.enabled&&N("[EI] fts.find_many_by_terms: FTS is disabled, there might be results but no changes."),a)var s="#fts_words",n="#fts_ids";else s="fts_words",n="fts_ids";var o=R.str_to_unique_words(e);if(a)for(let t=0;t<o.length;t++)o[t]=(await b.encrypt_aes_fiv(o[t],A.Skey))[0];var i=await bt.reopen(),_=i.transaction([s,n,t],bt.RO),c=_.object_store(s),l=_.object_store(n),u=_.object_store(t),d=[],f=[];for(let e of o){let r=await c.index("Store,Word").get(bt.value_is([t,e]));if(null==r){d.push(e);continue}let a={Term:e,exists:!0,size:r.num_obj_ids};f.push(a)}var y="More specific terms are listed first in Search_Terms; higher score items are listed first.";if(0==f.length)return{Items:[],Search_Terms:[],Excluded_Terms:d,Note:y};if(1==f.length){let t=f[0].Term,e=await R.#r(l,u,t,r);return{Items:R.#t(e,[t]),Search_Terms:[t],Excluded_Terms:d,Note:y}}var p=(f=f.sort(((t,e)=>t.size-e.size))).map((t=>t.Term)),w=f[0].Term,h=f.slice(1).map((t=>t.Term)),g=[];await l.index("Store,Word").open_cursor(bt.value_is([t,w]),"next",(async e=>{var r=e.value.obj_id,a=!0;for(let e of h)if(0==await l.index("Store,Word,obj_id").count(bt.value_is([t,e,r]))){a=!1;break}a&&g.push(r)}));var v=[];for(let t of g){let e=await u.get(bt.value_is(t));null!=e?v.push(e):N("[EI] fts.find_many_by_terms: Found bad id:",t)}var m=R.#t(v,p);return i.close(),{Items:m,Search_Terms:p,Excluded_Terms:d,Note:y}}static init(){}}const D=R;console.log,console.warn;var K=console.error,C=r.new_lock,U=(JSON.parse,JSON.stringify);class F{static async insert_one(t,e,r=!1,a=null){var s=await bt.reopen(),n=s.transaction(t,bt.RW).store1(),o={...e};delete o.id;var i=await n.add(o);return i instanceof Error?(K("[EI] crud.insert_one: Failed, error:",i),null==n&&s.close(),null):(l.update_op_hist_c(n.Name,[i]),r?S.update_fts_c(n.Name,i,a):D.update_fts_c(n.Name,i,e),null==n&&s.close(),i)}static async insert_many(t,e,r=!1,a=null){var s=await bt.reopen(),n=s.transaction(t,bt.RW).store1(),o=[],[i,_]=C();if(null==e||0==e.length)return s.close(),[];for(let t of e){let r={...t};delete r.id;let a=n.self.add(r);a.onerror=t=>{K("[EI] crud.insert_many: Failed to add object, error:",t.target.error),o.push(null),o.length==e.length&&_()},a.onsuccess=t=>{o.push(t.target.result),o.length==e.length&&_()}}await i;for(let t=0;t<o.length;t++)r?S.update_fts_c(n.Name,o[t],a[t]):D.update_fts_c(n.Name,o[t],e[t]);return s.close(),o}static async get_1stcond_obj(t,e){var r=Object.keys(e),a=t.index(r[0]);if(a instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",r[0]),null;var s=e[r[0]];return await a.get(s)}static async get_1stcond_objs(t,e){var r=Object.keys(e),a=t.index(r[0]);if(a instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",r[0]),null;var s=e[r[0]];return await a.get_all(s)}static async intersect_cond(t,e){var r=Object.keys(e);if(0==r.length)return[];var a=[];for(let s of r){let r=t.index(s);if(r instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",s),null;let n=e[s],o=(await r.get_all(n)).map((t=>t.id));a.push(o)}return o.intersect_arrs(a)}static async intersect_cond_getobjs(t,e){var r=Object.keys(e);if(0==r.length)return[];var a=[],s={};for(let n of r){let r=t.index(n);if(r instanceof Error)return K("[EI] crud.get_1stcond_obj: Failed to get index, add this index to schema:",t.Name,"/",n),null;let o=e[n],i=(await r.get_all(o)).map((t=>(s[t.id]=t,t.id)));a.push(i)}return o.intersect_arrs(a).map((t=>s[t]))}static async exists(t,e,r=!1){var a=await bt.reopen(),s=a.transaction(t,bt.RO).store1(),n=Object.keys(e);if(0==n.length)return a.close(),[];if(1==n.length){let t=await F.get_1stcond_obj(s,e);return a.close(),null!=t}var o=await F.intersect_cond(s,e);return a.close(),o.length>0}static async count(t,e,r=!1){var a=await bt.reopen(),s=a.transaction(t,bt.RO).store1(),n=Object.keys(e);if(0==n.length)return a.close(),null;if(1==n.length){let t=await F.get_1stcond_objs(s,e);return a.close(),t.length}var o=await F.intersect_cond(s,e);return a.close(),o.length}static async count_all(t,e=!1){var r=await bt.reopen(),a=r.transaction(t,bt.RO).store1(),s=await a.count();return r.close(),s}static async find_one(t,e,r=!1){var a=await bt.reopen(),s=a.transaction(t,bt.RO).store1(),n=Object.keys(e);if(0==n.length)return a.close(),null;if(1==n.length){let t=await F.get_1stcond_obj(s,e);return null==t?(a.close(),null):(l.update_op_hist_r(s.Name,[t.id]),a.close(),t)}var o=await F.intersect_cond(s,e);if(0==o.length)return a.close(),null;var i=await s.get(bt.value_is(o[0]));return l.update_op_hist_r(s.Name,o),a.close(),i}static async find_many(t,e,r=Number.MAX_SAFE_INTEGER,a=!1){var s=await bt.reopen(),n=s.transaction(t,bt.RO).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;if(1==o.length){let t=await F.get_1stcond_objs(n,e);return s.close(),t}var i=await F.intersect_cond(n,e);if(null==i||0==i.length)return s.close(),[];var _=[],[c,l]=C();for(let t of i){let e=n.self.get(bt.value_is(t).self);e.onerror=t=>{_.push(null),_.length==i.length&&l(),_.length>=r&&l()},e.onsuccess=t=>{_.push(t.target.result),_.length==i.length&&l(),_.length>=r&&l()}}return await c,s.close(),_}static async find_all(t,e=!1){var r=await bt.reopen(),a=r.transaction(t,bt.RO).store1(),s=await a.get_all();return r.close(),s}static get_proppath_value(t,e){var r=e.split("."),a=t;for(let t of r){if(null==a[t])return null;a=a[t]}return a}static obj_matches_cond(t,e){for(let r in e){let a=e[r],s=F.get_proppath_value(t,r);if(null==s)return!1;if(-1==U(s).indexOf(a))return!1}return!0}static async filter(t,e,r=Number.MAX_SAFE_INTEGER,a=!1){var s=await bt.reopen(),n=s.transaction(t,bt.RO).store1(),o=[];return await n.open_cursor(bt.range_gte(0),"next",(t=>{var a=t.value;if(F.obj_matches_cond(a,e)&&o.push(a),o.length>=r)return bt._stop})),s.close(),o}static async update_one(t,e,r,a=!1,s=null){var n=await bt.reopen(),o=n.transaction(t,bt.RW).store1(),i=Object.keys(e);if(0==i.length)return n.close(),null;let _={...r};if(delete _.id,1==i.length){let t=await F.get_1stcond_obj(o,e);return null==t?(n.close(),null):(t={...t,..._},o.put(t),l.update_op_hist_u(o.Name,[t.id]),a?S.update_fts_u(o.Name,t.id,s):D.update_fts_u(o.Name,t.id,t),n.close(),t)}var c=await F.intersect_cond(o,e);if(null==c||0==c.length)return n.close(),null;var u=await o.get(bt.value_is(c[0]));return null==u?(n.close(),null):(u={...u,..._},await o.put(u),l.update_op_hist_u(o.Name,[u.id]),a?S.update_fts_u(o.Name,u.id,u):D.update_fts_u(o.Name,u.id,u),n.close(),u)}static async update_many(t,e,r,a=Number.MAX_SAFE_INTEGER,s=!1){var n=await bt.reopen(),o=n.transaction(t,bt.RW).store1(),i=Object.keys(e);if(0==i.length)return n.close(),null;let _={...r};if(delete _.id,1==i.length){if(null==(c=await F.get_1stcond_objs(o,e)))return n.close(),null;if(0==c.length)return n.close(),[]}else{var c;if(null==(c=await F.intersect_cond_getobjs(o,e)))return n.close(),null;if(0==c.length)return n.close(),[]}let l=[],[u,d]=C();for(let t of c){let e={...t,..._},r=o.self.put(e);r.onerror=e=>{K("[EI] crud.update_many: Failed to update object:",t),l.push(null),l.length==c.length&&d(),l.length>=a&&d()},r.onsuccess=t=>{l.push({...e,id:t.target.result}),l.length==c.length&&d(),l.length>=a&&d()}}await u;for(let t=0;t<l.length;t++)s||D.update_fts_u(o.Name,l[t].id,l[t]);return n.close(),l}static async upsert_one(t,e,r,a=!1,s=null){var n=await bt.reopen(),o=n.transaction(t,bt.RW).store1(),i=Object.keys(e);if(0==i.length)return n.close(),null;let _={...r};if(delete _.id,1==i.length){let t=await F.get_1stcond_obj(o,e);if(null==t){let t=await o.add(_);return l.update_op_hist_c(o.Name,[t]),a?S.update_fts_c(o.Name,t,s):D.update_fts_c(o.Name,t,r),n.close(),t}return t={...t,..._},o.put(t),l.update_op_hist_u(o.Name,[t.id]),a?S.update_fts_u(o.Name,t.id,s):D.update_fts_u(o.Name,t.id,t),n.close(),t.id}var c=await F.intersect_cond(o,e);if(null==c||0==c.length)return n.close(),null;var u=await o.get(bt.value_is(c[0]));if(null==u){let t=await o.add(_);return l.update_op_hist_c(o.Name,[t]),a?S.update_fts_c(o.Name,t,s):D.update_fts_c(o.Name,t,r),n.close(),t}return u={...u,..._},o.put(u),l.update_op_hist_u(o.Name,[u.id]),a?S.update_fts_u(o.Name,u.id,s):D.update_fts_u(o.Name,u.id,u),n.close(),u.id}static async remove_one(t,e,r=!1,a=null){var s=await bt.reopen(),n=s.transaction(t,bt.RW).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;if(1==o.length){let t=await F.get_1stcond_obj(n,e);if(null==t)return s.close(),null;let o=await n.delete(bt.value_is(t.id));return l.update_op_hist_d(n.Name,[t.id]),r?S.update_fts_d(n.Name,t.id,a):D.update_fts_d(n.Name,t.id,t),s.close(),o}var i=await F.intersect_cond_getobjs(n,e),_=i.map((t=>t.id));if(null==_||0==_.length)return s.close(),null;var c=await n.delete(bt.value_is(_[0]));return l.update_op_hist_d(n.Name,[_[0]]),r?S.update_fts_d(n.Name,_[0],a):D.update_fts_d(n.Name,_[0],i[0]),s.close(),c}static async remove_many(t,e,r=!1,a=null){var s=await bt.reopen(),n=s.transaction(t,bt.RW).store1(),o=Object.keys(e);if(0==o.length)return s.close(),null;var i=[],_=[];if(1==o.length){if(i=await F.get_1stcond_objs(n,e),_=i.map((t=>t.id)),null==i||0==i.length)return s.close(),null}else if(i=await F.intersect_cond_getobjs(n,e),null==(_=i.map((t=>t.id)))||0==_.length)return s.close(),null;var[c,l]=C(),u=0;for(let t of _){let e=n.self.delete(bt.value_is(t).self);e.onerror=t=>{++u==_.length&&l()},e.onsuccess=t=>{++u==_.length&&l()}}await c;for(let t=0;t<_.length;t++)r?S.update_fts_d(n.Name,_[t],a[t]):D.update_fts_d(n.Name,_[t],i[t]);return s.close(),null}static init(){}}const W=F;var P=console.log,B=(console.warn,console.error),M=JSON.stringify,H=JSON.parse,L={_meta:{Store:3},op_hist:{Store_Name:1},"#op_hist":{},fts_words:{Store:1,Word:1,"Store,Word":3,num_obj_ids:1},fts_ids:{Store:1,Word:1,"Store,Word":1,obj_id:1,"Store,obj_id":1,"Store,Word,obj_id":3},"#fts_words":{Store:1,Word:1,"Store,Word":3,num_obj_ids:1},"#fts_ids":{Store:1,Word:1,"Store,Word":1,obj_id:1,"Store,obj_id":1,"Store,Word,obj_id":3}};class G{SUB_NAMESPACES;static crud;static op_hist;static fts;PROPERTIES;static Indices={};METHODS;static#r(t,e){return null!=localStorage.Unused_Stores&&0!=localStorage.Unused_Stores.trim().length&&-1!=t.Object_Store_Names.indexOf(e)&&H(localStorage.Unused_Stores).indexOf(e)>=0}static#t(t){if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)return!1;var e=t.Object_Store_Names,r=H(localStorage.Unused_Stores),a=[];for(let t of r)e.indexOf(t)>=0&&a.push(t);localStorage.Unused_Stores=M(a)}static#s(t,e){if("add"==t)if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)localStorage.Unused_Stores=M([e]);else{let t=H(localStorage.Unused_Stores);t=Array.from(new Set([...t,e])),localStorage.Unused_Stores=M(t)}else if("remove"==t)if(null==localStorage.Unused_Stores||0==localStorage.Unused_Stores.trim().length)localStorage.Unused_Stores=M([]);else{let t=H(localStorage.Unused_Stores),r=t.indexOf(e);r>=0&&t.splice(r,1),localStorage.Unused_Stores=M(t)}}static indexname_to_keypath(t){return t.indexOf(",")>=0?t.split(","):t}static keypath_to_indexname(t){return t.constructor===Array?t.join(","):t}static async db_exists(t){return-1!=(await a.databases()).map((t=>t.name)).indexOf(t)}static async get_cur_indices(t){if(!await $.db_exists(t))return{};var e=await a.open(t),r={},s=e.transaction(e.Object_Store_Names,bt.RO);for(let t of e.Object_Store_Names){if(G.#r(e,t))continue;let a=s.object_store(t);r[t]={};for(let e of a.Index_Names){let s=a.index(e),o=s.Key_Path;var n=G.keypath_to_indexname(o);let i,_=s.unique,c=s.multientry;0==_&&0==c?i=1:0==_&&1==c?i=2:1==_&&0==c?i=3:1==_&&1==c&&(i=4),r[t][n]=i}}return e.close(),r}static add_more_indices(t){return{...t,...L}}static indices2str(t){var e=[];for(let r in t)for(let a in t[r]){let s=t[r][a];e.push(`${r}/${a}:${s};`)}return e.sort(),e.join("")}static async get_cur_db_ver(t){var e=await a.open(t),r=e.version;return e.close(),r}static async upgrade_db(t,e,r){if(await $.db_exists(t))var s=await G.get_cur_db_ver(t)+1;else s=1;P("[EI] idbx.upgrade_db: Upgrading to version",s);var n=await a.open(t,s),o=Object.keys(e),i=Object.keys(r),_=[];for(let t of o)-1==i.indexOf(t)&&_.push(t);for(let t of _)P("[EI] idbx.upgrade_db: Found unused store:",t),G.#s("add",t);var c=[];for(let t of i)-1==o.indexOf(t)&&(G.#r(n,t)?(e[t]={},G.#s("remove",t)):c.push(t));for(let t of c){P("[EI] idbx.upgrade_db: Creating new store:",t);let e=n.create_object_store(t);for(let a in r[t]){let s=r[t][a],n=G.indexname_to_keypath(a);P("[EI] idbx.upgrade_db: Creating new index:",t,"/",a),e.create_index(a,n,s)}}var l=[],u=Array.from(new Set([...o,...i]));for(let t of u)-1==_.indexOf(t)&&-1==c.indexOf(t)&&l.push(t);var d=n.Transaction;for(let t of l){let a=d.object_store(t),s=Object.keys(e[t]),n=Object.keys(r[t]),o=[],i=[];for(let e of s)-1==n.indexOf(e)&&(P("[EI] idbx.upgrade_db: Deleting unused index:",t,"/",e),a.delete_index(e),o.push(e));for(let e of n)if(-1==s.indexOf(e)){let s=r[t][e],n=G.indexname_to_keypath(e);P("[EI] idbx.upgrade_db: Creating new index:",t,"/",e),a.create_index(e,n,s),i.push(e)}let _=[],c=Array.from(new Set([...s,...n]));for(let t of c)-1==o.indexOf(t)&&-1==i.indexOf(t)&&_.push(t);for(let s of _)if(r[t][s]!=e[t][s]){let e=r[t][s],n=G.indexname_to_keypath(s);P("[EI] idbx.upgrade_db: Updating index to new type:",t,"/",s+":"+e),a.delete_index(s),a.create_index(s,n,e)}}n.close()}static async open_av(t,e){if(null!=t){if(null!=e){e=G.add_more_indices(e);for(let t in e)e[t].id=3;G.Indices=e;var r=(await a.databases()).map((t=>t.name));bt._Db_Name=t;var s=e;if(r.indexOf(t)>=0)var n=await G.get_cur_indices(t);else n={};var o=G.indices2str(n);if(G.indices2str(s)==o)return await a.open(t);await G.upgrade_db(t,n,s);var i=await a.open(t);return G.#t(i),i}B("[EI] idbx.open_av: Indices name cannot be null")}else B("[EI] idbx.open_av: Db name cannot be null")}static async reopen(t=null){return null==t?await a.open(bt._Db_Name):await a.open(t)}static num_db_cons(){return bt._num_db_cons}static set_db(t){bt._Db_Name=t}static async get_prop(t,e){if(null!=bt._Db_Name&&0!=bt._Db_Name.trim().length)return(await a.open(bt._Db_Name)).transaction(t,bt.RW).store1()[e];B("[EI] idbx.get_prop: Call 'idb.open', 'idbx.open_av', or 'idbx.set_db' first")}static async do_op(t,e,...r){if(null!=bt._Db_Name&&0!=bt._Db_Name.trim().length){var s=(await a.open(bt._Db_Name)).transaction(t,bt.RW).store1();return await s[e](...r)}B("[EI] idbx.do_op: Call 'idb.open', 'idbx.open_av', or 'idbx.set_db' first")}static async del_obj_store(t,e){var r=await G.get_cur_db_ver(t)+1,s=await a.open(t,r);s instanceof Error?B(`[EI] idbx.del_obj_store: Failed to delete object store '${e}' in db '${t}', error:`,s):(await s.delete_object_store(e),G.#s("remove",e),s.close())}static init(){G.crud=W,G.op_hist=l,G.fts=D,G.crud.init(),G.op_hist.init(),G.fts.init()}}const $=G,q=$;console.log,console.warn;var J=console.error;const V=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get Lower(){return this.self.lower}get Lower_Open(){return this.self.lowerOpen}get Upper(){return this.self.upper}get Upper_Open(){return this.self.upperOpen}METHODS;includes(t){try{return this.self.includes(t.self)}catch(t){return J("[EI] key_range.includes: Error:",t),t}}};console.log,console.warn,console.error,console.log,console.warn;var X=console.error;const z=r.new_lock,Z=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get Key_Path(){return this.self.keyPath}get multientry(){return this.self.multiEntry}get Name(){return this.self.name}get Object_Store(){return new et(this.self.objectStore)}get unique(){return this.self.unique}METHODS;async count(t){try{if(null==t)var e=this.self.count();else e=t.constructor==V?this.self.count(t.self):this.self.count(t);var[r,a]=z();return e.onerror=t=>{a(t.target.error)},e.onsuccess=t=>{a(t.target.result)},await r}catch(t){return X("[EI] index.count: Error:",t),t}}async get(t){try{if(null==t)var e=this.self.get();else e=t.constructor==V?this.self.get(t.self):this.self.get(t);var[r,a]=z();return e.onerror=t=>{a(t.target.error)},e.onsuccess=t=>{a(t.target.result)},await r}catch(t){return X("[EI] index.get: Error:",t),t}}async get_all(t,e){try{if(null==t)var r=this.self.getAll();else r=t.constructor==V?this.self.getAll(t.self,e):this.self.getAll(t,e);var[a,s]=z();return r.onerror=t=>{s(t.target.error)},r.onsuccess=t=>{s(t.target.result)},await a}catch(t){return X("[EI] index.get_all: Error:",t),t}}async get_all_keys(t,e){try{if(null==t)var r=this.self.getAllKeys();else r=t.constructor==V?this.self.getAllKeys(t.self,e):this.self.getAllKeys(t,e);var[a,s]=z();return r.onerror=t=>{s(t.target.error)},r.onsuccess=t=>{s(t.target.result)},await a}catch(t){return X("[EI] index.get_all_keys: Error:",t),t}}async get_key(t){try{if(null==t)var e=this.self.getKey();else e=t.constructor==V?this.self.getKey(t.self):this.self.getKey(t);var[r,a]=z();return e.onerror=t=>{a(t.target.error)},e.onsuccess=t=>{a(t.target.result)},await r}catch(t){return X("[EI] index.get_key: Error:",t),t}}async open_cursor(t,e="next",r){try{if(null==t)var a=this.self.openCursor();else a=t.constructor==V?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[s,n]=z();return a.onerror=function(t){n(t.target.error)},a.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await r(e)?n():e.continue():n(null)},await s}catch(t){return X("[EI] index.open_cursor: Error:",t),t}}async open_key_cursor(t,e="next",r){try{if(null==t)var a=this.self.openCursor();else a=t.constructor==V?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[s,n]=z();return a.onerror=function(t){n(t.target.error)},a.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await r(e)?n():e.continue():n(null)},await s}catch(t){return X("[EI] index.open_key_cursor: Error:",t),t}}EXTENDED_METHODS(){}async delete(t){var e=0;return await this.open_cursor(t,"next",(t=>{t.delete(),e++})),e}};var Y=console.log,Q=(console.warn,console.error),tt=r.new_lock;const et=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get auto_increment(){return this.self.autoIncrement}get Index_Names(){return[...this.self.indexNames]}get Key_Path(){return this.self.keyPath}get Name(){return this.self.name}get Transaction(){return new at(this.self.transaction)}METHODS;async add(t){try{var e=this.self.add(t),[r,a]=tt();return e.onerror=function(t){a(t.target.error)},e.onsuccess=function(t){a(t.target.result)},await r}catch(t){return Q("[EI] object_store.add: Error:",t),t}}async clear(){try{var t=this.self.clear(),[e,r]=tt();return t.onerror=function(t){r(t.target.error)},t.onsuccess=function(t){r(t.target.result)},await e}catch(t){return Q("[EI] object_store.clear: Error:",t),t}}async count(t){try{if(null==t)var e=this.self.count();else e=t.constructor==V?this.self.count(t.self):this.self.count(t);var[r,a]=tt();return e.onerror=function(t){a(t.target.error)},e.onsuccess=function(t){a(t.target.result)},await r}catch(t){return Q("[EI] object_store.count: Error:",t),t}}create_index(t,e,r){try{if(r==bt.n1)var a={unique:!1,multiEntry:!1};else r==bt.n2?a={unique:!1,multiEntry:!0}:r==bt.u1?a={unique:!0,multiEntry:!1}:r==bt.u2&&(a={unique:!0,multiEntry:!0});return new Z(this.self.createIndex(t,e,a))}catch(t){return Q("[EI] object_store.create_index: Error:",t),t}}async delete(t){try{if(t.constructor==V)var e=this.self.delete(t.self);else e=this.self.delete(t);var[r,a]=tt();return e.onerror=function(t){a(t.target.error)},e.onsuccess=function(t){a(t.target.result)},await r}catch(t){return Q("[EI] object_store.delete: Error:",t),t}}delete_index(t){try{this.self.deleteIndex(t)}catch(t){return Q("[EI] object_store.delete_index: Error:",t),t}}async get(t){try{if(null==t)var e=this.self.get();else e=t.constructor==V?this.self.get(t.self):this.self.get(t);var[r,a]=tt();return e.onerror=function(t){a(t.target.error)},e.onsuccess=function(t){a(t.target.result)},await r}catch(t){return Q("[EI] object_store.get: Error:",t),t}}async get_all(t){try{if(null==t)var e=this.self.getAll();else e=t.constructor==V?this.self.getAll(t.self):this.self.getAll(t);var[r,a]=tt();return e.onerror=function(t){a(t.target.error)},e.onsuccess=function(t){a(t.target.result)},await r}catch(t){return Q("[EI] object_store.get_all: Error:",t),t}}async get_all_keys(t,e){try{if(null==t)var r=this.self.getAllKeys();else r=t.constructor==V?this.self.getAllKeys(t.self,e):this.self.getAllKeys(t,e);var[a,s]=tt();return r.onerror=function(t){s(t.target.error)},r.onsuccess=function(t){s(t.target.result)},await a}catch(t){return Q("[EI] object_store.get_all_keys: Error:",t),t}}async get_key(t){try{if(null==t)var e=this.self.getKey();else e=t.constructor==V?this.self.getKey(t.self):this.self.getKey(t);var[r,a]=tt();return e.onerror=function(t){a(t.target.error)},e.onsuccess=function(t){a(t.target.result)},await r}catch(t){return Q("[EI] object_store.get_key: Error:",t),t}}index(t){try{return new Z(this.self.index(t))}catch(t){return Q("[EI] object_store.index: Error:",t),t}}async open_cursor(t,e="next",r){try{if(null==t)var a=this.self.openCursor();else a=t.constructor==V?this.self.openCursor(t.self,e):this.self.openCursor(t,e);var[s,n]=tt();return a.onerror=function(t){n(t.target.error)},a.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await r(e)?n():e.continue():n(null)},await s}catch(t){return Q("[EI] object_store.open_cursor: Error:",t),t}}async open_key_cursor(t,e="next",r){try{if(null==t)var a=this.self.openKeyCursor();else a=t.constructor==V?this.self.openKeyCursor(t.self,e):this.self.openKeyCursor(t,e);var[s,n]=tt();return a.onerror=function(t){n(t.target.error)},a.onsuccess=async function(t){var e=t.target.result;null!=e?"stop"==await r(e)?n():e.continue():n(null)},await s}catch(t){return Q("[EI] object_store.open_key_cursor: Error:",t),t}}async put(t,e,r=!0,a){try{if(null==e)var s=this.self.put(t);else e.constructor==V?s=this.self.put(t,e.self):(Y(t,e),s=this.self.put(t,e));var[n,o]=tt();return s.onerror=function(t){0==r&&a(t.target.error),o(t.target.error)},s.onsuccess=function(t){0==r&&a(t.target.result),o(t.target.result)},r?await n:void 0}catch(t){return Q("[EI] object_store.put: Error:",t),t}}};console.log,console.warn;var rt=console.error;const at=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get Db(){return new nt(this.self.db)}get Durability(){return this.self.durability}get Error(){return this.self.error}get Mode(){return this.self.mode}get Object_Store_Names(){return[...this.self.objectStoreNames]}EVENTS;set on_abort(t){this.self.onabort=t}set on_complete(t){this.self.oncomplete=t}set on_error(t){this.self.onerror=t}METHODS;abort(){try{this.self.abort()}catch(t){return rt("[EI] transaction.abort: Error:",t),t}}commit(){try{this.self.commit()}catch(t){return rt("[EI] transaction.commit: Error:",t),t}}object_store(t){try{var e=this.self.objectStore(t);return new et(e)}catch(t){return rt("[EI] transaction.object_store: Error:",t),t}}ADDITIONAL_METHODS;store1(){return this.object_store([...this.self.objectStoreNames][0])}};console.log,console.warn;var st=console.error;const nt=class{self=null;constructor(t){this.self=t}SETS_AND_GETS;get Name(){return this.self.name}get Object_Store_Names(){return[...this.self.objectStoreNames]}get version(){return this.self.version}EVENTS;set on_close(t){this.self.onclose=t}set on_version_change(t){this.self.onversionchange=t}METHODS;close(){return bt._num_db_cons-=1,this.self.close()}create_object_store(t){try{return new et(this.self.createObjectStore(t,{keyPath:"id",autoIncrement:!0}))}catch(t){return st("[EI] database.create_object_store: Error:",t),t}}delete_object_store(t){try{return this.self.deleteObjectStore(t)}catch(t){return st("[EI] database.delete_object_store: Error:",t),t}}transaction(t,e,r){try{return new at(this.self.transaction(t,e,r))}catch(t){return st("[EI] database.transaction: Error:",t),t}}};var ot=console.log,it=console.warn,_t=console.error,ct=r.new_lock;console.log,console.warn,console.error;const lt=class{static keys(){return Object.keys(localStorage)}static set(t,e){try{var r=o.obj_to_json(e);localStorage[t]=r}catch(t){return null}}static get(t){try{var e=localStorage[t];return o.json_to_obj_bd(e)}catch(t){return null}}static clear(t){delete localStorage[t]}};console.log,console.warn,console.error;const ut=class{static keys(){return Object.keys(sessionStorage)}static set(t,e){try{var r=o.obj_to_json(e);sessionStorage[t]=r}catch(t){return null}}static get(t){try{var e=sessionStorage[t];return o.json_to_obj_bd(e)}catch(t){return null}}static clear(t){delete sessionStorage[t]}};var dt=console.log;console.warn,console.error;class ft{SUB_NAMESPACES;static idb;static idbx;static idbxs;static sec;static wcrypto;static utils;LITERALS;static n1=1;static n2=2;static u1=3;static u2=4;CONSTANTS;static RO="readonly";static RW="readwrite";PROPERTIES;static Factory;METHODS;static databases;static open;static delete_database;static open_av;static reopen;static num_db_cons;static set_db;static get_prop;static do_op;static del_obj_store;static insert_one;static insert_many;static exists;static count;static count_all;static find_one;static find_many;static find_all;static filter;static update_one;static update_many;static upsert_one;static remove_one;static remove_many;static set_max_history;static get_op_hist_status;static enable_op_hist;static disable_op_hist;static get_op_hist;static clear_op_hist;static enable_fts;static disable_fts;static find_many_by_terms;static s_open_av;static s_insert_one;static s_insert_many;static s_exists;static s_count;static s_count_all;static s_find_one;static s_find_many;static s_find_all;static s_filter;static s_update_one;static s_update_many;static s_upsert_one;static s_remove_one;static s_remove_many;static s_set_max_history;static s_get_op_hist_status;static s_enable_op_hist;static s_disable_op_hist;static s_get_op_hist;static s_clear_op_hist;static s_enable_fts;static s_disable_fts;static s_find_many_by_terms;METHODS(){}static init_essential_globals(t){t&&(window.n1=ft.n1),t&&(window.n2=ft.n2),t&&(window.u1=ft.u1),t&&(window.u2=ft.u2),ft._secure=!0,t&&(window._secure=!0),ft._stop="stop",t&&(window._stop="stop");const e=ft.RO;t&&(window.RO=e);const a=ft.RW;t&&(window.RW=a),ft.WITH_LEFT=!1,t&&(window.WITH_LEFT=!1),ft.WITH_RIGHT=!1,t&&(window.WITH_RIGHT=!1),ft.NO_LEFT=!0,t&&(window.NO_LEFT=!0),ft.NO_RIGHT=!0,t&&(window.NO_RIGHT=!0);const s=t=>new V(IDBKeyRange.lowerBound(t));ft.range_gte=s,t&&(window.range_gte=s);const n=t=>new V(IDBKeyRange.lowerBound(t,!0));ft.range_gt=n,t&&(window.range_gt=n);const o=t=>new V(IDBKeyRange.upperBound(t));ft.range_lte=o,t&&(window.range_lte=o);const i=t=>new V(IDBKeyRange.upperBound(t,!0));ft.range_lt=i,t&&(window.range_lt=i);const _=(t,e,r,a)=>new V(IDBKeyRange.bound(t,e,r,a));ft.range_between=_,t&&(window.range_between=_);const c=t=>new V(IDBKeyRange.only(t));ft.value_is=c,t&&(window.value_is=c);const l=r.new_lock;ft.new_lock=l,t&&(window.new_lock=l);const u=r.stay_idle;ft.stay_idle=u,t&&(window.stay_idle=u),t&&(window.eidb=ft),ft.slocal=lt,ft.ssession=ut,t&&(window.slocal=lt),t&&(window.ssession=ut)}static init_more_globals(t){ft._add="add",t&&(window._add="add");const e="clear";ft._clear=e,t&&(window._clear=e);const r="count";ft._count=r,t&&(window._count=r);const a="create_index";ft._create_index=a,t&&(window._create_index=a);const s="delete";ft._delete=s,t&&(window._delete=s);const n="delete_index";ft._delete_index=n,t&&(window._delete_index=n),ft._get="get",t&&(window._get="get");const o="get_all";ft._get_all=o,t&&(window._get_all=o);const i="get_all_keys";ft._get_all_keys=i,t&&(window._get_all_keys=i);const _="get_key";ft._get_key=_,t&&(window._get_key=_);const c="index";ft._index=c,t&&(window._index=c);const l="open_cursor";ft._open_cursor=l,t&&(window._open_cursor=l);const u="open_key_cursor";ft._open_key_cursor=u,t&&(window._open_key_cursor=u),ft._put="put",t&&(window._put="put")}static init(t=!0){ft.idb=a,ft.idbx=q,ft.idbxs=A,ft.sec=A,ft.wcrypto=b,ft.utils=o,ft.idb.init(),ft.idbx.init(),ft.idbxs.init(),ft.wcrypto.init(),ft.utils.init(),pt.init_essential_globals(t),pt.init_more_globals(t),ft.Factory=new class{self=null;constructor(t){this.self=t}async databases(){try{return await this.self.databases()}catch(t){return _t("[EI] factory.databases: Error:",t),t}}async delete_database(t){var e=this.self.deleteDatabase(t),[r,a]=ct();return e.onerror=function(t){a(t.target.error)},e.onsuccess=function(t){a(null)},await r}async open(t,e){try{var r=this.self.open(t,e)}catch(t){return _t("[EI] idb.open: Error caught:",t),t.Status="errored",t}var[a,s]=ct(),n=null,o=null,i=null;r.onerror=function(t){n=t.target.error,s("errored")},r.onblocked=function(t){it(`[EI] idb.open: Upgrade blocked, requested to change to version ${e}`),it("[EI] Check source code, shouldn't be blocked by connections in current tab or other tabs."),it("[EI] Tip: Avoid being blocked by using temporary connections in all tabs together with IDBDatabase.versionchange event."),o=t,s("blocked"),i="blocked"},r.onupgradeneeded=function(t){if(null!=i)return it(`[EI] idb.open: Upgrade cancelled due to '${i}' event fired right previously`),void s();ot(`[EI] idb.open: Upgrade needed, to version ${e}`),s("to-upgrade"),i="to-upgrade"},r.onsuccess=function(t){if(null!=i)return it(`[EI] idb.open: Open cancelled due to '${i}' event fired right previously`),void s();s("opened")};var _=await a;if("errored"==_)return n.Status="errored",n;if("blocked"==_){let t=new Error("Upgrade is blocked by other connections, close them all first.");return t.Status="blocked",t.Event=o,t}if("to-upgrade"==_){let t=new nt(r.result);return t.to_upgrade=!0,t.Transaction=new at(r.transaction),null==bt._num_db_cons?bt._num_db_cons=1:bt._num_db_cons+=1,t}if("opened"==_){let t=new nt(r.result);return t.to_upgrade=!1,null==bt._num_db_cons?bt._num_db_cons=1:bt._num_db_cons+=1,t}}}(window.indexedDB),ft.databases=a.databases,ft.open=a.open,ft.delete_database=a.delete_database,ft.open_av=q.open_av,ft.reopen=q.reopen,ft.num_db_cons=q.num_db_cons,ft.set_db=q.set_db,ft.get_prop=q.get_prop,ft.do_op=q.do_op,ft.del_obj_store=q.del_obj_store,ft.insert_one=q.crud.insert_one,ft.insert_many=q.crud.insert_many,ft.exists=q.crud.exists,ft.count=q.crud.count,ft.count_all=q.crud.count_all,ft.find_one=q.crud.find_one,ft.find_many=q.crud.find_many,ft.find_all=q.crud.find_all,ft.filter=q.crud.filter,ft.update_one=q.crud.update_one,ft.update_many=q.crud.update_many,ft.upsert_one=q.crud.upsert_one,ft.remove_one=q.crud.remove_one,ft.remove_many=q.crud.remove_many,ft.set_max_history=q.op_hist.set_max_history,ft.get_op_hist_status=q.op_hist.get_op_hist_status,ft.enable_op_hist=q.op_hist.enable_op_hist,ft.disable_op_hist=q.op_hist.disable_op_hist,ft.get_op_hist=q.op_hist.get_op_hist,ft.clear_op_hist=q.op_hist.clear_op_hist,ft.enable_fts=q.fts.enable_fts,ft.disable_fts=q.fts.disable_fts,ft.find_many_by_terms=q.fts.find_many_by_terms,ft.s_open_av=A.open_av,ft.s_insert_one=A.cruds.insert_one,ft.s_insert_many=A.cruds.insert_many,ft.s_exists=A.cruds.exists,ft.s_count=A.cruds.count,ft.s_count_all=A.cruds.count_all,ft.s_find_one=A.cruds.find_one,ft.s_find_many=A.cruds.find_many,ft.s_find_all=A.cruds.find_all,ft.s_filter=A.cruds.filter,ft.s_update_one=A.cruds.update_one,ft.s_update_many=A.cruds.update_many,ft.s_upsert_one=A.cruds.upsert_one,ft.s_remove_one=A.cruds.remove_one,ft.s_remove_many=A.cruds.remove_many,ft.s_set_max_history=A.op_hists.set_max_history,ft.s_get_op_hist_status=A.op_hists.get_op_hist_status,ft.s_enable_op_hist=A.op_hists.enable_op_hist,ft.s_disable_op_hist=A.op_hists.disable_op_hist,ft.s_get_op_hist=A.op_hists.get_op_hist,ft.s_clear_op_hist=A.op_hists.clear_op_hist,ft.s_enable_fts=A.ftss.enable_fts,ft.s_disable_fts=A.ftss.disable_fts,ft.s_find_many_by_terms=A.ftss.find_many_by_terms}}var yt=window.location;dt("[EI] EnIndex loaded in",`${yt.protocol}//${yt.host}${yt.pathname}`),dt("     by this import:",import.meta.url.replace("http:","").replace("https:",""));const pt=ft,bt=pt;var wt=e.Z;export{wt as default};