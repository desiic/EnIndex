import eidb from"../../eidb.js";import idbx from"../idbx.js";import idbxs from"../idbxs.js";import wcrypto from"../wcrypto.js";import utils from"../utils.js";const log=console.log,logw=console.warn,loge=console.error;class fts{static enabled=!1;static score_rate=2;static enable_fts(){fts.enabled=!0}static disable_fts(){fts.enabled=!1}static str_to_unique_words(e){var t=(e=(e=(e=e.toLowerCase()).replace(/[^0-9A-Za-z_\-]/g," ")).replace(/[\s]{2,}/g," ").trim()).split(" ");return Array.from(new Set(t))}static obj_to_unique_words(e){var t=utils.obj_to_valuestr(e);return fts.str_to_unique_words(t)}static async obj_exists(e,t,s){var r=e.index(t);return null!=await r.get_key(eidb.value_is(s))}static async increase_num_objs(e,t,s){var r=await e.index("Store,Word").get(eidb.value_is([t,s]));r.num_obj_ids++,await e.put(r)}static async decrease_num_objs(e,t,s){var r=await e.index("Store,Word").get(eidb.value_is([t,s]));r.num_obj_ids>0&&r.num_obj_ids--,r.num_obj_ids>0?await e.put(r):await e.delete(eidb.value_is(r.id))}static async update_fts(e,t,s,r,a=!1){if(-1!=["create","update","delete"].indexOf(e)){if(a)var i="#fts_words",o="#fts_ids";else i="fts_words",o="fts_ids";var _=fts.obj_to_unique_words(r);if(a)for(let e=0;e<_.length;e++){let t=(await wcrypto.encrypt_aes_fiv(_[e],idbxs.Skey))[0];_[e]=t}var d=await idbx.reopen(),l=d.transaction([i,o],eidb.RW),n=l.object_store(i),f=l.object_store(o);for(let r of _){if(await fts.obj_exists(n,"Store,Word",[t,r])||await n.add({Store:t,Word:r,num_obj_ids:0}),"create"==e)await f.add({Store:t,Word:r,obj_id:s}),await fts.increase_num_objs(n,t,r);else if("update"==e){await fts.obj_exists(f,"Store,Word,obj_id",[t,r,s])||(await f.add({Store:t,Word:r,obj_id:s}),await fts.increase_num_objs(n,t,r))}else await f.index("Store,Word,obj_id").delete(eidb.value_is([t,r,s])),await fts.decrease_num_objs(n,t,r)}var u=await f.index("Store,obj_id").get_all(eidb.value_is([t,s])),c=(u=u.map((e=>e.Word))).filter((e=>-1==_.indexOf(e)));for(let e of c)await f.index("Store,Word,obj_id").delete(eidb.value_is([t,e,s])),await fts.decrease_num_objs(n,t,e);d.close()}else loge("[EI] fts.update_fts: Bad operation:",e)}static update_fts_c(e,t,s,r=!1){fts.enabled&&fts.update_fts("create",e,t,s,r)}static update_fts_r(e,t,s,r=!1){}static update_fts_u(e,t,s,r=!1){fts.enabled&&fts.update_fts("update",e,t,s,r)}static update_fts_d(e,t,s,r=!1){fts.enabled&&fts.update_fts("delete",e,t,s,r)}static async#e(e,t,s,r){var a=t.Name,i=[];await e.index("Store,Word").open_cursor(eidb.value_is([a,s]),"next",(e=>{if(i.push(e.value.obj_id),i.length>=r)return eidb._stop}));var o=[];for(let e of i){let s=await t.get(eidb.value_is(e));null!=s?o.push(s):logw("[EI] fts.#term_to_objs: Found bad id:",e)}return o}static#t(e,t){var s=[],r={},a=1;for(let e=t.length-1;e>=0;e--)r[t[e]]=a,a<Number.MAX_SAFE_INTEGER/fts.score_rate&&(a*=fts.score_rate);for(let a of e){let e={Object:a,score:0},i=utils.obj_to_valuestr(a).toLowerCase(),o=0;for(let e of t){let t=utils.escape_for_regex(e);o+=r[e]*(i.match(new RegExp(t,"g"))||[]).length}e.score=o,s.push(e)}return s.sort(((e,t)=>t.score-e.score))}static async find_many_by_terms(e,t,s=1e3,r=!1){if(0==fts.enabled&&logw("[EI] fts.find_many_by_terms: FTS is disabled, there might be results but no changes."),r)var a="#fts_words",i="#fts_ids";else a="fts_words",i="fts_ids";var o=fts.str_to_unique_words(t);if(r)for(let e=0;e<o.length;e++)o[e]=(await wcrypto.encrypt_aes_fiv(o[e],idbxs.Skey))[0];var _=await eidb.reopen(),d=_.transaction([a,i,e],eidb.RO),l=d.object_store(a),n=d.object_store(i),f=d.object_store(e),u=[],c=[];for(let t of o){let s=await l.index("Store,Word").get(eidb.value_is([e,t]));if(null==s){u.push(t);continue}let r={Term:t,exists:!0,size:s.num_obj_ids};c.push(r)}var b="More specific terms are listed first in Search_Terms; higher score items are listed first.";if(0==c.length)return{Items:[],Search_Terms:[],Excluded_Terms:u,Note:b};if(1==c.length){let e=c[0].Term,t=await fts.#e(n,f,e,s);return{Items:fts.#t(t,[e]),Search_Terms:[e],Excluded_Terms:u,Note:b}}var m=(c=c.sort(((e,t)=>e.size-t.size))).map((e=>e.Term)),w=c[0].Term,p=c.slice(1).map((e=>e.Term)),j=[];await n.index("Store,Word").open_cursor(eidb.value_is([e,w]),"next",(async t=>{var s=t.value.obj_id,r=!0;for(let t of p)if(0==await n.index("Store,Word,obj_id").count(eidb.value_is([e,t,s]))){r=!1;break}r&&j.push(s)}));var v=[];for(let e of j){let t=await f.get(eidb.value_is(e));null!=t?v.push(t):logw("[EI] fts.find_many_by_terms: Found bad id:",e)}var x=fts.#t(v,m);return _.close(),{Items:x,Search_Terms:m,Excluded_Terms:u,Note:b}}static init(){}}export default fts;