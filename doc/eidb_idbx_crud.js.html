<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><script src="jsdoc-custom.js"></script><link type="text/css" rel="stylesheet" href="jsdoc-custom.css"><title>eidb/idbx/crud.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="",baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body class="light" data-theme="light"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">Home</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="nvTleyJhZMnfnousquNry"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-eidb.html">eidb</a></div><div class="sidebar-section-children"><a href="module-eidb_base.html">eidb/base</a></div><div class="sidebar-section-children"><a href="module-eidb_idb.html">eidb/idb</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_cursor.html">eidb/idb/cursor</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_cursor_with_value.html">eidb/idb/cursor_with_value</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_database.html">eidb/idb/database</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_factory.html">eidb/idb/factory</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_index.html">eidb/idb/index</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_key_range.html">eidb/idb/key_range</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_object_store.html">eidb/idb/object_store</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_open_db_request.html">eidb/idb/open_db_request</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_request.html">eidb/idb/request</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_transaction.html">eidb/idb/transaction</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_version_change_event.html">eidb/idb/version_change_event</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx.html">eidb/idbx</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx_crud.html">eidb/idbx/crud</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx_fts.html">eidb/idbx/fts</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx_miscs.html">eidb/idbx/miscs</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx_op_hist.html">eidb/idbx/op_hist</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs.html">eidb/idbxs</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_blind_index.html">eidb/idbxs/blind_index</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_cruds.html">eidb/idbxs/cruds</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_dobi.html">eidb/idbxs/dobi</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_ftss.html">eidb/idbxs/ftss</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_op_hists.html">eidb/idbxs/op_hists</a></div><div class="sidebar-section-children"><a href="module-eidb_utils.html">eidb/utils</a></div><div class="sidebar-section-children"><a href="module-eidb_wcrypto.html">eidb/wcrypto</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="" href="index.html" target="_self">Doc Home</a></div><div class="navbar-item"><a id="" href="https://github.com/desiic/enindex" target="_blank">Project Website</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">eidb_idbx_crud.js</h1></header><article><pre class="prettyprint source lang-js"><code>/**
 * @module eidb/idbx/crud
 */

// Modules
import base    from "../base.js";
import utils   from "../utils.js";
import op_hist from "./op-hist.js";
import fts     from "./fts.js";

// Shorthands
var log      = console.log;
var logw     = console.warn;
var loge     = console.error;
var new_lock = base.new_lock;
var json2obj = JSON.parse;
var obj2json = JSON.stringify;

/**
 * CRUD op class&lt;br/>
 * NOTE: ONLY insert_one, find_one, update_one, upsert_one, remove_one WILL 
 *       AFFECT THE OP HISTORY.&lt;br/>
 * NOTE: ONLY OPERATIONS THOSE CHANGE DATA AFFECT FTS, ie. insert, update, upsert, remove.
 */
class crud {

    /**
     * Insert one
     * @return {Number} Id of the new obj
     */
    static async insert_one(Store_Name,Obj){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RW);
        var Store = T.store1();

        // Got store, next
        var Obj_ = {...Obj}; // Clone to delete id
        delete Obj_.id;      // Id is auto-incremented

        // Insert
        var new_id = await Store.add(Obj_);

        if (new_id instanceof Error){
            loge("crud.insert_one: Failed, error:",new_id);
            Db.close();
            return null;
        }

        op_hist.update_op_hist_c(Store.Name, [new_id]);
        fts.update_fts_c(Store.Name, new_id, Obj);
        Db.close();
        return new_id;
    }

    /**
     * Insert many
     * @return {Array} List of inserted object ids
     */
    static async insert_many(Store_Name,Objs){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RW);
        var Store = T.store1();

        // Got store, next
        var Ids           = [];
        var [Lock,unlock] = new_lock();
        if (Objs==null || Objs.length==0) { Db.close(); return []; }
        
        // Add all objects till all added
        for (let Obj of Objs){
            let Obj_ = {...Obj}; // Clone to delete id
            delete Obj_.id;      // Id is auto-incremented
            let Req = Store.self.add(Obj_); // MUST BE 'let' HERE, EACH Req IS DIFFERENT.

            Req.onerror = (Ev)=>{
                loge("crud.insert_many: Failed to add object, error:",Ev.target.error);
                Ids.push(null);
                if (Ids.length == Objs.length) unlock();
            };
            Req.onsuccess = (Ev)=>{
                Ids.push(Ev.target.result);
                if (Ids.length == Objs.length) unlock();
            };            
        }
        await Lock;

        for (let i=0; i&lt;Ids.length; i++)
            fts.update_fts_c(Store.Name, Ids[i], Objs[i]);

        Db.close();        
        return Ids;
    }

    /**
     * Get object by 1 condition only
     */
    static async get_1stcond_obj(Store,Cond){ // Cond can't be empty {}
        var Keys  = Object.keys(Cond);
        var Index = Store.index(Keys[0]);

        if (Index instanceof Error){
            loge("crud.get_1stcond_obj: Failed to get index, "+
                 "add this index to schema:",Store.Name,"/",Keys[0]);
            return null;
        }

        var Range = value_is(Cond[Keys[0]]);
        return await Index.get(Range);
    }

    /**
     * Get objects by 1 condition only
     */
    static async get_1stcond_objs(Store,Cond){ // Cond can't be empty {}
        var Keys  = Object.keys(Cond);
        var Index = Store.index(Keys[0]);

        if (Index instanceof Error){
            loge("crud.get_1stcond_obj: Failed to get index, "+
                 "add this index to schema:",Store.Name,"/",Keys[0]);
            return null;
        }

        var Range = value_is(Cond[Keys[0]]);
        return await Index.get_all(Range);
    }

    /**
     * Intersect conditions (key values) to get ids, eg. Cond {foo:"a", bar:"b"},
     * key foo gives multiple items of value 'a', key bar gives multiple items
     * of value 'b', intersect these 2 for id list.
     */ 
    static async intersect_cond(Store,Cond){
        var Keys = Object.keys(Cond);
        if (Keys.length==0) return [];

        // Multiple conditions, intersect       
        var Id_Arrays = [];

        for (let Key of Keys){
            let Index = Store.index(Key);

            if (Index instanceof Error){
                loge("crud.get_1stcond_obj: Failed to get index, "+
                     "add this index to schema:",Store.Name,"/",Key);
                return null;
            }

            let Range = value_is(Cond[Key]);
            let Objs  = await Index.get_all(Range);
            let Ids   = Objs.map(Obj=>Obj.id);
            Id_Arrays.push(Ids);
        }
        
        return utils.intersect_arrs(Id_Arrays);
    }

    /**
     * Intersect conditions (key values) to get ids, eg. Cond {foo:"a", bar:"b"},
     * key foo gives multiple items of value 'a', key bar gives multiple items
     * of value 'b', intersect these 2 for object list.
     */ 
     static async intersect_cond_getobjs(Store,Cond){
        var Keys = Object.keys(Cond);
        if (Keys.length==0) return [];

        // Multiple conditions, intersect       
        var Id_Arrays = [];
        var Id2Objs   = {};

        for (let Key of Keys){
            let Index = Store.index(Key);

            if (Index instanceof Error){
                loge("crud.get_1stcond_obj: Failed to get index, "+
                     "add this index to schema:",Store.Name,"/",Key);
                return null;
            }

            let Range = value_is(Cond[Key]);
            let Objs  = await Index.get_all(Range);

            let Ids = Objs.map(Obj=>{
                Id2Objs[Obj.id] = Obj;
                return Obj.id;
            });

            Id_Arrays.push(Ids);
        }
        
        var Id_Intersection = utils.intersect_arrs(Id_Arrays);
        return Id_Intersection.map(id => Id2Objs[id]);
    }

    /**
     * Check existence of obj&lt;br/>
     * Avoid multiple conds in Cond, use compound index.&lt;br/>
     * Note: Read but no fetching data, no op history
     * @return {Boolean}
     */
    static async exists(Store_Name,Cond){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RO);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return []; }

        // Single cond
        if (Keys.length==1){
            let Obj = await crud.get_1stcond_obj(Store,Cond);
            Db.close();
            return Obj!=null;
        }

        // Multiple conds
        var Ids = await crud.intersect_cond(Store,Cond);
        Db.close();
        return Ids.length>0;
    }

    /**
     * Count&lt;br/>
     * Avoid multiple conds in Cond, use compound index&lt;br/>
     * Note: Read but no fetching data, no op history
     * @return {Number}
     */
    static async count(Store_Name,Cond){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RO);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return null; }

        // Single cond
        if (Keys.length==1){
            let Objs = await crud.get_1stcond_objs(Store,Cond);
            Db.close();
            return Objs.length;
        }

        // Multiple conds
        var Ids = await crud.intersect_cond(Store,Cond);
        Db.close();
        return Ids.length;
    }

    /**
     * Count all&lt;br/>
     * Note: Read but no fetching data, no op history
     * @return {Number}
     */
    static async count_all(Store_Name){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RO);
        var Store = T.store1();

        // Got store, next
        var count = await Store.count();
        Db.close();
        return count;
    }

    /**
     * Find one, avoid using multiple conditions in Cond coz it's slow
     * @return {Object}
     */
    static async find_one(Store_Name,Cond){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RO);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return null; }

        // Single cond
        if (Keys.length==1){
            let Obj = await crud.get_1stcond_obj(Store,Cond);

            // Update op history and return
            op_hist.update_op_hist_r(Store.Name, [Obj.id]);
            Db.close();
            return Obj;
        }

        // Multiple conds
        var Ids = await crud.intersect_cond(Store,Cond);
        if (Ids.length==0) { Db.close(); return null; }

        // Update op history &amp; return        
        var Obj = await Store.get(value_is(Ids[0]));
        op_hist.update_op_hist_r(Store.Name, Ids);
        Db.close();
        return Obj;
    }

    /**
     * Find many, avoid using multiple conditions in Cond coz it's slow,
     * USE COMPOUND INDEX INSTEAD.
     * @return {Object}
     */
    static async find_many(Store_Name,Cond, limit=Number.MAX_SAFE_INTEGER){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RO);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return null; }

        // Single cond
        if (Keys.length==1){
            let Objs = await crud.get_1stcond_objs(Store,Cond);
            Db.close();
            return Objs;
        }

        // Multiple conds
        var Ids = await crud.intersect_cond(Store,Cond);
        if (Ids==null || Ids.length==0) { Db.close(); return []; }

        var Objs          = [];
        var [Lock,unlock] = new_lock();

        for (let id of Ids){
            let Req = Store.self.get(value_is(id).self)

            Req.onerror = (Ev)=>{
                Objs.push(null);
                if (Objs.length == Ids.length) unlock();
                if (Objs.length >= limit)      unlock();
            };
            Req.onsuccess = (Ev)=>{
                Objs.push(Ev.target.result);
                if (Objs.length == Ids.length) unlock();
                if (Objs.length >= limit)      unlock();
            };
        }        

        await Lock;
        Db.close();
        return Objs;
    }

    /**
     * Find all
     * @return {Array}
     */
    static async find_all(Store_Name){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RO);
        var Store = T.store1();

        // Got store, next
        var Objs = await Store.get_all();
        Db.close();
        return Objs;
    }

    /**
     * Get value at prop path
     */ 
    static get_proppath_value(Obj,Path){
        var Tokens = Path.split(".");
        var Value  = Obj;

        for (let Token of Tokens)
            if (Value[Token] != null)
                Value = Value[Token];     
            else 
                return null;

        return Value;
    }

    /**
     * Check if object matches condition
     */ 
    static obj_matches_cond(Obj,Cond){
        for (let Key in Cond){
            let Value     = Cond[Key];
            let Obj_Value = crud.get_proppath_value(Obj,Key);

            if (Obj_Value==null)
                return false;
            if (obj2json(Obj_Value).indexOf(Value) == -1)
                return false;
        }

        return true;
    }

    /**
     * Filter (value contain, for exact match: use find, find_many)
     */ 
    static async filter(Store_Name,Cond, limit=Number.MAX_SAFE_INTEGER){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RO);
        var Store = T.store1();

        // Got store, next
        var Objs = [];

        await Store.open_cursor(range_gte(0),"next",Cursor=>{
            var Value = Cursor.value;

            if (crud.obj_matches_cond(Value,Cond))
                Objs.push(Value);
            if (Objs.length >= limit)
                return _stop;
        });

        Db.close();
        return Objs;
    }

    /**
     * Update one, avoid using multiple conditions in Cond coz it's slow,
     * USE COMPOUND INDEX INSTEAD.
     * @return {Object}
     */
    static async update_one(Store_Name,Cond,Changes){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RW);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return null; }

        let Changes_ = {...Changes}; // Clone to delete id
        delete Changes_.id;          // Id is auto-incremented

        // Single cond
        if (Keys.length==1){
            let Obj = await crud.get_1stcond_obj(Store,Cond);
            if (Obj==null) { Db.close(); return null; }

            Obj = {...Obj,...Changes_};
            Store.put(Obj);
            op_hist.update_op_hist_u(Store.Name, [Obj.id]);
            fts.update_fts_u(Store.Name, Obj.id, Obj);
            Db.close();
            return Obj;
        }

        // Multiple conds
        var Ids = await crud.intersect_cond(Store,Cond);
        if (Ids==null || Ids.length==0) { Db.close(); return null; }

        var Obj = await Store.get(value_is(Ids[0]));
        if (Obj==null) { Db.close(); return null; }

        Obj = {...Obj,...Changes_};
        Store.put(Obj);
        op_hist.update_op_hist_u(Store.Name, [Obj.id]);
        fts.update_fts_u(Store.Name, Obj.id, Obj);
        Db.close();
        return Obj;
    }

    /**
     * Update many, avoid using multiple conditions in Cond coz it's slow,
     * USE COMPOUND INDEX INSTEAD.
     * @return {Object}
     */
    static async update_many(Store_Name,Cond,Changes, limit=Number.MAX_SAFE_INTEGER){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RW);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return null; }

        let Changes_ = {...Changes}; // Clone to delete id
        delete Changes_.id;          // Id is auto-incremented

        // Single cond
        if (Keys.length==1){
            var Objs = await crud.get_1stcond_objs(Store,Cond);
            if (Objs==null)     { Db.close(); return null; }
            if (Objs.length==0) { Db.close(); return []; }
        }
        // Multiple conds
        else{        
            var Objs = await crud.intersect_cond_getobjs(Store,Cond);
            if (Objs==null)     { Db.close(); return null; }
            if (Objs.length==0) { Db.close(); return []; }
        }

        // Update
        let Updated_Objs  = [];
        let [Lock,unlock] = new_lock();

        for (let Obj of Objs){
            let Replacement = {...Obj,...Changes_};
            let Req         = Store.self.put(Replacement);
            
            Req.onerror = (Ev)=>{
                loge("crud.update_many: Failed to update object:",Obj);
                Updated_Objs.push(null);
                if (Updated_Objs.length == Objs.length) unlock();
                if (Updated_Objs.length >= limit)       unlock();
            };
            Req.onsuccess = (Ev)=>{
                Updated_Objs.push(Replacement);
                if (Updated_Objs.length == Objs.length) unlock();
                if (Updated_Objs.length >= limit)       unlock();
            }
        }
        await Lock;

        for (let i=0; i&lt;Updated_Objs.length; i++)
            fts.update_fts_u(Store.Name, Updated_Objs[i].id, Updated_Objs[i]);

        Db.close();        
        return Updated_Objs;
    }

    /**
     * Upsert one, avoid using multiple conditions in Cond coz it's slow,
     * USE COMPOUND INDEX INSTEAD
     * @return {Object}
     */
    static async upsert_one(Store_Name,Cond,Changes){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RW);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return null; }

        let Changes_ = {...Changes}; // Clone to delete id
        delete Changes_.id;          // Id is auto-incremented

        // Single cond
        if (Keys.length==1){
            let Obj = await crud.get_1stcond_obj(Store,Cond);

            // Insert
            if (Obj==null){
                let id = await Store.add(Changes_);
                op_hist.update_op_hist_c(Store.Name, [id]);
                fts.update_fts_c(Store.Name, id, Changes);
                Db.close();
                return id;
            };

            // Update
            Obj = {...Obj,...Changes_};
            Store.put(Obj);
            op_hist.update_op_hist_u(Store.Name, [Obj.id]);
            fts.update_fts_u(Store.Name, Obj.id, Obj);
            Db.close();
            return Obj.id;
        }

        // Multiple conds
        var Ids = await crud.intersect_cond(Store,Cond);
        if (Ids==null || Ids.length==0) { Db.close(); return null; }

        // Insert
        var Obj = await Store.get(value_is(Ids[0]));

        if (Obj==null){
            let id = await Store.add(Changes_);
            op_hist.update_op_hist_c(Store.Name, [id]);
            fts.update_fts_c(Store.Name, id, Changes);
            Db.close();
            return id;
        };

        // Update
        Obj = {...Obj,...Changes_};
        Store.put(Obj);
        op_hist.update_op_hist_u(Store.Name, [Obj.id]);
        fts.update_fts_u(Store.Name, Obj.id, Obj);
        Db.close();
        return Obj.id;
    }

    /**
     * Remove one, avoid using multiple conditions in Cond coz it's slow,
     * USE COMPOUND INDEX INSTEAD
     * @return {null}
     */
    static async remove_one(Store_Name,Cond){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RW);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return null; }

        // Single cond
        if (Keys.length==1){
            let Obj = await crud.get_1stcond_obj(Store,Cond);
            if (Obj==null) { Db.close(); return null; }
            
            let id = await Store.delete(value_is(Obj.id));
            op_hist.update_op_hist_d(Store.Name, [Obj.id]);
            fts.update_fts_d(Store.Name, Obj.id, Obj);
            Db.close();
            return id; // Always null, from IDBObjectStore.delete
        }

        // Multiple conds
        var Objs = await crud.intersect_cond_getobjs(Store,Cond);
        var Ids  = Objs.map(X=>X.id);
        if (Ids==null || Ids.length==0) { Db.close(); return null; }
        
        var id = await Store.delete(value_is(Ids[0]));
        op_hist.update_op_hist_d(Store.Name, [Ids[0]]);
        fts.update_fts_d(Store.Name, Ids[0], Objs[0]);
        Db.close();
        return id; // Always null, from IDBObjectStore.delete
    }

    /**
     * Remove many, avoid using multiple conditions in Cond coz it's slow,
     * USE COMPOUND INDEX INSTEAD
     * @return {null}
     */
    static async remove_many(Store_Name,Cond){
        var Db    = await eidb.reopen();
        var T     = Db.transaction(Store_Name,RW);
        var Store = T.store1();

        // Got store, next
        var Keys = Object.keys(Cond);
        if (Keys.length==0) { Db.close(); return null; }

        // Single cond
        var Objs = [];
        var Ids  = [];

        if (Keys.length==1){
            Objs = await crud.get_1stcond_objs(Store,Cond);            
            Ids = Objs.map(Obj=>Obj.id);
            if (Objs==null || Objs.length==0) { Db.close(); return null; }            
        }
        else{
            // Multiple conds
            Objs = await crud.intersect_cond_getobjs(Store,Cond);
            Ids  = Objs.map(X=>X.id);
            if (Ids==null || Ids.length==0) { Db.close(); return null; }
        }

        var [Lock,unlock] = new_lock();
        var count         = 0;

        for (let id of Ids){
            let Req = Store.self.delete(value_is(id).self);

            Req.onerror = (Ev)=>{
                count++;
                if (count == Ids.length) unlock();
            };
            Req.onsuccess = (Ev)=>{
                count++;
                if (count == Ids.length) unlock();
            };
        }        
        await Lock;

        for (let i=0; i&lt;Ids.length; i++)
            fts.update_fts_d(Store.Name, Ids[i], Objs[i]);

        Db.close();
        return null;
    }
}

export default crud;
// EOF</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">Home</a><div class="mobile-nav-links"><div class="navbar-item"><a id="" href="index.html" target="_self">Doc Home</a></div><div class="navbar-item"><a id="" href="https://github.com/desiic/enindex" target="_blank">Project Website</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="nvTleyJhZMnfnousquNry"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-eidb.html">eidb</a></div><div class="sidebar-section-children"><a href="module-eidb_base.html">eidb/base</a></div><div class="sidebar-section-children"><a href="module-eidb_idb.html">eidb/idb</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_cursor.html">eidb/idb/cursor</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_cursor_with_value.html">eidb/idb/cursor_with_value</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_database.html">eidb/idb/database</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_factory.html">eidb/idb/factory</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_index.html">eidb/idb/index</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_key_range.html">eidb/idb/key_range</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_object_store.html">eidb/idb/object_store</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_open_db_request.html">eidb/idb/open_db_request</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_request.html">eidb/idb/request</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_transaction.html">eidb/idb/transaction</a></div><div class="sidebar-section-children"><a href="module-eidb_idb_version_change_event.html">eidb/idb/version_change_event</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx.html">eidb/idbx</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx_crud.html">eidb/idbx/crud</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx_fts.html">eidb/idbx/fts</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx_miscs.html">eidb/idbx/miscs</a></div><div class="sidebar-section-children"><a href="module-eidb_idbx_op_hist.html">eidb/idbx/op_hist</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs.html">eidb/idbxs</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_blind_index.html">eidb/idbxs/blind_index</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_cruds.html">eidb/idbxs/cruds</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_dobi.html">eidb/idbxs/dobi</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_ftss.html">eidb/idbxs/ftss</a></div><div class="sidebar-section-children"><a href="module-eidb_idbxs_op_hists.html">eidb/idbxs/op_hists</a></div><div class="sidebar-section-children"><a href="module-eidb_utils.html">eidb/utils</a></div><div class="sidebar-section-children"><a href="module-eidb_wcrypto.html">eidb/wcrypto</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>