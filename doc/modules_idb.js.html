<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>modules/idb.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="eidb.html">eidb</a></li><li><a href="idb.html">idb</a><ul class='methods'><li data-type='method'><a href="idb.html#.open">open</a></li></ul></li><li><a href="idb_factory.html">idb_factory</a></li></ul><h3>Global</h3><ul><li><a href="global.html#new_lock">new_lock</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/idb.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Modules
import base        from "./base.js";
import idb_factory from "./idb/idb-factory.js";

// Shorthands
var log      = console.log;
var logw     = console.warn;
var loge     = console.error;
var new_lock = base.new_lock;

/** 
 * eidb.idb, IndexedDB wrapper
 */
class idb{
    static idb_factory = idb_factory;

    /** 
     * Open db
     */
    static async open(Name, version){
        try {
            var Req = window.indexedDB.open(Name,version);
        }
        catch (Err){
            loge("idb.open: Error caught:",Err);
            return null;
        }

        // Lock to wait for callback
        var [Lock,Unlock] = new_lock();

        // Operation sequences may happen:
        //   - error
        //   - blocked -(wait for closing all connections)-> upgrade -> success
        //   - upgrade -> success
        var Sequence_Cancel_Reason = null;

        Req.onerror = function(Ev){
            loge("idb.open: Failed with error:",Ev.target.error);
            Unlock("error"); // Nothing next but just clear the lock, no sequence to cancel
        };        
        Req.onblocked = function(Ev){
            logw(`idb.open: Upgrade blocked, requested to change to version ${version}`);
            logw("Check source code, shouldn't be blocked by connections in current tab or other tabs.");
            logw("Tip: Avoid being blocked by using temporary connections in all tabs\x20"+
                 "together with IDBDatabase.versionchange event.");
            Unlock("blocked");
            Sequence_Cancel_Reason = "block";
        };
        Req.onupgradeneeded = function(Ev){
            if (Sequence_Cancel_Reason != null){
                logw(`idb.open: Upgrade cancelled due to '${Sequence_Cancel_Reason}' event fired right previously`);
                Unlock(); // Redundant, no longer awaited
                return;
            }

            log(`idb.open: Upgrade needed, to version ${version}`);
            Unlock("upgrade");
            Sequence_Cancel_Reason = "upgrade";
        };
        Req.onsuccess = function(Ev){
            if (Sequence_Cancel_Reason != null){
                logw(`idb.open: Open cancelled due to '${Sequence_Cancel_Reason}' event fired right previously`);
                Unlock(); // Redundant, no longer awaited
                return;
            }

            log(`idb.open: Database opened successfully`);
            Unlock("success");
        };
        var Result = await Lock;

        if (Result=="error")   
            return [Result, null]; // Error, no .result        
        if (Result=="blocked") 
            return [Result, null]; // The request has not finished, no .result yet,
                                   // waiting for other connections to close.
        // This returns either db from upgrade or success event,
        // upgrade+close+reopen if it is upgrading case.
        if (Result=="upgrade" || Result=="success") 
            return [Result, Req.result]; // .result is IDBDatabase object
    }
}

// Module export
export default idb;
// EOF</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Wed Oct 26 2022 11:05:22 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
